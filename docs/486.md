# Istio 支持蓝绿色/淡黄色展开-线束 CD |线束

> 原文：<https://www.harness.io/blog/istio-support-for-blue-green-and-canary>

这里有一个针对蓝绿色/金丝雀部署的 Istio 的快速概要，以及 Harness 如何支持这项新技术。

“只要把你的应用程序放在一个容器里，然后部署它——它超级简单、快速、可扩展、可移植，”两年前人人都这么说。

事实证明，在容器中部署微服务并不像我们最初想象的那么容易。

“没问题，用 Kubernetes 来管理你的容器就行了”，一年前人人都这么说。

事实证明，管理 Kubernetes 并不容易，除非你对 YAML 情有独钟。

今天最新的流行语热门技术是 Istio。

## Istio 是什么？

Istio 是一个开源的服务网格。

## 什么是服务网格？

可以把它想象成你所有微服务(和基础设施)的管理包装器，这样你就可以控制它们的连接性和安全性。

想象一下，在你所有的 Kubernetes 集群中，有一个保镖/门卫在看着你的每个豆荚的门。这就是 Istio 特使/代理人的基本含义。

Istio 还声称做可观察性(监控、日志、跟踪)，但话说回来，现在其他人也这么做了:)

## Istio 用例

在 [Istio 网站](https://istio.io/docs/concepts/what-is-istio/)上，核心功能被定义为:

*   HTTP、gRPC、WebSocket 和 TCP 流量的自动负载平衡。
*   通过丰富的路由规则、重试、故障转移和故障注入对流量行为进行细粒度控制。
*   支持访问控制、速率限制和配额的可插拔策略层和配置 API。
*   自动度量、记录和跟踪集群内的所有流量，包括集群入口和出口。
*   通过基于身份的强身份验证和授权，确保群集中服务到服务的安全通信。

Istio 是为可扩展性而设计的，更具体地说，是为了支持广泛的微服务部署模式。因此，Harness 决定支持 Istio 并使其成为我们平台中的一等公民也就不足为奇了。

简而言之，Istio 使得基于 Kubernetes 的应用程序的蓝绿色和淡黄色部署变得更加简单。

## 示例:Istio 蓝绿色金丝雀部署

让我们构建一个简单的蓝绿色部署，使用金丝雀阶段来控制应用程序流量如何使用 Harness、亚马逊 EKS 和 Istio 从绿色环境(当前版本)迁移到蓝色环境(升级新版本)。

### 步骤 1 -在 Harness 中创建新的部署工作流

我们给我们的新工作流起一个名字，一个 canary 部署类型，以及一个执行部署的环境。

### 步骤 2 -创建一个或多个金丝雀阶段

接下来，让我们创建我们的金丝雀阶段，它将使用 Istio 为我们的蓝绿色环境设置迁移流量。

点击**添加阶段**，选择您想要部署的**工件**和**服务基础设施**(环境实例)。

要配置 Istio，请点击“ **Kubernetes 服务设置**”

现在点击**服务设置**，从下拉菜单中选择**负载平衡器**。

点击**入口规则**，从下拉列表中选择 **Istio** ，输入您的**网关/主机**信息:

最后，点击**升级容器**，输入 **100%** 表示所需的蓝色环境实例，输入 **100%** 表示当前绿色环境实例。这基本上意味着两个环境将运行相同数量的实例，但所有流量仍将定向到绿色(当前)环境。

要分割流量，我们只需输入我们希望在金丝雀阶段转移到蓝色环境(新版本实例)的流量百分比，在本例中为 **10%** 。

最后，一旦我们将流量重定向到我们的蓝色环境，我们就可以将一个或多个**验证**添加到我们的金丝雀阶段，以验证使用该环境的流量/用户的可用性、性能和质量。

我们这样做的目的是，如果验证失败，我们可以在几秒钟内轻松地将所有流量回滚到绿色环境。如果验证成功，我们就可以进入下一个金丝雀阶段，通过 Istio 将更多流量分流到新的蓝色环境。

一旦我们定义了金丝雀阶段，我们最终会得到一个如下所示的部署工作流:

**阶段 1** 用绿色环境中 100%可用的实例建立蓝色环境，并将新工件部署到蓝色环境中。在这一点上，所有流量仍然被导向绿色环境。
**阶段 2** 然后使用 Istio 将 10%的流量重定向到蓝色环境。如果验证成功，则部署继续到阶段 3，否则部署使用 Istio 将所有流量回滚到绿色环境。
**阶段 3** 然后使用 Istio 将 100%的流量重定向到蓝色环境。

好消息是，您可以使用工作流变量参数化输入(工件、环境等)来模板化这个部署工作流。)以便多个团队可以利用标准的蓝绿色或淡黄色部署。

### 步骤 3 -用金丝雀阶段运行蓝绿色部署

一旦我们建立了新的部署工作流，我们现在就可以运行它:)

下面是实时部署工作流，说明了蓝绿色部署的每个步骤和输出。

在下面的截图中，我们可以通过查看流量分流的实际控制台输出，从 Kubernetes 控制器和 Istio 的角度看到蓝绿色部署的金丝雀阶段 2 以及实际发生的情况。我们可以清楚地看到，90%的流量指向绿色(当前版本)，10%指向蓝色(新版本)。

我们还可以看到流量分流后的验证步骤。在上面的例子中，我们在 blue 环境中启动了一个负载测试，然后在 Prometheus、New Relic 和 Sumo Logic 中的日志文件中验证了指标。最后，需要人工批准才能进入 canary 部署的第 3 阶段。

就这样，全部完成了，用 Harness 和 Istio 构建一个蓝绿色/淡黄色部署应该不超过 5 分钟。

我将很快创建一个视频，通过上述步骤(我正在从感冒中恢复，所以我的演示声音现在有点潮湿)。

干杯！
史蒂夫。
@伯顿说