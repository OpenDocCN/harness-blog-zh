<html>
<head>
<title>Harness Infrastructure Provisioners and ARM Templates | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>线束基础架构供应器和ARM模板|线束</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/arm-templates-pt1#0001-01-01">https://www.harness.io/blog/arm-templates-pt1#0001-01-01</a></blockquote><div><p>让我们学习ARM模板的基础知识，以及如何使用Harness工作流引擎部署它们！跟随本教程。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>利用基础架构供应器将已知基础架构定义为代码技术(如Terraform和CloudFormation)的部署基础架构蓝图，并映射其输出设置以供应基础架构。基础架构供应器支持利用工作流在部署服务时即时供应基础架构。在这篇博客中，我们将了解挽具臂供应器。但在此之前，我们先了解一下Azure ARM的基本概念。</p><h2>什么是ARM模板？</h2><p>Azure Resource Manager (ARM)是Azure中代码为 (IaC)的<a href="https://harness.io/blog/devops/infrastructure-as-code/" target="_blank">基础设施的原生平台。ARM模板是一种代码形式的基础设施，这是一个定义需要部署的基础设施的概念。您不再需要点击门户，创建虚拟机或编写脚本来部署存储帐户。相反，模板定义资源，ARM管理层创建基础设施。</a></p><h2>使用ARM模板的好处</h2><p>管理Azure环境时使用ARM模板有很多好处。例如，使用声明性语法消除了编写复杂的部署脚本来处理多种部署场景的需求。</p><p>此外，这些模板提供了可重复的结果，并且是等幂的，这意味着您可以多次编写和部署相同的模板来获得相同的结果。反过来，可以使用您用于开发基础结构的相同模板，并使用它来部署生产环境。使用相同的模板可以确保资源和设置是相同的。</p><p>ARM还处理部署的操作顺序。因此，ARM会以正确的顺序部署相关资源，并在可能的情况下并行部署，以加快部署速度。此外，您可以使用用PowerShell或Bash编写的部署脚本来扩展模板，以实现完整的端到端环境设置。</p><h2>ARM模板基础</h2><p>模板使用JavaScript对象表示法(JSON)语法，该语法还包括高级功能。</p><p>模板使用声明性语法。这样，您就可以指定要部署什么，而无需编写一系列指定如何部署的命令。特别是，模板指定了要部署的资源及其属性。</p><p>只有在经过资源管理器验证之后，模板才可以部署。这使得部署不太可能中途失败。</p><p>该模板包括以下部分:</p><ul role="list"><li><strong>参数</strong>–允许您在部署期间在不同环境中使用相同模板的值。</li><li><strong>变量</strong>–将在不同模板中重复使用的值。变量可以使用参数中的值。</li><li><strong>用户自定义函数</strong>–让您定义自定义元素以简化模板。</li><li><strong>资源</strong>–指定要部署的Azure资源。</li><li><strong>输出</strong>–已部署资源的返回值。</li></ul><p>以下是用于创建存储帐户的ARM模板。</p><p>{ <br/> " $ schema ":" https://schema。管理。蔚蓝色。com/schemas/2019-04-01/部署模板。JSON # "，<br/> "contentVersion": "1.0.0.0 "，<br/>"参数":{ <br/>"存储名称":{ <br/>"类型": "字符串"，<br/>"默认值":" temp " <br/> } <br/> }，<br/> location]"，<br/> "kind": "StorageV2 "，<br/>" SKU ":{<br/>" name ":" Standard _ LRS "<br/>}<br/>}]]]。</p><h3>因素</h3><p>参数允许您将不同的值传递给ARM模板，以便在部署期间使用。一些常见的例子包括资源的名称，或者托管它们的Azure区域。参数使您的模板更加动态，可以在不同的环境中使用。</p><p>{ <br/> " $ schema ":" https://schema。管理。蔚蓝色。com/schemas/2019-04-01/部署参数。JSON # "，<br/> "contentVersion": "1.0.0.0 "，<br/>"参数":{ <br/>"存储名称":{ <br/>"值":" Anil存储"<br/> } <br/> } <br/> }</p><p>ARM部署可以在以下模式下完成:</p><ul role="list"><li>增加的</li><li>在这种模式下，部署将在ARM模板中创建新的资源。但是，它不会改变资源组中现有资源的状态，除非在模板中明确提到。</li><li>完成</li><li>在这种模式下，只会创建模板中提到的资源。任何其他现有资源都将被删除。</li></ul><p>为了说明增量模式和完全模式之间的差异，请考虑以下场景:</p><p>资源组包含:</p><p>资源A <br/>资源B <br/>资源C</p><p>该模板包含:</p><p>资源A <br/>资源B <br/>资源D</p><p>以增量模式部署时，资源组具有:</p><p>资源A <br/>资源B <br/>资源C <br/>资源D</p><p>在完整模式下部署时，资源C将被删除。资源组具有:</p><p>资源A <br/>资源B <br/>资源D</p><h3>Harness如何部署手臂模板</h3><p>首先，用户必须定义ARM provisioner，它本质上是提供ARM模板定义。<br/> <br/> <strong>步骤1:定义ARM Provisioner </strong> <br/>这可以定义为:</p><ul role="list"><li>在一条直线上的</li><li>Harness会将模板存储在其本地存储中。</li><li>在部署期间，它将从其本地存储中提取并执行ARM部署。</li><li>遥远的</li><li>如果您的模板存在于Git存储库中，那么您可以将ARM provisioner定义为remote。Harness将从用户GIT存储库中获取ARM模板，然后执行部署。</li></ul><p><br/>注意:Harness还支持<a href="https://docs.microsoft.com/en-us/azure/governance/blueprints/overview" target="_blank">Azure blue blue部署</a>。用户需要选择ARM资源类型为ARM。我们将有一个单独的博客来讨论Harness如何支持Azure Blueprint。</p><p><strong>第二步:定义ARM工作流程</strong></p><ul role="list"><li>用户必须创建ARM工作流，并将其映射到他们在步骤1中创建的置备程序。</li><li>在这里，您可以提供参数文件。同样，这可以作为内联或Git存储库的路径提供。</li></ul><p>在工作流执行期间，Harness将下载模板和参数文件。这些文件下载到代理工作目录中。然后，Harness委托将使用这些文件向Azure发送部署请求。</p><p><strong>内嵌:</strong> <br/></p><figure class="w-richtext-figure-type- "/><p><br/></p><p><strong>遥控:<br/> </strong></p><figure class="w-richtext-figure-type- "/><p>我们必须创建一个工作流，并选择上述ARM置备程序。</p><figure class="w-richtext-figure-type- "/><p>一旦工作流执行结束，模板中提到的所有资源都将在Azure中提供。</p><figure class="w-richtext-figure-type- "/><p><br/>执行以下步骤:</p><ul role="list"><li>下载文件→从Git库下载ARM模板。</li><li>执行ARM部署→使用用户在provisioner步骤中配置的ARM模板将部署请求发送到Azure进行部署。</li><li>ARM部署稳态→显示正在进行的部署的实时状态。<br/></li></ul><p><strong>内嵌模板部署流程:</strong></p><figure class="w-richtext-figure-type- "/><p>当您创建一个内嵌ARM provisioner时，模板保存在Harness Mongo中。</p><ul role="list"><li>UI将请求发送给经理，以开始工作流的执行。</li><li>管理器发送从Mongo集合获取模板的请求。</li><li>管理器接收所有模板(arm/params)文件。</li><li>管理器将所有模板和其他元数据捆绑在一起，并向Delegate发送任务请求。</li><li>委托向Azure发送一个请求，用模板启动ARM部署。</li><li>代理定期轮询以获取部署的状态，直到部署成功或失败。</li><li>轮询请求的状态会定期发送给Manager。</li><li>UI定期从管理器轮询关于部署状态的状态，并将其显示在执行日志中。</li></ul><p><strong>远程模板部署流程:</strong></p><figure class="w-richtext-figure-type- "/><p><br/>委托服务的多个实例将会运行。</p><ul role="list"><li>UI向管理器发送请求以开始工作流执行。</li><li>管理器将带有Git存储库详细信息的Git获取任务请求发送给代理。在多个委托中，将选择一个委托来执行。</li><li>然后，委托检查Git路径。</li><li>委托从Git存储库中下载模板。</li><li>代理将模板的详细信息作为回复发送给经理。</li><li>管理器呈现模板中存在的任何线束变量，并发送ARM部署的新请求。</li><li>委托向Azure发送一个请求，使用呈现的模板启动ARM部署。</li><li>代理定期检查部署状态。</li><li>部署状态会定期报告给经理。</li><li>UI定期从管理器轮询部署状态，并将其显示在执行日志中。</li></ul><p>您可能想知道为什么代理没有在步骤4之后发送部署请求，而是将模板发送给经理，因为代理已经有了ARM模板。事实证明，这些模板可能具有内置变量(我们将在本博客系列的第二部分中讨论)。委托是无状态的，这意味着它对变量一无所知。它只知道如何执行任务。经理拥有解决这些变量所需的所有相关细节。因此，在下载模板之后，它们被发送到管理器，以便它可以解析模板所引用的任何线束变量。然后，这些呈现的模板被发送给委托，作为单独的任务执行。</p><h2>结论</h2><p>在这篇文章中，我们学习了ARM模板的基础知识，以及如何使用Harness工作流引擎来部署它们。此外，我们学习了线束部署过程以及UI、管理器和代理之间的通信是如何发生的。在本系列的下一部分，我们将学习在ARM模板中使用Harness变量，以及Harness如何提供回滚支持。</p><p>敬请期待！在那之前，也许你会对这篇关于<a href="https://harness.io/blog/continuous-delivery/how-harness-uses-harness-cd/" target="_blank"> Harness如何使用Harness CD </a>的文章感兴趣？</p></div></div>    
</body>
</html>