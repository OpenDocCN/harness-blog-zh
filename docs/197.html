<html>
<head>
<title>Tutorial: [Artifact Servers] S3 - How to Provide Cross-Account Access Via Bucket Policies | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>教程:[工件服务器] S3 -如何通过存储桶策略提供跨帐户访问</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/tutorial-s3-cross-account#0001-01-01">https://www.harness.io/blog/tutorial-s3-cross-account#0001-01-01</a></blockquote><div><p>Harness有很多客户，他们有非常不同的工件来源。其中最著名的是使用一个S3桶作为各种文物的家。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>Harness有很多客户，他们有非常不同的工件来源。其中最著名的是使用一个S3桶作为各种文物的家。</p><p>我们的工程师一直在努力使S3在我们可用的许多其他集成中发挥作用。S3和GCS是我们世界的一等公民，对吗？</p><p>在AWS领域，我知道许多<strong>解决方案架构师</strong>将采用<strong>多账户</strong>方法。有时，根据业务规模，给定的<strong> AWS组织</strong>下的每个团队会建议4个账户:</p><ul role="list"><li>发展账户；</li><li>STG账户；</li><li>珠三角账户；</li><li>DevTools和DevOps帐户。</li></ul><p>如果你擅长DevOps实践，你将有一个你的工件的真实的单一来源。这就是跨帐户访问发挥作用的地方！</p><p>让我们看看Harness如何克服S3 SDK/CLI的当前设计。超级简单。</p><p>系好安全带。</p><h2>辅导的</h2><h3>要求</h3><p>我们将在一个有两个帐户的场景中工作:</p><ul role="list"><li><strong>账户A </strong>将成为桶的所有者。姑且称之为<strong> DevOps/DevTools账户</strong>。</li><li><strong>账户B </strong>将成为我们的<strong>珠三角账户</strong>。需要访问跨acc S3存储桶对象的那个。</li></ul><h3>第一步</h3><p>让我们定义一个好的工件源。我将存储几个虚拟舵图表(。tgz)在S3桶。我可以使用GitHub Pages为我的图表启动一个免费的HTTP服务器，但现在不是这样了。</p><p>所有文件仅用于学习目的，它们是模拟文件:</p><figure class="w-richtext-figure-type- "/><h3>第二步</h3><p>是时候使用最小特权原则来定义一个好的S3木桶策略了。</p><p>值得一提的是，您可以让我们的Harness代表在另一个帐户中担任角色。更好的是，如果您在EKS使用您的代理人，您可以使用IRSA使线束代理Pod服务帐户映射到IAM角色。</p><p>但对S3来说，没必要矫枉过正，对吧？</p><p>在我们的文档中，我们建议<a href="https://docs.harness.io/article/wt1gnigme7-add-amazon-web-services-cloud-provider#policies_required_amazon_s3" target="_blank">这个策略</a>。</p><figure class="w-richtext-figure-type- "/><p>使用Harness所需的IAM角色和策略将Harness连接到您的AWS帐户。</p><p>但目前，一项更具限制性的政策也在发挥作用。请记住，最起码的特权是在一个不断变化的世界中不断努力。</p><p>我将使用一个条件来允许Account B的主体到达该桶，并给出Harness当前执行任务所需的所有动作。这里:</p><p>{ <br/> "Version": "2008-10-17 "，<br/>" Statement ":[<br/>{<br/>" Sid ":" denyuencryptedobjectuploads "，<br/> "Effect": "Deny "，<br/> "Principal": "* "，<br/> "Action": "s3:PutObject "，<br/>" Resource ":" arn:AWS:S3:::::&lt;your _ bucket&gt;/* "，<br/> "Condition": {【条件 <br/> "Effect": "Allow "，<br/> "Principal": "* "，<br/>" Action ":[<br/>" S3:GetBucketLocation "，<br/> "s3:GetBucketVersioning "，<br/> "s3:ListBucket "，<br/> "s3:ListBucketVersions "，<br/> "s3:GetObject" <br/>，<br/>" Resource ":[<br/>" arn:AWS:S3::::::::::&lt;</p><h3>第三步</h3><p>好吧，让我们来看看！我创建了这个服务作为例子，因为它允许S3作为工件源:</p><figure class="w-richtext-figure-type- "/><p>非常重要:目前，Harness和AWS CLI不会列出跨帐户存储桶，但这并不意味着API不能检索对象。我们可以在工件源配置步骤中明确定义。</p><p><br/>很自然，我选择的云提供商来自账户B(符合策略的组织条件)，而不是来自S3存储桶所有者账户:</p><figure class="w-richtext-figure-type- "/><h3>最后一档</h3><p>现在让我们等待Harness异步任务来获取我们心爱的工件。</p><p><br/>导入时间<br/> time.sleep(90) <br/></p><p>开个玩笑！这是这样的:</p><figure class="w-richtext-figure-type- "/><h2>结果:</h2><p>现在你不害怕交叉帐户S3策略，我希望！</p><p>有任何问题或意见吗？让我知道-我总是乐意帮忙。</p><p>加百列</p></div></div>    
</body>
</html>