# 线束基础架构供应器和 ARM 模板|线束

> 原文：<https://www.harness.io/blog/arm-templates-pt1>

让我们学习 ARM 模板的基础知识，以及如何使用 Harness 工作流引擎部署它们！跟随本教程。

利用基础架构供应器将已知基础架构定义为代码技术(如 Terraform 和 CloudFormation)的部署基础架构蓝图，并映射其输出设置以供应基础架构。基础架构供应器支持利用工作流在部署服务时即时供应基础架构。在这篇博客中，我们将了解挽具臂供应器。但在此之前，我们先了解一下 Azure ARM 的基本概念。

## 什么是 ARM 模板？

Azure Resource Manager (ARM)是 Azure 中代码为 (IaC)的[基础设施的原生平台。ARM 模板是一种代码形式的基础设施，这是一个定义需要部署的基础设施的概念。您不再需要点击门户，创建虚拟机或编写脚本来部署存储帐户。相反，模板定义资源，ARM 管理层创建基础设施。](https://harness.io/blog/devops/infrastructure-as-code/)

## 使用 ARM 模板的好处

管理 Azure 环境时使用 ARM 模板有很多好处。例如，使用声明性语法消除了编写复杂的部署脚本来处理多种部署场景的需求。

此外，这些模板提供了可重复的结果，并且是等幂的，这意味着您可以多次编写和部署相同的模板来获得相同的结果。反过来，可以使用您用于开发基础结构的相同模板，并使用它来部署生产环境。使用相同的模板可以确保资源和设置是相同的。

ARM 还处理部署的操作顺序。因此，ARM 会以正确的顺序部署相关资源，并在可能的情况下并行部署，以加快部署速度。此外，您可以使用用 PowerShell 或 Bash 编写的部署脚本来扩展模板，以实现完整的端到端环境设置。

## ARM 模板基础

模板使用 JavaScript 对象表示法(JSON)语法，该语法还包括高级功能。

模板使用声明性语法。这样，您就可以指定要部署什么，而无需编写一系列指定如何部署的命令。特别是，模板指定了要部署的资源及其属性。

只有在经过资源管理器验证之后，模板才可以部署。这使得部署不太可能中途失败。

该模板包括以下部分:

*   **参数**–允许您在部署期间在不同环境中使用相同模板的值。
*   **变量**–将在不同模板中重复使用的值。变量可以使用参数中的值。
*   **用户自定义函数**–让您定义自定义元素以简化模板。
*   **资源**–指定要部署的 Azure 资源。
*   **输出**–已部署资源的返回值。

以下是用于创建存储帐户的 ARM 模板。

{
" $ schema ":" https://schema。管理。蔚蓝色。com/schemas/2019-04-01/部署模板。JSON # "，
"contentVersion": "1.0.0.0 "，
"参数":{
"存储名称":{
"类型": "字符串"，
"默认值":" temp "
}
}，
location]"，
"kind": "StorageV2 "，
" SKU ":{
" name ":" Standard _ LRS "
}
}]]]。

### 因素

参数允许您将不同的值传递给 ARM 模板，以便在部署期间使用。一些常见的例子包括资源的名称，或者托管它们的 Azure 区域。参数使您的模板更加动态，可以在不同的环境中使用。

{
" $ schema ":" https://schema。管理。蔚蓝色。com/schemas/2019-04-01/部署参数。JSON # "，
"contentVersion": "1.0.0.0 "，
"参数":{
"存储名称":{
"值":" Anil 存储"
}
}
}

ARM 部署可以在以下模式下完成:

*   增加的
*   在这种模式下，部署将在 ARM 模板中创建新的资源。但是，它不会改变资源组中现有资源的状态，除非在模板中明确提到。
*   完成
*   在这种模式下，只会创建模板中提到的资源。任何其他现有资源都将被删除。

为了说明增量模式和完全模式之间的差异，请考虑以下场景:

资源组包含:

资源 A
资源 B
资源 C

该模板包含:

资源 A
资源 B
资源 D

以增量模式部署时，资源组具有:

资源 A
资源 B
资源 C
资源 D

在完整模式下部署时，资源 C 将被删除。资源组具有:

资源 A
资源 B
资源 D

### Harness 如何部署手臂模板

首先，用户必须定义 ARM provisioner，它本质上是提供 ARM 模板定义。

**步骤 1:定义 ARM Provisioner**
这可以定义为:

*   在一条直线上的
*   Harness 会将模板存储在其本地存储中。
*   在部署期间，它将从其本地存储中提取并执行 ARM 部署。
*   遥远的
*   如果您的模板存在于 Git 存储库中，那么您可以将 ARM provisioner 定义为 remote。Harness 将从用户 GIT 存储库中获取 ARM 模板，然后执行部署。

注意:Harness 还支持[Azure blue blue 部署](https://docs.microsoft.com/en-us/azure/governance/blueprints/overview)。用户需要选择 ARM 资源类型为 ARM。我们将有一个单独的博客来讨论 Harness 如何支持 Azure Blueprint。

**第二步:定义 ARM 工作流程**

*   用户必须创建 ARM 工作流，并将其映射到他们在步骤 1 中创建的置备程序。
*   在这里，您可以提供参数文件。同样，这可以作为内联或 Git 存储库的路径提供。

在工作流执行期间，Harness 将下载模板和参数文件。这些文件下载到代理工作目录中。然后，Harness 委托将使用这些文件向 Azure 发送部署请求。

**内嵌:**

**遥控:** 

我们必须创建一个工作流，并选择上述 ARM 置备程序。

一旦工作流执行结束，模板中提到的所有资源都将在 Azure 中提供。

执行以下步骤:

*   下载文件→从 Git 库下载 ARM 模板。
*   执行 ARM 部署→使用用户在 provisioner 步骤中配置的 ARM 模板将部署请求发送到 Azure 进行部署。
*   ARM 部署稳态→显示正在进行的部署的实时状态。

**内嵌模板部署流程:**

当您创建一个内嵌 ARM provisioner 时，模板保存在 Harness Mongo 中。

*   UI 将请求发送给经理，以开始工作流的执行。
*   管理器发送从 Mongo 集合获取模板的请求。
*   管理器接收所有模板(arm/params)文件。
*   管理器将所有模板和其他元数据捆绑在一起，并向 Delegate 发送任务请求。
*   委托向 Azure 发送一个请求，用模板启动 ARM 部署。
*   代理定期轮询以获取部署的状态，直到部署成功或失败。
*   轮询请求的状态会定期发送给 Manager。
*   UI 定期从管理器轮询关于部署状态的状态，并将其显示在执行日志中。

**远程模板部署流程:**

委托服务的多个实例将会运行。

*   UI 向管理器发送请求以开始工作流执行。
*   管理器将带有 Git 存储库详细信息的 Git 获取任务请求发送给代理。在多个委托中，将选择一个委托来执行。
*   然后，委托检查 Git 路径。
*   委托从 Git 存储库中下载模板。
*   代理将模板的详细信息作为回复发送给经理。
*   管理器呈现模板中存在的任何线束变量，并发送 ARM 部署的新请求。
*   委托向 Azure 发送一个请求，使用呈现的模板启动 ARM 部署。
*   代理定期检查部署状态。
*   部署状态会定期报告给经理。
*   UI 定期从管理器轮询部署状态，并将其显示在执行日志中。

您可能想知道为什么代理没有在步骤 4 之后发送部署请求，而是将模板发送给经理，因为代理已经有了 ARM 模板。事实证明，这些模板可能具有内置变量(我们将在本博客系列的第二部分中讨论)。委托是无状态的，这意味着它对变量一无所知。它只知道如何执行任务。经理拥有解决这些变量所需的所有相关细节。因此，在下载模板之后，它们被发送到管理器，以便它可以解析模板所引用的任何线束变量。然后，这些呈现的模板被发送给委托，作为单独的任务执行。

## 结论

在这篇文章中，我们学习了 ARM 模板的基础知识，以及如何使用 Harness 工作流引擎来部署它们。此外，我们学习了线束部署过程以及 UI、管理器和代理之间的通信是如何发生的。在本系列的下一部分，我们将学习在 ARM 模板中使用 Harness 变量，以及 Harness 如何提供回滚支持。

敬请期待！在那之前，也许你会对这篇关于 [Harness 如何使用 Harness CD](https://harness.io/blog/continuous-delivery/how-harness-uses-harness-cd/) 的文章感兴趣？