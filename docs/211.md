# 机器学习保护您的部署|利用

> 原文：<https://www.harness.io/blog/machine-learning-to-safeguard-your-deployments>

部署面临的主要挑战是验证新部署的服务实例的健康状况。了解 Harness 如何通过机器学习保护您。

部署面临的主要挑战是验证新部署的服务实例的健康状况。在利用之前，您必须将数据连接到多个系统，并手动监控每个系统中异常的部署后活动。

进入 Harness，DevOps 社区被引入到[持续验证](https://harness.io/platform/continuous-delivery/continuous-verification/) (CV)，其中机器学习模型学习正常的应用程序行为，以识别可以在未来部署中标记的异常。我找到了我们的一个早期客户，他接受了我们持续交付和持续验证的愿景。他们已经成功地使用 Harness 来标记部署期间的服务问题数十次，从而快速响应可能出现的重大中断。

这个博客试图详细介绍我们推荐的最佳策略，以实现高信心的持续交付，确保部署的服务按预期工作。

## 部署策略

验证您的部署的最佳方式是在 [canary 部署](https://harness.io/blog/build-canary-deployment/)期间。使用 Canary，您可以分阶段部署您的容器或服务，慢慢构建 100%的集群。Canary 的好处在于，在部署的早期，您可以同时运行多个版本的容器或服务。

Harness 通过比较来自新部署的服务实例的数据和来自已经运行的服务实例的数据来获得最佳结果。当您一次将容器或服务部署到 100%的集群时，不能应用这种方法。下面是一个两阶段 Canary 部署的示例，每个阶段都有 50%的集群使用 Harness 进行部署:

## 数据策略

您需要用于数据科学的数据:)Harness 可以查看您的事务数据、基础架构指标和日志，以验证您的部署。我们集成了许多 APM 提供商，如 AppDynamics、Prometheus、Datadog、NewRelic，以及许多日志聚合器，如 Elasticsearch、Splunk 和 Sumo Logic。我前面提到的客户使用 NewRelic 和 Prometheus 来检测和收集数据。

## 验证策略

在早期 Canary 阶段，当多个版本同时运行时，根据 APM 或日志提供者设置验证。下面是一个在第一阶段使用 NewRelic 和 CloudWatch 来决定新容器是否工作良好的例子:

在上图中，我们的机器学习(ML)模型能够根据下面显示的 NewRelic 错误指标来检测高风险交易:

这是点击红色圆圈时出现的下钻视图示例。您可以看到哪些容器在容器级别受到影响，并分析度量数据。

注意，这是一个多阶段部署，所以 Harness 可以使用尚未更新的容器中的数据了解什么是正常的。这使结果相对于流量或环境的变化正常化，因为它同样适用于新旧集装箱。因此，任何偏差都很可能是容器内代码提交或配置更改的结果。

## 回滚/干预策略

作为回滚/干预策略的一部分，该特定客户中止了部署。他们喜欢保留一小组新部署的容器或服务，将负载导向它们，并解决更多的问题。如果异常可以快速修复，您也可以选择继续部署，或者选择始终启动立即回滚。

## 金丝雀验证挑战

Canary 部署可能会遇到以下验证挑战:

*   **不能同时运行多个版本。**这通常是由于向后兼容性问题、上游/下游依赖性以及有状态服务而发生的
*   **未收集服务的日志/指标**
*   **收集的数据没有标记容器级元数据。**相反，只有服务或应用程序级别的元数据
*   **不希望在每个初始阶段增加额外的 15 分钟进行验证。**在您部署的某个阶段，验证可能会花费比您期望的更多的时间。

如果你不得不使用不同的[部署策略](https://harness.io/blog/blue-green-canary-deployment-strategies/)比如蓝/绿，不要绝望。线束具有仅次于金丝雀分析的蓝/绿验证策略。

干杯！
斯里拉姆