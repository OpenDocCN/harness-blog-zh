# 服务客户:实现 CI/CD 自动化的途径

> 原文：<https://www.harness.io/blog/service-accounts-cicd-automation>

我们讨论服务帐户、API 密钥，以及 DevOps 团队如何使用它们来构建可扩展和可维护的 CI/CD 基础设施。

服务账户位于 API 优先业务的核心。使用服务帐户和 API 密钥，可以节省工程师设置和维护管道、部署、审计、机密、资源、用户供应等所需的大量人工工作。

在这篇博客中，我们将讨论服务帐户的内部架构、API 密钥，以及 DevOps 工程师如何使用它们来构建可扩展和可维护的 CI/CD 基础设施。

## 什么是服务帐户？

服务帐户是一种特定类型的帐户，由应用程序而不是个人使用。应用程序通常使用服务帐户进行授权的 API 调用。

例如，在 Harness 中，您可以创建一个服务帐户，为其分配权限，并使用它来执行跨模块(CI、CD、CCM 和特性标志)的操作，这些操作现在可能是手动执行的。

服务帐户在以下方面不同于用户帐户:

1.  服务帐户不能通过浏览器或 cookies 登录。
2.  服务帐户使用 API 密钥令牌而不是密码进行身份验证。
3.  服务帐户不能添加到用户组，也不能像用户一样从他们所属的用户组继承权限。

## 为什么我们需要服务帐户？

您可能会想，“当同样的事情可以通过用户帐户完成时，为什么像 Harness 这样的 CI/CD 平台要支持服务帐户？”

一个字的答案是:“自动化。”

使用服务帐户，企业可以自动化几乎所有与 CI/CD 相关的工作，并消除数小时的手动工程工作。例如:如果 DevOps 工程师每天花大约一个小时通过 UI 手动触发和监控同一组工作流，他/她可以使用服务帐户自动完成所有工作，从而节省大量时间。

另一个重要方面是面向大型企业的自动化用户供应。大型企业有不同的访问管理策略集来允许用户访问第三方工具。手动设置这些策略可能容易出错:手动设置可能会导致错误的权限，从而导致后期的合规性问题。

服务客户可以通过大型企业不同部门的工作流实现用户供应自动化，并使其面向流程，从而解决这一问题。

## 如何配置服务帐户

既然我们已经确立了服务帐户的重要性，那么让我们来理解内部架构以及如何利用它。

服务帐户是一种主体类型，与可以分配角色的服务中的用户相同。

创建服务帐户后，您可以在服务帐户中创建多个 API 密钥。在每个 API 键中，您可以创建多个令牌。

每个 API 密钥令牌都继承父服务帐户的角色。您可以在一个 API 密钥中创建、轮换或删除 N 个令牌，相同的权限集将应用于它。

API 密钥令牌有两个重要属性:

1.  **令牌值(如 sat . 6187 b7b 3454 a 8772 C2 fa 00 f 8.7 qhqftzjuaundvj 76 uyv)**
2.  **令牌到期时间(例如 2021/12/31)**

下面我们来详细了解一下这两者。

### 代币价值

令牌应被视为等同于密码，因为它们可以授予与登录用户相同级别的进程/脚本访问权限。由于高安全风险，不建议以纯文本形式存储令牌，因此哈希是必须的。

[哈希](https://www.baeldung.com/cs/hashing)是使用被称为加密哈希函数的数学函数从给定的字符串生成字符串或哈希的过程。

#### **选择强哈希算法**

一个好的散列函数必须遵循以下标准:

1.  确定性:由相同散列函数处理的相同 api_key_token 应该总是产生相同的散列。
2.  不可逆:从它的散列中生成 api_key_token 应该是不可能的。
3.  高熵:对 api_key_token 的任何微小改变都会产生非常不同的散列。
4.  防止冲突:两个不同的 api_key_token 不应该产生相同的散列。

有各种可用的散列选项，例如:MD5、SHA256、SHA512、PBKDF2、scrypt、bcrypt 等。然而，MD5 被破解了，因为它太快了，而且有比 SHA 系列更好的选择。

满足以上所有标准的一些很棒的散列函数有 **PBKDF2、bcrypt、**和 **scrypt** 。它们都是很好的、被广泛接受的散列函数。我们选择了 **bcrypt。**

#### **为什么是 bcrypt？**

攻击者可以通过提高计算机的速度和能力来利用弱哈希算法。并非所有的加密算法都设计成可随计算能力而扩展。密码的安全性取决于所选加密哈希函数计算密码哈希的速度。当在更强大的硬件上运行时，更快的函数将执行得更快。

为了降低这种风险，我们可以设计一个散列函数，它可以在新的强大硬件上运行得更慢。

bcrypt 是由[尼尔斯·普罗沃斯](https://twitter.com/NielsProvos)和[大卫·马齐耶尔](https://twitter.com/dmazieres)设计的。它基于 Blowfish 的 [Blowfish 密码](https://en.wikipedia.org/wiki/Blowfish_(cipher)和 UNIX 密码系统使用的散列函数名称 crypt。

bcrypt 通过将 Blowfish 的昂贵的密钥设置阶段与可变数量的迭代相结合来增加哈希计算的工作量和持续时间，从而减轻了字典攻击。

bcrypt 的另一个优点是默认情况下它需要 salt，这加强了安全性最佳实践。哈希与 salt 结合使用，可以保护密码免受彩虹表攻击。

下面是 bcrypt 生成的散列的一个示例:

$ 2a $ 10 $ ZLhnHxdpHETcxmtEStgpI ./ri 1 MKS gj 9 IDP 36 fmfmdyyvg 9g 0 B2 dq

*   “2a”代表 bcrypt 算法版本。
*   “10”代表算法的强度。
*   “ZLhnHxdpHETcxmtEStgpI”一部分是随机生成的盐。这 22 个字是盐。
*   最后一个字段的剩余部分是纯文本的实际散列版本。

### 令牌过期时间

每个令牌都有一个过期日期，过期后就不能用于身份验证/授权。需要定期轮换。

立即轮换令牌可能会将其标记为无效并中断自动化流程，因此在 Harness 中，我们提供了一些功能，您可以轮换即将到期的令牌，并设置将来将其标记为无效的最后期限。同时，您的自动化流程可以整合新的循环令牌，并保持运行而不会出现任何故障。

对于这个设定的时间窗口(截止时间)，旧的和轮换的令牌都保持有效，以通过各种过程实现平滑过渡。

## 如何使用服务帐户令牌

要在从自动化脚本调用任何 Harness API 时使用这个令牌，您需要在 X-API-KEY 头中传递它。

x-API-KEY:sat。6187 b7b 3454 a 8772 C2 fa 00 f 8.7

API Key Token 的这种格式是深入讨论和思考的结果，旨在将它与基于模式的欺诈检测、请求跟踪和限制速率的糟糕的自动化脚本相集成。我们将在另一篇博客中详细讨论这些。

## 结论

在这篇博客中，我们了解了服务帐户及其对 CI/CD 平台支持大规模自动化的重要性。我们还了解了在选择正确的散列算法来保护基于 API 密钥令牌的访问时的各种权衡。你可以阅读 GCP 等云平台如何使用[服务账户](https://cloud.google.com/iam/docs/service-accounts)。

看来你喜欢深潜的作品！为什么不读另一本呢？了解更多关于利用的[事件驱动架构，或利用](https://harness.io/blog/event-driven-architecture-redis-streams/)的[数据驱动的质量债务方法。](https://harness.io/blog/bugs-data-driven-quality/)