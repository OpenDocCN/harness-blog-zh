# 功能标志最佳实践(功能切换)|线束

> 原文：<https://www.harness.io/blog/feature-flags-best-practices>

生产中的测试，基于主干的开发，默认使用特性标志——这些都是特性标志的最佳实践。立即了解更多信息，让您的功能标志体验尽可能有益！

到目前为止，我们已经写了很多关于特性标志的内容，包括 [5 个你可能没有想到的特性标志用例](https://harness.io/blog/feature-flag-use-cases/)、[在生产中使用特性标志进行测试](https://harness.io/blog/testing-in-production/)，以及[渐进式交付:金丝雀和特性标志](https://harness.io/blog/canaries-and-feature-flags/)。但是今天，我们想花一些时间来提供一些更高层次的功能标志最佳实践，以帮助您随着团队的成熟和功能标志成为您工作方式的标准部分而获得更好的结果。

这些技巧旨在帮助您的软件团队使用特性标记来获得更多的控制，无论您正在实现特性切换，尝试扩展您的特性测试，希望控制系统行为来控制访问，或者甚至只是尝试向您的整个用户群推出一个新特性。

## 快速特征标志刷新程序

在深入研究特性标志最佳实践之前，让我们首先确保我们对特性标志有相同的认识。

### 什么是特征标志？

特性标志是一种方式，开发人员可以有条件地打开或关闭他们代码(或代码路径)的某些部分。您可以将特性标志视为连续交付的扩展——一种将变更置于标志之后并在以后以受控的方式打开它们(或者以同样的方式隐藏和删除它们)的方式。它们构成了特征标志管理的基础。

不确定您是在使用功能标志，还是在做功能标志？其他一些常见的术语有特性切换、发布切换和实验切换。在某些情况下，还有操作切换和实验切换。对于那些没有使用正式的特性标记解决方案的人(无论是构建的还是购买的)，您可能会在配置文件中看到以变量表示的特性标记。

无论您使用的是什么版本的特性标志或特性切换，您最终都希望获得使用特性标志方法的好处。

The software delivery lifecycle - just like providing electricity to your home.

### 生产效益

一般来说，团队采用特性标志是因为他们想要提高他们的交付速度，同时进一步降低这样做的风险。将不同的特性放在标志后面允许团队以更小的块和更频繁地部署代码，创建多个“保存点”并允许不同的特性投入生产，即使它们还没有准备好。一旦变更被部署到生产中，特性标志就成为团队的控制点。

几乎在使用特性标志时，您会立即看到工程方面的一些东西:

*   速度会提高，因为您可以更快地合并功能分支，更频繁地部署，而不用担心隔离不完整的功能；
*   使用特性标志而不是定制脚本或其他秘密管理命令，可以更容易地控制跨环境的变更状态；
*   你可以把一个特性标志交给你的项目经理、经理或其他利益相关者，让他们决定什么时候开启，这样你就不会被打断。

在组织的其他部门，您也会看到好处:

*   通过允许任何人使用试验或测试功能的功能标志，您可以更快地为您的客户服务，而不必等待工程可用性或响应；
*   发布协调大大简化，因为项目经理和营销团队可以完全拥有发布，而不需要与工程部门进行昂贵且耗时的发布协调；
*   由于功能标志为重要的新功能配置提供了一个通用的用户界面，每个人都可以更清楚地看到哪些功能可用以及在哪里可用。

特色旗虽小，但功能强大。在我们的[功能标志 101 电子书中，您可以了解更多关于什么是功能标志，如何以及何时使用它们，以及在生产中使用功能标志的好处和挑战。](https://harness.io/learn/ebooks/ebook-feature-flags-101/)

## 功能标志最佳实践

### 命名新功能

功能标志带来了许多优势，但是团队通常不会想到他们想要如何管理功能标志，直到他们走得更远，并且拥有许多旧标志，一些位于不再被切换的稳定代码之上。随着组织规模的扩大，这将导致生产变得令人难以置信的混乱，并削弱使用特征标志系统的价值。如果特性标志的想法是为了加速开发和降低风险，那么膨胀系统不就与此背道而驰了吗？

即使在团队知道他们想要清理什么的场景中，他们也经常发现他们很难知道一个特定的特性标志是做什么的。这是因为这些名称通常是以工程为中心的(比如“NEXT_OLD_GEO3”)。我们建议给特性标志起一个人类可读的名字，这样随着时间的推移，特性标志的管理会更加容易。虽然这本身并不能解决潜在的膨胀问题，但是拥有易于定位的特性标志是使及时清理或生命周期管理成为可能的一个进步。

举个例子，如果标志是面向用户的新特性，那么给标志起一个名字，让公司中技术水平较低的用户能够识别这个特性。记住，不会总是工程师在处理特性标志。在上面的例子中，假设 NEXT_OLD_GEO3 引用了一个功能标志上的区域绑定目标组，翻转该标志将为欧洲的用户打开一组功能标志。团队正在开发一套新的隐私或 GDPR 兼容功能，他们希望用欧洲用户群的真实生产数据来测试它们。但是，随着时间的推移，您会希望逐步淘汰这个标志，因为这些特性在生产中会永久存在。光是这一面旗就能掀翻另外五十面！你可以想象找到这个标志来打开特性，然后清理它是多么的困难。在这里，称这面旗帜为“隐私特征-欧洲”可能更有意义

最后，重点是要让单个的特性标志更容易找到，尤其是非工程用户使用它们的时候。

### 避免特征标志地狱

许多团队对标志管理疏忽另一个特点是，没有明确内部流程或关于谁拥有删除过期标志的协议。或者他们希望这个过程多久发生一次。这经常会导致团队感觉有太多的特性标志，或者他们陷入了特性标志的地狱。如果您想获得好处并继续创建更多的特性标志，尤其是在生产环境中，这不是您想要的。

标记的好处之一是允许整个公司的团队在各种不同的场景中使用标记，例如测试用户行为的实验切换、使用后端标记修改系统行为的操作切换。

缺点是，随着许多新特性的出现，任何人都可以实现特性标志，您会发现您的应用程序代码到处都有特性标志。除了让特性标志遍布代码库之外，特性标志管理系统也将随着这些新特性标志在代码中的建立而增长。换句话说，随着特征标志在组织中的使用越来越多，有两个地方需要保持卫生。

我们不认为有太多的功能标志，但您希望在为每个新功能启动新标志时，确保删除陈旧、不必要或过期的功能标志。这将使避免臃肿的特征标志系统带来的缺点变得简单得多，并继续收获好处。

提前进行对话。您多久移除一次过期标志？谁负责？不同类型的旗帜有不同的主人吗？哪些是永远不应该删除的永久功能标志？

一些最大的企业，如脸书、Pinterest 和网飞，经常利用功能标志来收集数据，并为他们的用户群提供最佳体验。这些组织有数以千计的标志，适当地处理卫生问题以确保大规模的可操作性是非常必要的。

事实是，当团队处理完积压的工作并开始加速他们的软件交付过程时，特性标志地狱可能会悄悄降临到他们身上。虽然考虑一旦规模扩大后如何管理标志很重要，但提前做好计划是有好处的。

### 默认情况下使用功能标志

"特性标记听起来不错，但是我们如何开始呢？"

这是我们经常遇到的问题，而且很有道理。但是我们的回答总是一样的:你所做的任何代码更改，都要放在一个特性标志的后面！

不要等待正确的用例，在那里你确切地知道你想要如何为一个给定的特性使用标志，或者确切地知道你想要控制什么，把特性标志想得更像一个连续的交付管道，在这个意义上，如果你正在做一个改变，它应该通过 CD。同样，如果你要做出改变，你应该把它放在旗子后面。

特性标志应该是测试过程的核心部分，标志后面的变化越多，将来的可选性就越强。如果一个变更导致系统中断，您可以将其关闭，如果它隐藏在一个标志之后的话——即使您事先没有预料到这个用例。类似地，能够在任何给定的环境中测试变化并收集数据总是有用的，即使你现在没有这个打算。因为许多特征标志包含离散功能，所以即使在多特征切换配置的情况下，您也可以很容易地关闭特征标志的组合。

### 考虑基于主干的开发

我们已经写了更多关于[基于主干的开发和特性标志](https://harness.io/blog/trunk-based-development/)的细节，但是值得重申一下。

基于主干的开发将帮助您的团队更快地前进，并从您的代码部署和特性发布过程中去除复杂性和风险。通过拥有更少的长期分支和代码路径，以及更多的即使在您的生产环境中也不公开变更的特性标志，您将能够合并更多，部署更多，并最终显著降低风险。

### 想想操作开关(不仅仅是释放开关)

顾名思义，特性标志通常是作为一种实现发布切换或实验切换的方式来实现的。但是，有不同的切换，你可能会发现有用！至关重要的是，创建操作切换(或 ops toggles)的特性标记是一种很好的、未被充分利用的使用特性标记的方式。

在控制关键配置设置的某些代码路径周围放置标志，而不是在功能周围放置标志，使您准备好立即响应任何类型的生产故障，降低您的平均解决时间(MTTR ),并降低响应压力系统中断的难度。

### 一面旗帜不能统治所有人

假设我们正在向所有高级用户推出一个新功能，这个功能需要前端和后端的改变。这很常见。大多数面向用户的功能都有多个相关的变化。将所有这些变化放在一个开关后面似乎是有意义的。

然而，在实践中，最好使用较小的切换范围，将较小的特性标志链接在一起。当一切都隐藏在一个标志之后时，很难知道哪个代码路径具体导致了问题。此外，在迭代特性的过程中，很难测试更多的离散变化。

### 利用功能标志作为第一道防线

特性标志将最低的控制层移动到特性级别或发布级别。通过将部署从发布中分离出来，工程团队能够授权其他团队为他们自己的目的使用功能标志，例如产品管理、销售、市场营销或客户支持。

首先，这可以实现更好的事件管理，或者可以称为平均解决时间(MTTR)。在出现问题的情况下，任何有权访问相应功能标志的人都可以简单地为受影响的用户或目标关闭该标志。不必等待工程部门的正式上报响应，该功能可以关闭，以最大限度地减小爆炸半径，同时工程部门可以在没有客户影响压力的情况下解决问题。

您可能已经获得了第二个好处:在不启动回滚或前滚过程的情况下解决问题。想象一下这样一个场景，一个部署有几十或几百个变更，由于个别错误，不得不回滚整个部署——包括所有好的特性。这给软件交付过程的部署阶段增加了巨大的压力。在功能标志的世界里，没有回滚——只要关闭它。

反过来，这开始缓解随着时间的推移部署变得越来越大的问题，这本来就更慢，部署起来更有风险。团队必须花费更长的时间来验证每一个细节，以确保不发生任何事故，也不需要启动任何作战室或回滚。通过将这种压力转移到功能级别，部署可能会突然变得更小，这是由包装在标志后面的更改承诺支持的，增加了第二层防御。

### 使用实时数据在生产中进行测试

我们已经在博客上写了更多关于生产中测试的细节。

生产中的测试并不像听起来那样。虽然我们不提倡在没有经过适当的 CI/CD 过程的情况下将特性推向生产，但是我们确实相信团队应该在真实环境中测试特性，而不仅仅是测试数据。

团队可以将特性标记放入产品中，为实际运行做好准备，并收集数据以了解它的表现如何。它会引起问题吗？是在解决客户的问题吗？它是否推动了正确的指标？基于这些数据，团队能够更快地迭代他们的变更或其他特性，并交付更高质量的最终结果。

另一个应用是与真实客户一起尝试多种解决方案。团队可以将多个 MVP 投入生产，看看什么最能满足客户的需求，而不是闭门造车做出冒险的决定，并抱以最好的希望。最终，客户得到了更多他们想要的东西，内部团队减少了他们的压力和风险因素。这是双赢。

重要的是要记住，为了在生产中有效地进行测试，您需要确保您能够从测试中获取评估数据，并将其应用到适当的上下文中。如果您将特性标记放在那里，而您无法收集数据，您将如何进行生产中的测试所支持的分析呢？

这可能很难构建，更难将数据映射到适当的业务上下文，例如对收入的影响、停机时间的减少或客户满意度。您需要确保能够获取评估数据，并以所需的方式应用这些数据。

### 创建可执行的治理流程

避免特性标记地狱的一个方法是拥有良好的治理过程。我们所说的治理本质上是创建可伸缩的过程，以确保过程和最佳实践得到遵循和执行。

这些治理步骤可以包括诸如通过一组批准，仅在满足某些触发条件时提交发布，或者根据性能度量标准进行验证。这里的要点是，在一个特性发布(不是部署，而是发布)之前，它需要通过一些检查和平衡，以确保事情以正确的方式进行，从而首先避免问题。

另一方面，问题确实会发生，那么你会怎么做呢？作为治理过程的一部分，确保团队能够正确地审计正在发生的事情是很重要的。特别是像特性标志这样的东西，它将每个单独的变更分解成它自己的控制点，在对问题进行分类时，能够理解正在发生什么和已经发生了什么是非常重要的。确保审计日志随时可用是难题的一部分，但是拥有一个坚实的治理过程，其步骤在审计日志中结束，可能是难题的更大部分。

显然，如果这能以任何方式自动化就太好了。您可能会意识到您有一套一致的步骤，并且随着时间的推移只有少量的变化，因此也值得考虑如何将过程模板化并最终自动化。

An example of enforced governance as part of a release pipeline.

## 结论

特征标记可以而且将会加快您的团队的速度，减少事故的数量和严重性，并且比以往任何时候都更容易对您的客户做出反应，成为一个注重学习的组织。

通过在您的组织中实施正确的工具、实践和过程，您会发现您能够充分利用特性标志，并真正确保您从它们中获得最大价值。希望有了这些功能标志的最佳实践，您将看到一帆风顺，并找到更多使用标志的方法。

如果您正在寻找一种方法来实现这些最佳实践，并确保您有一个支持您这样做的能力的解决方案，甚至可能有一些内置的解决方案，那么花时间查看一下[利用特性标志](https://harness.io/products/feature-flags/)是非常值得的。当你准备好了，欢迎你注册一个演示或免费试用！快乐编码。