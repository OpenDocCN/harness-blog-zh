# 什么是管道代码，如何利用它？装具

> 原文：<https://www.harness.io/blog/pipeline-as-code>

管道作为代码是定义软件交付管道的实践，其中代码在源存储库中进行版本控制。从 Harness 了解更多信息。

Jenkins 得到了数百万开发者的认可，因为它是世界上最受欢迎的 CI 服务器。*但是詹金斯是什么，它从何而来？* Jenkins 是一款开源自动化服务器，可帮助公司加快软件开发周期。

它是在 2004 年由 Sun 公司的 Java 开发人员 Kohsuke Kawaguchi 以 Hudson 的名字创建的。他厌倦了他的代码破坏构建，并且想要一种在提交到存储库之前测试他的代码的方法。

Hudson 在 Sun 大受欢迎，因此 Kawaguchi 将其开源给其他开发人员使用。2011 年，在甲骨文和 Hudson 开源社区发生争执后，它被赋予了一个新名字:Jenkins。

随着 Jenkins 和对自动化的关注，开发人员转向通过“as code”运动使他们的软件开发周期更容易和更有效。

## “作为代码是什么？��

在 DevOps 中，有一种向“[插入软件术语]作为代码”的转变，但这意味着什么呢？“as code”术语仅仅意味着自动化。为[某个软件术语]创建配置代码，并将其放入集中的源代码库(GitHub、GitLab、Bitbucket 等)。)允许用户满足自动化目标，包括最小化测试、提高效率和增强软件质量。

“as code”运动并不新鲜。然而，在过去的几年里，它已经越来越受欢迎，因为热门技术开始接受这种方法。例如，随着公司专注于应用程序的现代化，他们转向 Kubernetes，这是一个用于自动化部署、扩展和管理容器化应用程序的开源系统。

Kubernetes 使用配置文件并通过代码管理应用程序。大多数“as code”技术使用 YAML 或 JSON 作为它们的配置语言。这种标准化使用户更容易对他们的所有工具使用相同的语言和方法。当用户可以通过代码操纵他们的软件交付环境时，他们会很兴奋，并且“作为代码”的势头会增长。

### 基础设施作为代码

基础设施即代码(IaC)是在配置文件中管理和配置基础设施，而不是通过手动过程。这确保了每次应用该代码时都启动相同的基础设施，并使创建基础设施的过程规范化。

通过将基础设施放入源代码，进而放入源存储库，它允许在不同的环境中轻松定制，因为每个配置可以放在不同的分支中。此外，IaC 不需要编程语言，因为主要关注的是配置。

### 作为代码构建

就像基础设施作为代码一样，构建作为代码是一种通过配置文件来定义构建的方法，这些配置文件被签入到 Git 之类的源代码控制中。

### 管道作为代码

管道作为代码，遵循其他“[插入软件术语]作为代码”的结构，是通过代码定义部署管道的实践。这允许用户创建构建、运行测试和部署具有审计跟踪的代码，因为它存储在中央存储库中。要将这些管道构建为代码，用户可以使用 YAML 或特定于供应商的语言(如 Groovy)来使用声明性方法。

这些管道作为代码文件，列出了管道成功运行所需的特定阶段和顺序。管道代码中的更改可以在不同的分支中进行测试，因为文件是有版本的。这种方法，即代码管道，是创建持续集成管道的行业最佳实践。

## 管道作为代码从何而来？

作为代码的管道源于作为代码移动的更大的基础设施，但一直由 Jenkins 主导。Jenkins 将管道描述为代码，即一组功能，允许 Jenkins 用户使用代码定义管道作业流程，代码存储在源存储库中并进行版本控制。

## 管道作为代码的好处

因为管道作为代码解决了开发人员在软件开发过程中面临的许多棘手问题，所以有许多好处。作为代码的管道允许版本控制，这允许更改可跟踪，也允许容易的回滚。

这为开发人员提供了审计线索，这在调试和透明性方面很有用。如果在任何时候，团队决定他们想要回滚到以前的版本或者一些中断，拥有版本控制中的管道可以让团队轻松地恢复。

此外，由于 CI 管道的源代码和应用程序代码存储在同一个存储库中，因此所有代码都在同一个位置，因此访问起来非常方便。共享存储库中的管道代码允许协作，因为所有团队成员都可以访问代码库。

开发人员可以在没有额外权限的情况下进行更改，因为在将更改合并回主分支之前有一个代码审查过程，这避免了管道中的任何潜在中断。

## 管道作为代码的缺点

像所有事情一样，管道作为代码也有它的缺点。管道作为代码的一个主要缺点是在编写部署管道时涉及到陡峭的学习曲线。学习如何用正确的语法和模块正确地编写一个脚本需要时间。

更复杂的是，如果其他人已经编写了代码，要完全理解它可能需要更多的时间。幸运的是，有大量的资源，重用以前创建的管道很容易。

另一个值得强调的缺点是可能很难管理代码。这些管道可能会超过 1000 行代码，更新和维护它们可能会变得令人头痛。

## 如何开始将管道用作代码

许多人依赖于使用 Jenkins 来创建管道作为代码。为了创建这些[连续交付](https://harness.io/blog/what-is-continuous-delivery/)管道，开发人员将经历学习如何编写变化无常的 Jenkinsfiles 的过程，以便可以将它们签入源代码 repo 并执行部署应用程序的步骤。

### 数字式用户线路

随着 Jenkins 转向管道代码模型，工作流插件的创建有了重大突破。这产生了领域特定语言(DSL)步骤，这些步骤可以转化为更简单的管道。

### 脚本管道与声明管道

脚本管道和声明管道的一个关键区别是它们的外观。下面是两个管道的例子，因为它将在我们深入细节之前提供一个概述。

*照本宣科的流水线*

在这个脚本化的管道中需要注意的是，第一个元素是节点，变量是用 Groovy 语言定义的。此外，通过 try/catch 子句管理错误，并通过变量定义 Artifactory 配置。

*声明式管道*

另一方面，比较声明性管道和脚本化管道，第一个元素是管道，变量在环境部分中定义。因为 Groovy 语法是不允许的，所以错误处理的 try/catch 结构是不允许的，但是允许插件配置 Artifactory 之类的东西。

#### 脚本化管道

脚本化管道是编写管道的传统方式。它使用更严格的基于 Groovy 的语法，可以帮助开发人员创建高级和复杂的管道。要创建脚本化管道，用户必须从节点块开始。一个节点块执行管道的核心工作，在它内部有多个阶段。

阶段定义了将通过整个管道执行的任务的概念上不同的子集。例如，阶段可以包括构建、测试和部署。尽管对于脚本化管道可以以编程方式做什么没有限制，但是使用脚本化管道有一些主要的缺点。脚本管道没有正式的结构或流程，唯一的限制是 Groovy 语法。

这可能导致不可靠的管道代码，不容易解释或维护。此外，由于缺乏解释 Groovy 的结构和自由，并不是所有在脚本管道中完成的事情都能在 Jenkins UI 中很好地呈现。

#### 声明管道

另一方面，声明性管道是一个较新的特性，它使得管道代码更容易读写。声明性语法更加有限和严格，因为它不允许开发人员注入代码。要创建声明性管道，用户必须以单词 pipeline 开头。然后，它将被分解成包含多个步骤的各个阶段。

尽管声明性管道不太适合具有复杂逻辑的管道，具有限制性语法，并且缺乏与旧插件的兼容性，但它们是开发管道的现代方式。这些管道更加结构化，语法更简单，与蓝海接口集成，并允许用户从特定阶段重新启动。

### 詹金斯文件

在为 Jenkins 创建作为代码模型的管道时，Jenkinsfile 是关键。Jenkinsfile 是保存 Jenkins 管道配置的文本文件。这个文件被签入源代码管理器，文件的相对路径应该在 Jenkins 内部定义。

没有这个文件，Jenkins 就不能自动管理和执行作业。在这个文件中，有一个管道脚本突出显示了执行作业的步骤。Jenkins 文件通常使用 Groovy DSL 编写，可以通过文本编辑器或 Jenkins 实例上的配置页面创建。

## 使用线束将管道作为代码进行管理

管道作为代码简化了软件开发。使用 Jenkins，这个过程是自动化的，但是开发人员仍然不得不忍受创建这个管道的艰苦过程——但是如果他们不需要呢？如果有一个不需要脚本的平台——一个使执行 [CI/CD](https://harness.io/blog/what-is-ci-cd/) 变得容易的工具——会怎么样？

认识一下线束平台。Harness 减少了开发人员创建这些管道的需要——实际上，它自己创建了管道！查看平台，[今天就要求演示](https://harness.io/platform-demo-request-lp)。