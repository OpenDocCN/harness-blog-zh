<html>
<head>
<title>| Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>装具</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/node-js-unit-testing-automation-with-drone-ci-using-mocha-framework#0001-01-01">https://www.harness.io/blog/node-js-unit-testing-automation-with-drone-ci-using-mocha-framework#0001-01-01</a></blockquote><div><p>了解如何使用Drone CI进行持续集成(CI ),并以一个简单的Node.js应用程序和Mocha作为单元测试框架。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>没有别的办法:单元测试是任何软件开发生命周期的重要部分。在当今的现代云原生空间中，自动化测试的需求很高，有许多平台和工具可用。这种测试自动化可以通过持续集成(CI)过程来完成。CI是整个DevOps流程中的一个基本方法。CI帮助开发人员测试和构建他们的代码，因此他们可以确保没有任何东西被破坏，并且通过审批者的简单批准，代码可以自信地集成到主分支中。CI流程可以通过Drone CI无缝自动化，以测试、构建和增强开发人员的信心。CI让开发人员节省了手动测试的时间，并专注于构建客户需要的丰富特性。今天，我们将演示如何使用Drone CI进行CI，并将一个简单的Node.js应用程序和Mocha作为我们的单元测试框架。</p><h2>先决条件</h2><ul role="list"><li>从官网<a href="https://nodejs.org/en/download/">这里</a>下载安装Node.js。</li><li><a href="https://www.drone.io/">无人机CI </a>调教。</li></ul><h2>辅导的</h2><p><strong>第一步:为你所有的申请文件创建一个文件夹:</strong></p><p class="w-embed"><code class="code--embed"> mkdir myapp <br/> cd myapp </code></p><p><strong>第二步:编写一个简单的Node.js应用程序。</strong></p><p>通过运行以下命令初始化您的项目:</p><p class="w-embed"><code class="code--embed"> npm init </code></p><p>这将创建一个package.json文件，其中包含您为项目下载的所有依赖项。</p><p><strong>第三步:安装express，Node.js web应用框架:</strong></p><p class="w-embed"><code class="code--embed"> npm install express --save </code></p><p><strong>步骤4:接下来，我们必须用下面的代码创建一个名为app.js的文件:</strong></p><p class="w-embed"><code class="code--embed"> var express = require('express');<br/> var app = express();<br/>  app.get('/', function (req, res) {<br/>   res.send('Hello World!');<br/> });<br/> app.listen(3000, function () {<br/>   console.log('Example app listening on port 3000!');<br/> });<br/> </code></p><p><strong>第五步:运行应用:</strong></p><p class="w-embed"><code class="code--embed"> node app.js </code></p><h3>Mocha单元测试框架</h3><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"><figcaption><strong><em>Image credit: </em></strong><a href="https://openbase.com/categories/js/best-nodejs-testing-framework-libraries"><strong><em>openbase</em></strong></a></figcaption></figure><p>Mocha测试框架是一个JavaScript库，用于测试JavaScript代码。这是一个开源框架，给了开发者很大的灵活性。它有一个简单的API，可以用来测试同步和异步代码。它还具有链接、回调和承诺等特性。此外，它提供了并行运行测试的API，这加快了为大型代码库编写测试的过程。Mocha测试框架可以通过使用节点包管理器(NPM)来安装。</p><p>步骤6:让我们将测试文件夹添加到我们的应用程序目录中，我们所有的测试都将驻留在这个目录中。</p><p>创建一个名为test的文件夹，并在该文件夹下创建一个文件test.js。</p><p>您可以将Mocha和Chai安装为Node.js测试框架的一部分:</p><p class="w-embed"><code class="code--embed"> npm install --save-dev mocha </code></p><p>在特定项目的package.json文件中添加Mocha作为依赖项。</p><p><strong>步骤7:将下面的基本Mocha字符串测试规范添加到test.js文件中:</strong></p><p class="w-embed"><code class="code--embed"> var assert = require('assert');<br/>  describe('Basic Mocha String Test', function () {<br/>  it('should return number of characters in a string', function () {<br/>         assert.equal("Hello".length, 4);<br/>     });<br/>  it('should return first charachter of the string', function () {<br/>         assert.equal("Hello".charAt(0), 'H');<br/>     });<br/> });<br/> </code></p><p><strong>第八步:你可以回去查看你的package.json文件。它应该包括摩卡部分，应该是这样的:</strong></p><p class="w-embed"><code class="code--embed"> "scripts": {<br/>    "test": "mocha"<br/>  }<br/> </code></p><p><strong>步骤9:现在，运行测试。</strong></p><p>转到您的应用程序目录并运行以下命令:</p><p class="w-embed"><code class="code--embed"> npm test  </code></p><p>我的输出如下:</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>它失败了，因为运行Mocha时似乎出现了错误。你可以看到1失败了。</p><p>示例项目的源代码在这里共享<a href="https://github.com/pavanbelagatti/myapp">。</a></p><h2>Node.js应用程序的CI</h2><p>到目前为止，我们在本地测试了Node.js应用程序，这可以通过CI服务器自动完成。无人机CI是我们首选的CI平台，我们已经知道如何在本地运行。它是开源的，安装简单，只需几分钟。</p><p>如果你不知道如何在你的本地机器上设置一个无人机服务器，那么这里是我同事的一篇文章，它将帮助你<a href="https://dev.to/jimsheldon/run-your-own-drone-ci-4335">建立和运行你自己的无人机CI</a>。</p><p>每次开发人员将代码推送到应用程序的主分支时，使用像Drone这样的CI服务器可以帮助公司找到bug，并在错误到达客户之前纠正错误。</p><p>让我们继续下一步。</p><p><strong>第十步:将你的应用推送到GitHub。</strong></p><p>我们应该确保没有文件或存储库丢失。在我们的GitHub存储库中，我们仍然需要添加两个文件:</p><ol role="list"><li>. drone.yml作为无人机配置文件的一部分。通过在Git存储库的根目录中放置一个. drone.yml文件来配置管道。</li><li>作为构建管道中的一个步骤，构建并发布Docker映像。因此，添加一个简单的docker文件，因为它包含构建容器的指令。</li></ol><p>从节点:14-阿尔卑斯山</p><p>环境节点_环境开发</p><p>#添加工作目录</p><p>工作目录/应用程序</p><p>#缓存和安装依赖项</p><p>复制package.json。</p><p>运行npm安装</p><p>#复制应用程序文件</p><p>收到。。</p><p>#暴露端口</p><p>曝光3000</p><p>#启动应用程序</p><p>CMD [ "node "，" app.js" ]</p><p>. drone.yml文件如下所示:</p><p>种类:管道</p><p>类型:码头工人</p><p>名称:默认</p><p>‍</p><p>平台:</p><p>操作系统:linux</p><p>拱门:arm64</p><p>步骤:</p><p>-名称:测试</p><p>图像:节点</p><p>命令:</p><p>- npm安装</p><p>- npm测试</p><p>-姓名:码头工人</p><p>图片:插件/docker</p><p>设置:</p><p>#注册表:docker.io</p><p>回购:pavansa/myapp</p><p>用户名:</p><p>from _ secret:docker _用户名</p><p>密码:</p><p>发件人_秘密:docker _密码</p><p>标签:</p><p>-帕万人</p><p>通过在Git存储库的根目录中放置一个. drone.yml文件来配置管道。YAML语法旨在易于阅读和表达，以便任何查看存储库的人都能理解工作流。简单的节点示例见这里的<a href="https://docs.drone.io/pipeline/docker/examples/languages/node/">。</a></p><p><strong>步骤11:现在，让我们打开无人机仪表盘，同步我们的新回购。然后，我们用秘密激活它。</strong></p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><figure class="w-richtext-figure-type-image w-richtext-align-center"/><p>同步回购后，您应该会看到您的所有回购如下，并选择一个我们正在建设的。</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><p>下一步是通过添加秘密来激活存储库。</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><p>完成上述所有步骤后，选择NEW BUILD按钮，它将开始构建管道。</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>在这里，您将看到Drone通过构建代码并根据我们为应用程序代码指定的测试来测试它(记住，我们已经为我们的应用程序添加了一个普通的Mocha测试框架)。如果测试通过，那么它应该继续将新建的图像推送到我们在. drone.yml步骤中指定的DockerHub。</p><p>此外，如果测试失败，那么应用程序管道不应该构建，应该在那里停止。</p><p>让我们看看我们的建筑发生了什么。</p><p>‍</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>不出所料，管道在没有执行后续步骤的情况下发生了故障。您可以返回，纠正错误，无人机会自动运行管道。如果一切正常，那么它会如约将新的构建推送到Docker Hub。</p><p>‍</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><p>当一切都通过后，去检查你在. drone.yml中提到的Docker Hub repo，它应该已经把图像推送到那里了。这是我们用帕万语写的标签，你可以在这里看到:</p><figure class="w-richtext-figure-type-image w-richtext-align-fullwidth"/><p>‍</p><p>恭喜你！我们已经成功构建了一个简单的Node.js应用程序，添加了一个简单的Mocha测试，使用Drone做了CI，并将新图像推送到Docker Hub。</p><p>要了解Harness如何帮助您完成CI流程，请<a href="https://harness.io/demo">申请一个个性化演示</a>。</p><p>‍</p></div></div>    
</body>
</html>