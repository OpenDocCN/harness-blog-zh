# 功能标志策略治理教程|利用

> 原文：<https://www.harness.io/blog/feature-flags-policy-governance-tutorial>

在这篇文章中，我们将深入向您介绍特性标志的策略治理:架构、用例、可用数据等等。

[将策略作为代码](https://harness.io/blog/product-updates/introducing-harness-policy-engine/)，由开放策略代理(OPA)提供支持，允许您将策略编写为代码，以自动管理标记配置、使用和流程。策略应用于每个标志的创建、切换或修改，确保您的功能标志始终处于合规状态。

我们很自豪成为第一个支持此功能的功能管理解决方案。对于需要大规模执行标准的工程组织来说，功能标志的全球治理政策是一大胜利。它们允许在所有版本中设置护栏，以确保符合标准，并且它们还自动化了过程，因此开发人员的体验不会改变。开发人员只是在构建和测试阶段以他们习惯的方式得到错误消息。

但是这篇文章不是关于你为什么应该这么做，而是关于你如何去做。在这篇文章中，我们将深入讲解特性标志策略治理:架构、用例、可用数据等等。

## 体系结构

下面是我们如何确保您的标志始终保持合规状态的快速概述，无论用户进行了什么更改或他们决定如何进行更改。

1.  用户创建或更新特征标志。这可以通过我们允许的任何方式来改变标志:基于 UI、公共 API、git 同步或管道运行。这里重要的一点是，不管用户如何尝试进行更改，策略都会在后端执行，因此它们无法被绕过。
2.  我们的特征标志服务器计算新的临时标志状态，并将其发送到利用策略引擎。此标志数据和其他信息(如哪个用户在何时进行了更改)以及其他上下文数据将根据您组织的策略集进行评估，以确定更改是否合规。
3.  如果所有策略都成功，特征标志服务器将提交更改。如果不符合，更改将被拒绝，用户将被告知他们需要解决的任何问题。

## 撰写政策

利用策略引擎基于 [OPA](https://www.openpolicyagent.org/) ，这是一个易于使用、可扩展的解决方案，用于跨整个堆栈创建和实施策略。OPA 是一个被云本地计算基金会(CNCF)接受的开源项目，在众多软件交付用例中被广泛采用。在减压阀，策略是以声明性代码的形式编写的，因此它们易于理解和修改——从简单的用例到复杂的用例。

你可以在官方 [OPA 文档](https://www.openpolicyagent.org/docs/latest/policy-language/)中找到更多关于编写减压阀规则的信息。

一旦您准备好发布一个策略，您就可以编写自己的策略并将其添加到 Harness。我们还为常见用例提供了一些现成的策略，比如强制命名约定和确保代码的正确升级。

## 哪些数据可用于编写策略？

我们知道，策略不仅与所讨论的变更实体相关，还可能依赖于上下文数据，例如谁在何时进行了变更。为了支持这些用例，我们向策略引擎提供了不断增长的数据集合，您可以在编写策略时使用这些数据。这包括:

*   创建/更新标志的完整功能标志配置。这包括标志名称、描述、变体、规则、每个环境中的标志状态等等。这是 json 格式的，这与我们的[公共 API 文档](https://harness.io/docs/api/tag/Feature-Flags#operation/GetFeatureFlag)的格式相匹配，所以如果你已经将你的标志作为代码进行了交互，这将是非常熟悉的。
*   哪个用户进行了更改，他们拥有哪些 RBAC 权限，以及他们属于哪些用户组。
*   何时进行了更改。

下面是发送给策略引擎的元数据的一个截断示例

`{
"flag": {
"createdAt": 1650618223270,
"defaultOffVariation": "false",
"defaultOnVariation": "true",
"envProperties": [
...environment states and rules go here
],
"identifier": "my_flag",
"kind": "boolean",
"name": "my_flag",
"prerequisites": [],
"project": "my_project",
"variations": [
{
"identifier": "true",
"name": "True",
"value": "true"
},
{
"identifier": "false",
"name": "False",
"value": "false"
}
]
},
"metadata": {
"action": "onsave",
"roleAssignmentMetadata": [
...User RBAC data goes here
],
"timestamp": 1654681128,
"type": "flag",
"user": {
...User account metadata goes here
},
"userGroups": []
}
}` 

## 调试策略

策略是以代码形式编写的，任何编写代码的人都知道，在优化策略时，不可避免地会有许多边缘情况或错误场景需要测试。仅仅为了测试您的策略，就必须以特殊的方式创建和配置标志，这既令人沮丧又耗时。为此，我们在 UI 中内置了一个集成的策略测试器/调试器。

使用这个调试器，您可以完成一个标准的开发过程:

*   **制定:**首先在主文本区写下您的政策。添加尽可能多的规则和辅助函数。
*   测试:使用测试终端，您可以快速获得关于您正在构建的新策略是否达到预期效果的反馈。您可以点击“选择输入”按钮，用您自己项目中的真实标志数据填充输入字段，为您的用例提供可靠和真实的测试场景。然后，您可以点击“测试”按钮来运行策略，并查看给定的数据输入是成功还是失败。如果您想手工制作特定的边缘案例，也可以手动编辑这些输入数据。
*   调试:一旦你的策略被强制执行，可能会有一段时间用户不确定为什么更改被阻止了。如果你得到的只是一个模糊的错误信息，比如“禁止更改”，这可能是一个令人沮丧的经历幸运的是，我们为用户提供了所有工具来查看关于哪些策略失败的详细信息，以及单击这些策略并进入调试器模式的能力，从而查看策略及其更改所产生的确切输入。这将有助于他们验证这是一个有效的拒绝，还是策略本身需要进一步修改。

## 用例

利用策略引擎支持广泛的用例。从检查描述字段是否已正确完成的简单健全性检查，到防止封锁期内发生更改的复杂公司政策，不一而足。功能标志策略大致分为以下两类:

### 标志配置

*   命名惯例，例如旗帜名称必须与 jira 门票格式相匹配
*   强制性描述
*   仅允许创建布尔标志(无多变量)
*   禁止某些功能，例如不允许先决条件规则
*   特定目标规则的最大数量

### 变更管理

*   除非先在 QA 中启用，否则无法在生产中启用标志
*   必须通过具有批准步骤的管道进行标记更改
*   在某些时间段内没有变化，例如测试运行时或某些强制封锁期
*   创建标志的同一用户不能启用标志

你可以在你需要执行的规则上尽情发挥创造力。在如何创建和组合这些规则的问题上，我们特意没有采用固执己见的基于 UI 向导的方法，因此您可以自由地进行试验，从小处着手，并管理对您来说重要的事情。

## 我能在哪里试用它？

要了解更多关于 Harness 如何管理策略的信息，请查看我们的[特性标志文档的策略概述](https://ngdocs.harness.io/article/4vx27jqwv2-harness-policy-engine)，或者[今天就注册](https://app.harness.io/auth/#/signup/?module=cf)免费试用特性标志。

‍