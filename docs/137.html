<html>
<head>
<title>Vulnerability Scanning in your CI/CD Pipeline - Part Two | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>CI/CD管道中的漏洞扫描-第二部分|利用</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/automated-vulnerability-scanning-ci-cd-pipeline#0001-01-01">https://www.harness.io/blog/automated-vulnerability-scanning-ci-cd-pipeline#0001-01-01</a></blockquote><div><p>继续本系列的第一部分，我们将利用Harness平台在您的CI/CD管道中进一步实施漏洞扫描。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>在您的部署管道中实现DevSecOps实践是一个谨慎的举措。有句谚语说软件组件像牛奶而不是葡萄酒一样老化，这是非常正确的。DevSecOps领域的一家供应商Sonatype 推出了广受欢迎的Nexus IQ平台，用于漏洞扫描。</p><p>继续本系列的第一部分，我们将利用Harness平台在您的<a href="https://harness.io/blog/ci-cd-pipeline//" target="_blank"> CI/CD管道</a>中进一步实施漏洞扫描。该示例希望将<a href="https://owasp.org/www-project-webgoat/"> OWASP的WebGoat </a> Docker映像部署到一个Kubernetes集群中，并解释扫描结果，以便在符合要求的情况下进行部署。</p><figure class="w-richtext-figure-type- "/><p>像往常一样，可以跟随博客和/或视频。所有的资产都在一个<a href="https://github.com/ravilach/sonatype-harness" target="_blank"> GitHub仓库</a>中。</p><h2>利用Harness实施漏洞扫描</h2><p>对于第一遍，到目前为止，显示可以调用Nexus IQ，而不会出现线束问题。但是如果将它扩展到一个组织，还需要几个步骤。</p><p>从扫描的角度来看，将在Harness Secrets Manager中屏蔽Nexus凭据，然后在提交和解释扫描之前提示用户输入一些详细信息。</p><p>要为Nexus IQ用户和密码添加一对秘密，请利用<a href="https://docs.harness.io/article/au38zpufhr-secret-management" target="_blank"> Harness Secrets Manager </a>。</p><p>安全-&gt;机密管理-&gt;机密-&gt;加密文本+添加加密文本</p><p>名称:nexusiq _用户</p><p>值:管理员</p><figure class="w-richtext-figure-type- "/><p>单击提交后，添加另一个密码。</p><p>名称:nexusiq_password</p><p>值:admin123</p><figure class="w-richtext-figure-type- "/><p>添加了秘密之后，您可以利用<a href="https://docs.harness.io/article/766iheu1bk-add-workflow-variables-new-template" target="_blank">工作流变量</a>来提示用户输入某些参数。</p><p>设置-&gt; Webgoat -&gt;工作流-&gt;扫描工件。在右侧，点击"&gt;工作流变量"</p><figure class="w-richtext-figure-type- "/><p>点击工作流变量旁边的铅笔，进行+添加。</p><figure class="w-richtext-figure-type- "/><p>例如，我们可以提示用户输入Nexus IQ应用程序ID，以便扫描与正确的规则集相关联，等等。对于这个例子，我们只添加了一个变量，这是对所有输入进行参数化的艺术。</p><p>变量名:nexusiqappid</p><p>类型:文本</p><p>默认值:web goat-应用程序</p><figure class="w-richtext-figure-type- "/><p>单击“保存”后，您将看到工作流变量已填充。</p><figure class="w-richtext-figure-type- "/><p>使用Harness，您可以使用语法$ { Secrets . get vaule(" secret _ name ")}引用<a href="https://docs.harness.io/article/ygyvp998mu-use-encrypted-text-secrets#step_4_reference_the_encrypted_text" target="_blank">机密</a>，并使用${workflow.variables.name}访问<a href="https://docs.harness.io/article/766iheu1bk-add-workflow-variables-new-template" target="_blank">工作流变量</a>。</p><p>使用以下更新来更新Shell脚本。</p><p>设置-&gt; Webgoat -&gt;工作流-&gt;扫描工件-&gt; Shell脚本</p><p>#下载扫描模板<br/>mkdir-p ~/nexus-scans<br/>CD ~/nexus-scans<br/>sudo docker pull web goat/web goat-8.0<br/>sudo docker save web goat/web goat-8.0:最新&gt;webgoat-8.0.tar<br/>Java-jar ~/nexus-CLI/nexus-IQ-CLI . jar-I $ { workflow . variables . nexusiqappid }-s http://&lt;public _ IP&gt;:8077</p><figure class="w-richtext-figure-type- "/><p>单击提交，您的更改已保存。您可以运行另一个部署来验证所做的更改。在工作流的右上角，单击部署。</p><figure class="w-richtext-figure-type- "/><p>点击提交，你将运行一个更具操作性的扫描方式。</p><figure class="w-richtext-figure-type- "/><p>一旦我们有了扫描数据，下一步就是解释结果，然后进行部署。我们可以生成另一对线束工作流(我们稍后将在<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#pipelines" target="_blank">线束管道</a>中缝合在一起)来收集结果。</p><p>创建新的工作流来解释扫描结果。</p><p>设置-&gt; Webgoat -&gt;工作流+添加工作流。</p><p>名称:解释扫描</p><p>工作流类型:滚动部署</p><p>环境:Nexus IQ服务器</p><p>服务:Nexus IQ外壳</p><p>基础设施定义:Nexus IQ CentOS</p><figure class="w-richtext-figure-type- "/><p>点击Submit后，创建一个工作流来部署Webgoat。您将很快回来并填写扫描解释的详细信息。</p><p>设置-&gt; Webgoat -&gt;工作流+添加工作流</p><p>名称:部署Webgoat</p><p>工作流类型:滚动部署</p><p>环境:Webgoat农场</p><p>服务:Webgoat</p><p>基础设施定义:Goat K8s集群</p><figure class="w-richtext-figure-type- "/><p>点击提交并返回工作流程列表后，您将看到三个线束工作流程。</p><p>下一步是构建某种解释逻辑来解析扫描结果。</p><figure class="w-richtext-figure-type- "/><p>下一步是将shell脚本添加到解释扫描工作流中。</p><h2>以编程方式解释扫描结果</h2><p>自动化DevSecOps实践的一部分是在扫描中发现违规漏洞时影响部署。目前，Nexus IQ和Harness之间没有本机集成，但可以通过几个cURL命令访问和解析扫描结果。</p><p>需要的命令是获取内部Nexus IQ应用程序ID、报告ID，并对报告中的违规进行计数。如果存在严重违规，请停止部署。</p><p>要开始构建它，回到解释Scan并添加一个工作流变量，然后在部署步骤中添加一个shell脚本，类似于<a href="https://harness.io/blog/featured/vulnerability-scanning-ci-cd-pipeline/" target="_blank">第一部分</a>。</p><p>设置-&gt; Webgoat -&gt;工作流-&gt;解释扫描</p><figure class="w-richtext-figure-type- "/><p>要添加的第一项是一个工作流变量，用于提示在Nexus IQ 中违反<a href="https://help.sonatype.com/iqserver/managing/policy-management#PolicyManagement-GettingStartedwithPolicies" target="_blank">策略的严重程度，以停止部署。</a></p><p>单击工作流变量下的铅笔图标。</p><p>变量名:minfailpoilcyviolation</p><p>类型:数量</p><p>允许的值:5，6，7，8，9</p><p>默认值:7</p><p>必填:真</p><figure class="w-richtext-figure-type- "/><p>单击保存后，您可以在解释扫描工作流中的部署服务下添加shell脚本。</p><figure class="w-richtext-figure-type- "/><p>在添加步骤UI中，搜索shell并添加Shell脚本。单击下一步。</p><figure class="w-richtext-figure-type- "/><p>假设您的用户/密码仍在第一部分的线束密码管理器中，在配置Shell脚本提示符下，输入以下内容:</p><p>名称:Shell脚本</p><p>类型:Bash</p><p>超时:5m</p><p>代表选择器:NexusIQScan</p><p>脚本:</p><p>#解释扫描结果-模板<br/> echo“解释扫描结果”<br/><br/># Get AppID<br/>export AppID = $(curl-u $ { secrets . getvalue(" nexusiq _ user "))}:$ { secrets . getvalue(" nexusiq _ password ")}-X Get ' http:/&lt;public _ IP&gt;:8070/API/v2/applications？public id = web goat-应用程序“| jq”。应用程序[0]。id ' | tr-d ' " ')<br/>echo " AppID:" $ AppID<br/><br/># Get Report IDs<br/>export Report id = $(curl-u $ { secrets . getvalue(" nexusiq _ user ")}:$ { secrets . getvalue(" nexusiq _ password ")}-X Get ' http://&lt;public _ IP&gt;:8070/API/v2/reports/applications/' $ AppID ' ' | jq '。[0] .reportDataUrl ' | cut-d '/'-f 6)<br/>echo " report id:" $ report id<br/><br/># Get违例计数<br/>export total violations = $(curl-u $ { secrets . getvalue(" nexusiq _ user "))}:$ { secrets . getvalue(" nexusiq _ password ")}-X Get " http://&lt;public _ IP&gt;:8070/API/v2/applications/webgoat-application/reports/" $ report id "/policy " | jq '。组件[]。违规[]。policyThreatLevel ' | grep-c '[$ { workflow . variables . minfailpoilcyviolation }-9]')<br/>echo " Total Sev Violations:" $ Total Violations<br/><br/>" # Exit if Violations Match<br/>if[[$ Total Violations-gt 0]]；然后<br/>回显“违反阻止部署”<br/>出口1 <br/>否则<br/>回显“向前推进部署”<br/>出口0 <br/> fi</p><figure class="w-richtext-figure-type- "/><p>点击Submit，您的Shell和工作流变量应该会出现。你可以随意修改这个脚本，它是基于<a href="https://help.sonatype.com/iqserver/automating/rest-apis/report-related-rest-apis---v2#Report-relatedRESTAPIs-v2-PolicyViolationsbyReportRESTAPI(v2)" target="_blank"> Nexus IQ REST API </a>的。</p><figure class="w-richtext-figure-type- "/><p>下一步是将所有的工作流程整合到一个线束管道中。</p><h2>自动化CI/CD开发人员管道-带线束</h2><p>到目前为止，我们的三个独立的工作流是相互独立运行的。通过利用<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#pipelines" target="_blank">线束管道</a>，您可以将三个工作流缝合在一起。</p><p>设置-&gt; Webgoat -&gt;管道+添加管道。将其命名为“DevSecOps”。</p><figure class="w-richtext-figure-type- "/><p>点击提交后，添加与每个工作流相对应的管道阶段。</p><figure class="w-richtext-figure-type- "/><p>一旦你点击+添加，第一步将是扫描工件。</p><p>执行工作流:扫描工件</p><figure class="w-richtext-figure-type- "/><p>点击Submit后，以类似的方式浏览并添加解释和部署步骤。</p><figure class="w-richtext-figure-type- "/><p>点击两个额外的阶段。首先，添加解释器。</p><figure class="w-richtext-figure-type- "/><p>然后，添加部署。</p><figure class="w-richtext-figure-type- "/><p>在部署阶段点击提交后，您的管道将有三个阶段。</p><figure class="w-richtext-figure-type- "/><p>现在，您已经准备好运行您的管道，并看到您的劳动成果。</p><h2>运行您的第一个自动化DevSecOps管道</h2><p>有几种方法可以利用管线。导航至左侧导航，并选择持续部署。</p><p>连续部署-&gt;部署-&gt;开始新的部署</p><p>选择Webgoat的标签[最新]并点击提交。</p><figure class="w-richtext-figure-type- "/><p>一旦点击了Submit，您就可以看到您的第一个自动化DevSecOps管道运行了。不出所料，管道会失败，因为Webgoat有很多违规行为。</p><figure class="w-richtext-figure-type- "/><p>看看Nexus IQ报告，你会发现威胁确实存在。</p><p>http:// <public_ip> :8070 -&gt;报表-&gt; Webgoat -&gt;查看报表</public_ip></p><figure class="w-richtext-figure-type- "/><h2>Harness，您在DevSecOps的合作伙伴</h2><p>无论您在DevSecOps的旅程中处于哪个阶段，Harness都会与您携手合作。应用程序安全测试方法正在发展，更多的项目转向开发人员和自助服务。在您的管道中加入DevSecOps步骤是一个谨慎的举动。感谢您观看这两部分的系列，并确保今天就注册<a href="https://www.sonatype.com/nexus/lifecycle-demo" target="_blank"> Sonatype Nexus IQ试用</a>和<a href="https://harness.io/free-trial/" target="_blank">线束账户</a>！</p><p>干杯，</p><p>拉维</p></div></div>    
</body>
</html>