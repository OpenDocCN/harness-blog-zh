# 深入:线束特征标志继电器代理|线束

> 原文：<https://www.harness.io/blog/in-depth-feature-flags-relay-proxy>

在这篇文章中，我们将深入讲解标志中继代理的所有特性:架构、缓存、你是否应该使用它等等。

中继代理是一个轻量级的 Go 应用程序，它运行在您的基础设施中，处理所有到 Harness 平台的流连接。它在启动时获取所有的标志、目标和目标组数据，缓存这些数据，随时间获取任何更新，并将其提供给连接的下游 SDK。

不是每个客户端/服务器都直接连接到 Harness 平台并传输更改，而是直接连接到您安装的代理来接收任何标志更新。代理可以支持您的帐户跨不同项目连接到多个环境，使其成为直接连接的 1:1 替代方案。

## 体系结构

### 标准部署

直接连接到 Harness 而不安装代理是大多数客户将使用的默认选项。

所有 SDK 都直接连接到线束平台。对于基础设施中的服务器，这意味着允许每个服务器的出站连接，使用客户端 SDK 的客户(例如，通过移动应用程序)将从 Harness 获取他们的标志。

### 代理部署

所有 SDK 将从您内部部署的代理服务器获取标志。只有这个代理服务器需要与 Harness 进行出站通信。基础设施中的服务器 SDK 不需要任何出站连接。您的网络防火墙规则需要允许客户端 SDK 访问代理。

## 该不该用？

该代理可用于帮助特定的用例。它可能不适合较小的客户或所有配置。您应该在头脑中有一个您希望解决的有价值的用例，否则您最好从标准连接模型开始您的旅程。

以下是在您的设置中可能证明是值得的一些优势(以及其他优势):

1.  减少网络流量/连接

在标准配置中，您运行的每个 SDK 实例都将访问 Harness 平台以获取所有初始标志数据，然后维护一个流连接以接收您对该环境所做的任何更新。

根据您的架构，这可能意味着您的网络中有数十台、数百台甚至数千台服务器，每台服务器都维护一个出站连接并接收完全相同的数据更新。它还要求每台服务器都能够与外界联系，出于配置或安全原因，这在您的设置中可能不可行。

使用代理，您只需要一台服务器连接到 Harness，所有 SDK 流量完全保留在您自己的数据中心内部。

2.  客户端不需要将线束列入白名单

如果您的客户运行具有非常严格的安全要求的客户端 SDK，他们可能不允许您的应用程序打开第三方连接。

代理可以通过在您自己的环境中运行并利用您的服务所属的任何现有白名单规则来解决这个问题。

3.  高可用性

对于我们的大多数客户来说，标准功能标志配置有足够的安全措施来维护他们需要的所有可用性。其中包括:

*   [高正常运行时间](https://status.harness.io/)；
*   在连接丢失的情况下，客户端/服务器 SDK 缓存值；
*   服务器 SDK 将值存储到磁盘，以防它们在没有可用连接的情况下重新启动；
*   能够在启动时没有缓存或连接的最坏情况下定义合理的默认值。

然而，如果您需要更多(或者有减少外部依赖性的要求)，安装中继代理可能是理想的。代理缓存所有环境的所有标志、目标和目标组数据。这意味着，如果您由于停机、防火墙问题或任何其他原因失去了与 Harness 平台的连接，所有现有的和新启动的客户端和服务器 SDK 将始终继续获得最新的数据。

更好的是，一旦连接问题得到解决，代理将自动重新连接到每个环境，获取它错过的任何更新，并继续正常工作。

## 这要花多少钱？

安装和运行代理不需要额外付费。

也就是说，您将承担与在您的环境中运行该额外服务器相关的所有运营成本和体系结构复杂性。这包括托管，以及设置、配置、监控和优化额外服务所需的时间。

这种成本优势对更大或更注重安全的客户(政府、医疗、金融科技等)更具吸引力。)比寻求开始使用功能标记的小型企业要多。

## 我能过会儿改变吗？

是的。如果您有任何疑问，我们建议从使用标准部署开始您的旅程，然后迁移到代理服务器，如果它对您的用例有好处的话。

如果您决定在以后的旅程中安装代理，那么您的客户机和服务器 SDK 所需要的唯一更改完全是基于配置的。SDK 可以与您的代理服务器通信，而不是与 Harness 服务器通信，您当前依赖的所有其他功能保持不变。

例如，下面是迁移 Golang SDK 实例以使用代理所需的更改。

//直接与线束
客户端通信，err := harness。NewCfClient(sdkKey)

//与你的代理服务器
客户端通信，err := harness。NewCfClient(sdkKey，harness。WithURL(MY_PROXY_URL))

这也不一定是大爆炸式的迁移。您可以随意安装代理，并通过它运行一些客户机/服务器，而其余的则直接与 Harness 通信，这样您就可以逐步推广它，并评估其好处是否值得您的设置花费。

## 有哪些缓存选项可用？

### 在记忆中

默认情况下，代理将在内存中缓存标志数据。这对于试用期可能很有用，但不建议用于生产部署。在与 Harness 建立连接并完成第一次同步之前，代理在重启时无法访问任何标志数据。

### 雷迪斯

Redis 支持作为缓存数据的持久性存储，并且是推荐的选项。当代理重新启动时，它将立即访问最新数据，同时等待同步完成。

## 我能在哪里试用它？

我们很高兴你能升级你的特色旗帜游戏！关于我们如何做特征标志的更多信息，看一下我们如何为规模下的[性能设计特征标志。](https://harness.io/blog/architecting-feature-flags-performance/)