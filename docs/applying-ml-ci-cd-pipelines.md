# 将 AI/ML 应用于 CI/CD 管道|线束

> 原文：<https://www.harness.io/blog/applying-ml-ci-cd-pipelines>

有兴趣把你的部署金丝雀变成有 AI/ML 的控制论生命体？太棒了，这个博客是给你的。我猜你现在可能在想两件事:

*   为什么要将 AI/ML 应用于 CD？
*   实际上如何将 AI/ML 应用于 CD？

让我们浏览一个典型的部署管道:

1.  写代码
2.  提交代码
3.  构建工件
4.  测试工件
5.  部署工件
6.  验证工件
7.  回滚工件

现在，大多数组织都在使用他们的 CD 流程/平台来自动化步骤 1 到 5。对于大多数人来说，CD 停止在部署阶段，这意味着一个新的工件投入生产的时刻。我们可以争论这应该被称为连续交付还是以后的部署:)

然而，如何理解这些生产部署的实际业务影响呢？让我们具体考虑一下上面的第 6 步和第 7 步。如果我们可以使用机器学习来自动化这些步骤，会怎么样？

## 了解部署的业务影响

如果 DevOps 和 CD 是关于尽快从 idea 到“cha-ching”的，那么我们不应该衡量 cha-ching 部分吗？信不信由你，部署速度并不是成功的真正晴雨表(尽管事实上感觉很好)。我总是惊讶于有多少与会者声称每天有数千个部署，但很少有人对他们的更改/修复/补丁的影响有任何了解。您如何知道您是否向客户部署了许多好的/坏的想法或变化？

在 Harness，我们将步骤 6 和 7 [称为连续验证](https://harness.io/platform/continuous-delivery/continuous-verification/)，我们使用无监督的机器学习来自动化这些步骤。

## AI/ML 101

在我深入研究 Harness 如何将 ML 应用于 CD 之前，让我们了解一些 ML 基础知识。ML 是人工智能(AI)的一种形式，有两种风格:

1.  监督
2.  无人监督的

**监督**通常要求人类通过提供参数、反馈或标签来训练 AI/ML 算法和模型。例如，阈值、评级、规则、设置和配置等都是参数/反馈的类型，算法可以使用它们来随着时间的推移变得更加准确。你可能还会听到像“神经反馈”这样的流行语，它仅仅意味着从人类那里寻求反馈。

**无监督**是指 AI/ML 算法及其模型可以自行从数据中推断出意义和关系，而不需要人类的帮助或干预。它基本上是即插即用的——你提供数据，ML 会自己解决问题。

代价是有监督的更准确，但通常需要大量的培训和维护，而无监督的不太准确，但也很容易上手。因此，有监督和无监督的优势和价值在应用的用例和数据集上有很大不同。

## AI 和 ML 在连续交付中的应用

为了验证任何生产部署的影响，我们首先需要理解(并测量)与应用程序相关的几个 KPI。以下是一些 KPI 示例:

*   **业务** - $收入、订单量、订单吞吐量
*   **性能&可用性** -响应时间、吞吐量、停机时间、正常运行时间
*   **资源** - CPU、内存、I/O
*   **质量** -事件、异常和错误

幸运的是，几乎所有这些数据都可供 CD 平台利用，例如:

*   **应用性能监控(APM)** - AppDynamics、New Relic、Dynatrace
*   **基础设施监控** - Datadog、CloudWatch & Nagios
*   **日志监控** - Splunk、ELK & Sumo 逻辑
*   **AIOps/ITOA**-穆格软&大熊猫
*   **人工合成** -硒

如今，大多数应用程序都有自己的健康检查页面，其中一些简单的 HTTP 断言可以返回各种 KPI。

在 Harness，我们基本上已经构建了连接器/webhooks，它们与上面的许多工具集集成在一起，以观察每个生产部署之后的所有应用 KPI、数据和指标。然后，我们使用无监督的机器学习来自动分析来自这些来源的所有时间序列指标和事件数据。这种分析允许 Harness 自动验证生产部署，并识别任何可能引入的回归、异常或故障。这是很酷的东西。

那么，所有这些花哨的裤子 ML 实际上是什么样子的呢？下面是部署管道的实际情况:

使用 Harness，您可以使用一个或多个验证源来验证生产部署，而不管数据是时序指标、非结构化事件还是简单的 HTTP 断言。在上面的示例中，Splunk 和 AppDynamics 都用于验证部署。

## 检测性能退化

没有什么比缓慢的应用程序更糟糕的了，所以在部署后验证性能是显而易见的。Build.com 最近告诉我们，他们的 6-7 名团队领导在每次部署时会花费至少 60 分钟，使用 New Relic 手动验证他们的应用程序性能。对于一周 3 个生产版本，需要将近 21 个小时的人工工作来验证生产部署。将 ML 应用到这个过程中[将这个工作减少到仅仅 3 个小时](https://harness.io/customers/case-studies/automated-ci-cd-rollback/)，工作量减少了 85%。

下面是一个线束截图，显示了将无监督机器学习(SAX & Markov)应用于监视应用程序的 AppDynamics 数据集的输出。您可以看到，ML 已经确定了与关键业务交易相关的 3 个绩效回归:

如果我们将鼠标悬停在这些回归上，我们可以看到为什么 ML 算法会标记这些异常:

如你所见，**请求登录**的响应时间从 31 毫秒增加到了 165 毫秒。ML 的伟大之处在于算法是实时执行的，所以你获得的洞察力几乎是即时的。ML 没有内脏的感觉；一切都是可以测量和量化的。在这种情况下，ML 可以量化每个生产部署的确切业务影响。在 Harness，我们甚至有几个电子商务客户使用$ revenue 作为 KPI 来验证部署和启动回滚。

## 检测质量退化

没有可靠性的性能什么都不是。在部署后密切关注应用程序事件、异常和错误是至关重要的。目前的一个主要挑战是，大多数应用程序控制台和日志都充满了像类路径异常这样的垃圾。更糟糕的是，这些异常中的大多数已经存在多年，并且是噪声的主要来源。实际上，你可以将机器学习应用于这个问题，以了解哪些事件是良性的，哪些事件是新的、独特的，以及对你的应用程序和业务来说是异常的。
Harness 将来自日志工具的事件数据标记化，并应用多种无人监管的机器 ML 算法，如熵、Kmeans 聚类、Jacard 和余弦，以了解您的应用程序在部署后生成的事件的相关性、唯一性和频率。

在下面的示例中，Harness 使用 Splunk 通过分析来自应用程序的日志事件数据来持续验证应用程序质量。Harness Kmeans 算法构建相关事件数据的“集群”。灰点代表基线事件，利用算法学习并推断为每个生产部署中发生的“正常”事件。红点代表 Harness 第一次遇到的未知事件或新事件，或者代表出现频率异常的事件。

这个例子实际上取自一个客户生产部署，其中一名开发人员意外地使用了分号而不是冒号。正如您所看到的，部署引入了几十个新的异常回归，并导致 Harness 执行自动回滚(如果您想要更多的控制，Harness 还允许手动回滚)。

## 监督无监督的机器学习

提高机器学习算法和模型准确性的一种方法是向它们提供人类反馈(监督)。无监督的 ML 不是一颗银弹，越多的人参与反馈循环，结果就变得越聪明和准确。

完全有可能的是，Harness 可能会将某些应用程序事件/异常标记为异常，而开发人员可能会认为这些事件/异常是正常的/不有趣的。在这种情况下，您希望允许这些开发人员提供反馈。

在上面的 Splunk 示例中，单击图表中的任何红点都会显示导致回归的确切事件/异常:

注意该事件右上角的“忽略”和“消除”控件。这些允许开发者要么暂时忽略事件，要么永久地将它们从 ML 算法的未来分析中排除。随着时间的推移，开发人员可以训练 Harness，使其只标记真正独特、异常和相关的事件/异常。

## 智能自动回滚？

使用 ML 来帮助和验证生产部署将很快成为新的规范。过去需要几个人花 60 分钟才能完成的工作，现在用机器一两分钟就能完成。实际上，我们可以将这种智能向前推进一步，开始用它做一些事情，比如自动回滚。这就形成了一个真正自动化的部署管道，可以部署、验证和恢复它观察到的任何异常或故障。想了解更多关于我们的 AI/ML 能力吗？[今天就预订您的演示](https://harness.io/demo/)。