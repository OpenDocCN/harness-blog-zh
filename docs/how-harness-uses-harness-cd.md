# Harness 如何使用 Harness CD？装具

> 原文：<https://www.harness.io/blog/how-harness-uses-harness-cd>

Dogfooding 在其最佳状态:这里是如何利用马具利用马具光盘！了解关于我们的 CI 和 CD 设置的所有信息，以及我们在 CD 上投入如此之多的原因。

连续交付(CD)是在构建、测试、配置和部署所有类型变更的软件开发过程中遵循的实践。这包括新特性、配置更改、错误修复和实验。此外，这些从开发人员的工作站开始，经过多个非生产环境，最后以连续的方式到达组织的生产环境。在本帖中，我们将探究[什么是 CD](https://harness.io/blog/what-is-continuous-delivery/)，以及 Harness 如何使用 Harness CD。没错，我们在 Harness 喝自己的香槟。让我们告诉你怎么做！

## 持续交付涉及哪些主要组件？

CD 涉及到很多组件。以下是四种主要的方法:

1.  持续集成(CI):CD 过程的第一步是 CI。在开发人员的工作站上开发的代码被不断地提交到版本控制存储库中，并且它自动地开始了它在整个管道中的旅程。

2.  非生产环境(NPE):npe 是在内部建立的环境，只有内部员工和 beta 用户可以访问。在客户展示之前，所有类型的多维测试都在这些环境中完成。请注意，管道中的每个进展环境都应该变得更像公司的生产环境。

3.  分支策略:CD 就像在版本控制系统中加入新的变化一样好(VCS)。不同的团队要能做流畅的操作，比如推到一个分支，或者在本地拉一个稳定的分支开始开发。

4.  反馈循环:软件开发管道中的每个步骤/阶段都应该有一个反馈循环来陈述每个步骤/阶段的结果。

## Harness 如何使用 Harness CD？

一个人怎么能体验别人正在经历的事情？你必须站在他们的角度去体验。“要体验你的客户正在体验的，首先做你自己的客户，像你期望客户使用你的产品一样使用它。

在 Harness，我们使用 Harness 产品在所有环境(预 QA、QA、阶段和生产)中构建、测试和部署 Harness。从本质上说，我们是在试探自己，看看我们的产品在实时场景中表现如何。

以下是 Harness 在内部建立的工作流和环境，用于构建、测试和部署 Harness 服务。

### CI 设置

拉请求工作流:这是 CD 的开始。每个开发人员在他们各自本地分支的工作站中开发代码，将他们的更改推送到 GitHub，并在 GitHub 中针对 **develop** 分支创建 pull 请求。在 Harness 中，使用 GitHub 连接器将 GitHub 与 Harness CIE 集成，其中多重检查被配置为针对**开发**分支创建的每个 PR 请求运行。

一旦 PR 被提出，一系列作业/管道在 Harness CIE 中运行，并向 GitHub 报告状态。如果所有的作业/管道都成功执行，那么 GitHub 会将 PR 标记为绿色，PR 准备合并到**开发**分支。

### CD 设置

以可能的最佳方式将服务部署到 Kubernetes。最少的临时看护意味着部署也可以快速部署。因此，作为对**开发**分支的代码合并/拉取请求的一部分，开发人员使用 Harness CIE 将他们的服务构建到 Docker 映像中，并使用 PR env 设置。这是一个 GKE 集群，开发人员在其中部署单独的服务，作为单独测试的一部分。

这样做是为了在 Google Kubernetes 集群中测试和部署他们的服务。一旦在 PR env 中测试了更改，开发人员就将代码推送到**开发**分支，并将服务使用的配置推送到配置存储库。

### 非生产环境

#### 前期质量保证

一旦在 PR env 中测试了服务，那么配置就会从配置存储库中的主分支进行更改。接下来，它被应用于 QA 前环境，其中来自不同团队的服务每隔 6-8 小时被部署一次。此外，自动化套件在这种环境下运行，结果会相应地生成并发布到各种 slack 通道。

#### 质量保证

这是另一个使用 Harness CD 的环境设置，它运行更主动的自动化套件。此外，压力测试也是在这种环境下进行的。这个环境几乎与 PROD env 相同，整个设置经过了多维度的测试，以确保一切正常，没有安全漏洞，并且二进制文件在多种情况下都是稳定的。

#### 阶段

这是一个内部安装版本，不同于 Harness 应用程序的 SaaS 版本。该环境包含多个部署管道，用于将 Harness 服务部署到 QA 和 PROD 环境。应用于此环境的 RBAC 确保除了相关团队成员之外，没有人能够访问任何部署管道。

## 为什么 Harness 加大了对 CD 的投资？

CD 确保什么是真正完成和测试的。此外，CD 可以为采用这些实践的每个公司带来许多好处:

1.全面测试:CD 使开发人员能够测试他们的更改，而不仅仅是单元测试，这样他们就可以在部署到生产服务器之前跨多个维度验证他们的更改。

2.更快的反馈:CD 降低了部署软件的风险，因为您的代码在多个环境中得到验证，并且每个环境都提供反馈。

3.可部署就绪:CD 让您确保您的主要/主分支将始终保持可部署就绪。从每个提交/变更中部署发布是可能的。

4.容易调试:在出现任何中断的情况下，要调试的区域会少很多，因为你是以小块的形式发布软件，而不是连续地以大块的形式发布。

5.发布频率:让我们看看每个公司从过去 10-15 年到今天的发布趋势。发布周期大约是每几个月一次，而现在至少是每周两次。发布的频率急剧增加。每个人都希望尽快推出更新，以保持竞争优势。如果没有 CD，这种快速的发布频率将成为应用和运营团队的瓶颈。手动过程导致不可靠的发布，产生延迟和错误。

6.透明性:CD 管道中涉及到的每一段要设置的脚本都会被仔细检查。因此，每个人都知道对 CD 管道所做的更改，没有个人设置可以传递到管道/作业。

## 结论

如果你真的想体验你的顾客在使用你的产品时所面临的情况，就做你自己的顾客(BYOC)。使用 Harness 来构建、测试和部署 Harness 使这里的每个人都能在 bug 到达客户之前找到它们。此外，它使每个人都能够为寻找产品中的差距做出贡献，这导致了线束中的功能开发。最后但同样重要的是，它还改善了用户体验。

我们希望您继续阅读我们如何使用自己的产品。这里有一篇关于我们从 [Jenkins 到驾驭 CIE](https://harness.io/blog/jenkins-to-cie-journey/) 的迁移的文章。