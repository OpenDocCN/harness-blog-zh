<html>
<head>
<title>Automated DevSecOps with StackHawk and Harness | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>带堆栈和线束的自动化开发工具|线束</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/automated-devsecops#0001-01-01">https://www.harness.io/blog/automated-devsecops#0001-01-01</a></blockquote><div><p>在本例中，我们将在将应用程序部署到Kubernetes之前扫描应用程序。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>DevSecOps运动就是左移；授权开发团队做出更卫生的决策。随着工程团队创建变更/功能的步伐和速度，在过去的日子里，安全性可能被视为SDLC中的事后想法。今天，现代团队和组织试图在整个开发过程中传播应用程序安全专业知识。</p><p>StackHawk平台旨在为您的CI/CD管道带来动态应用安全测试(DAST)。DAST工具通常针对正在运行的应用程序运行，以识别正在运行的应用程序中存在的安全漏洞。随着应用程序容器化程度的提高，拥有一个独立运行的应用程序实例是很容易实现的。结合您的容器化应用程序，StackHawk和Harness是您的DevSecOps之旅中的明智选择。在本例中，我们将在将应用程序部署到Kubernetes之前扫描应用程序。所有的代码片段也可以在<a href="https://gist.github.com/ravilach/28aa446dd81031de006545b3288ecc9e" target="_blank"> GitHub Gist </a>上找到。</p><p>该示例的目标是用DAST工具对正在运行的容器/应用程序进行自省，并让结果影响部署。一个很好的示例应用程序是StackHawk专门构建的<a href="https://github.com/kaakaww/vuln_node_express" target="_blank">易受攻击的节点应用程序</a>，如果您手头没有这样的应用程序的话。</p><figure class="w-richtext-figure-type- "/><p>利用Harness平台部署到Kubernetes，最简单的方法是将Harness委托部署到Kubernetes集群中。有几种方法可以对正在运行的容器调用StackHawk扫描。在本例中，我们将利用一个静态EC2实例来构建示例Docker映像并调用StackHawk扫描。一个Harness SSH委托将使EC2实例上的交互变得简单。</p><h3>平台先决条件</h3><p>如果这是你第一次，一定要在<a href="https://auth.stackhawk.com/signup" target="_blank"> StackHawk </a>和<a href="https://harness.io/free-trial/" target="_blank"> Harness </a>上注册账户。</p><h4>堆栈警告设置</h4><p>登录StackHawk帐户后，请务必记下您将用于验证的<a href="https://app.stackhawk.com/settings/apikeys" target="_blank"> API密钥</a>。</p><figure class="w-richtext-figure-type- "/><p>StackHawk提出了一个应用的概念。对于本例，单击Add an App并创建一个名为“Node App”的应用程序。</p><figure class="w-richtext-figure-type- "/><p>单击“下一步”后，您可以配置环境。示例应用程序绑定到端口3000。将主机设置为“<a href="http://localhost:3000/" target="_blank"> http://localhost:3000 </a>”但是，当使用StackHawk时，可以在创建应用程序后修改/创建配置[stackhawk.yml]作为谨慎的主机地址。</p><figure class="w-richtext-figure-type- "/><p>单击“下一步”后，您将看到一个应用程序ID。请确保保存该ID；此外，您可以保存生成的stackhawk.yml，它将包含ID。</p><figure class="w-richtext-figure-type- "/><p>现在，您已经准备好安装线束代理了。</p><h4>线束设置</h4><p>对于这个例子，您将安装一个SSH和Kubernetes线束委托。</p><h5>EC2/SSH</h5><p>设置-&gt;线束代理-&gt;安装代理</p><p>下载类型:Shell脚本</p><p>名称:ec2</p><figure class="w-richtext-figure-type- "/><p>单击复制下载链接。然后，登录到EC2实例的终端会话。</p><p>创建一个名为“harness”的目录，并将cd放入该目录。</p><p><em> mkdir线束</em> ‍ <em> cd线束</em></p><p>然后，将复制的下载链接粘贴到“harness”文件夹中进行下载。</p><figure class="w-richtext-figure-type- "/><p>下载完成后，就可以安装SSH委托了。</p><p>#安装SSH delegate tar xfvz harness * . tar . gzcd harness-delegate。/start.sh</p><figure class="w-richtext-figure-type- "/><p>稍后，SSH委托将出现在Harness UI中。</p><figure class="w-richtext-figure-type- "/><p>下一步将是安装线束Kubernetes代理。</p><h5>库伯内特斯</h5><p>设置-&gt;线束代理-&gt;安装代理</p><p>下载类型:Kubernetes YAML</p><p>名称:k8s</p><figure class="w-richtext-figure-type- "/><p>将tar.gz下载并展开到您的本地机器上。</p><figure class="w-richtext-figure-type- "/><p>kubectl命令将在READEME.txt中应用清单。</p><p>运行"<em>ku bectl apply-f harness-delegate . yam</em>l "</p><figure class="w-richtext-figure-type- "/><p>过一会儿，Kubernetes代表就准备好了。</p><figure class="w-richtext-figure-type- "/><p>现在，您已经准备好装配管道了。</p><h2>您的第一个DevSecOps管道</h2><p>Harness基于<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#cd_abstraction_model" target="_blank">抽象模型</a>的概念工作。基本上是组装管道所需的所有部件。</p><h3>将Kubernetes集群连接到线束</h3><p>将Kubernetes集群连接到Harness非常容易，尤其是在部署了Harness委托的情况下。</p><p>设置-&gt;云提供商-&gt;添加云提供商</p><p>类型:Kubernetes集群</p><p>显示名称:StackHawkKubernetes</p><p>集群详细信息:从所选代理继承</p><p>代表选择器:k8s</p><figure class="w-richtext-figure-type- "/><p>单击测试进行验证，然后单击下一步。根据您的帐户，系统会提示您是否希望分析集群工作负载以节省成本。你可以选择加入或退出。添加后，Harness现在可以与集群交互。</p><figure class="w-richtext-figure-type- "/><h3>创建线束应用程序</h3><p>线束的命脉是一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#applications" target="_blank">线束应用</a>。</p><p>设置-&gt;添加应用程序</p><p>姓名:StackHawk</p><figure class="w-richtext-figure-type- "/><p>一旦您点击Submit，您将会看到一个空白的连续交付抽象模型。</p><figure class="w-richtext-figure-type- "/><h3>创建线束环境</h3><p>一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#environments" target="_blank">利用环境</a>是“我将部署到哪里？”环境可以跨越多个基础设施。在本例中，我们将指向Kubernetes集群。在StackHawk Harness应用程序中，添加一个环境。</p><p>设置-&gt;堆栈工作-&gt;环境+添加环境</p><p>名称:产品</p><p>描述:产品</p><p>环境类型:生产。</p><figure class="w-richtext-figure-type- "/><p>点击提交后，可以将Kubernetes集群添加为一个<a href="https://docs.harness.io/article/v3l3wqovbe-infrastructure-definitions" target="_blank">基础设施定义</a>。</p><p>设置-&gt;堆栈工作-&gt;环境-&gt;生产+添加基础架构定义</p><p>名称:ProdKubernetes</p><p>云提供商类型:Kubernetes集群</p><p>部署类型:Kubernetes</p><p>云提供商:StackHawkKubernetes</p><figure class="w-richtext-figure-type- "/><p>点击Submit后，现在就可以部署到Kubernetes集群了。如果利用来自GitHub的<a href="https://github.com/kaakaww/vuln_node_express" target="_blank">示例应用程序</a>，您将需要构建该应用程序或带来您自己的映像。</p><h2>构建StackHawk示例应用程序</h2><p>在<a href="https://github.com/kaakaww/vuln_node_express" target="_blank"> StackHawk的GitHub项目</a>中有构建示例应用程序的说明。如果您没有过多使用Docker，一个简单的方法是将他们的项目分支到您的个人GitHub帐户中，然后将该项目的内容下载到EC2实例中，并从那里开始构建。当然，可能利用CI平台(如无人机)或利用持续集成来构建的艺术。</p><h3>克隆和修改Docker撰写</h3><p>你可以把StackHawk的项目转入你自己的账户。为了更好地控制图像名称，请使用您自己的图像名称修改Docker Compose[Docker-Compose . yml]。对于这个例子，我将发布到我自己的Docker注册表[rlachhman/demos:stackHawk]，您也可以从Docker获取它。</p><figure class="w-richtext-figure-type- "/><p>一旦完成了这些，您就可以将文件的zip文件保存到EC2实例中，或者利用CI平台。要了解zip的地址，可以在GitHub中点击Code并下载ZIP。</p><figure class="w-richtext-figure-type- "/><p># Get Files sudo yum安装unzip wget https://github。com/ravi lach/vuln _ node _ express/archive/refs/heads/main。zip解压缩主。活力</p><figure class="w-richtext-figure-type- "/><h3>使用Docker合成或Docker拉式就绪映像构建</h3><p>您可以使用Docker Compose从源代码构建，也可以利用已经构建好的映像。</p><h4>码头工人拉动</h4><p>如果您想跳过Docker合成步骤，您可以Docker提取一个现成的图像。</p><p># docker pull sudo docker pull la chh man/demos:stack hawk</p><figure class="w-richtext-figure-type- "/><p>您也可以使用Docker Compose构建图像并修改名称。</p><h4>Docker撰写</h4><p>如果这是你第一次使用<a href="https://docs.docker.com/compose/" target="_blank"> Docker Compose </a>，你将需要在EC2机器上安装<a href="https://docs.docker.com/compose/install/" target="_blank">Docker Compose</a>。下面是CentOS的EC2实例的说明，假设Docker运行时已经启动。潜在地，您可以将它添加到委托概要文件中，这样它就可以与Harness SSH委托一起安装。</p><p>如果您的CentOS机器上没有运行Docker CE:</p><p># install dock https://docs . docker . com/engine/install/centos/sudo yum install-and yum-utils sudo-config-manager \-add-repo \ https://download . docker . com/Linux/centos/docker-ce . repo sudo install docker-ce docker-CLI container d . io sudo system CTL start docker</p><p>Docker编写安装程序:</p><p># Docker复合安装sudo curl-L " https://github。com/dock/compose/releases/download/1档案。29 .1/docker-合成-(uname-s)-(uname-m)"-o/usr/local/bin/docker-合成sudo chmod+x/usr/local/bin/docker-合成sudo ln-s/usr/local/bin/docker-合成/usr/bin/docker-合成docker-合成版本</p><figure class="w-richtext-figure-type- "/><p>完成后，回到GitHub项目下载的根目录，现在就可以运行Docker Compose了。</p><figure class="w-richtext-figure-type- "/><p>运行Docker合成。</p><p>sudo docker-构建-构建-分离</p><figure class="w-richtext-figure-type- "/><p>您需要将工件发布到Docker注册中心。最简单的方法是发布到个人Docker Hub账户。简单地用你的Docker Hub凭证运行一个<em> docker登录</em>，然后运行一个<em> docker推送</em>来发布。</p><p>Docker Compose步骤已经完成，现在是时候开始构建管道了。</p><h2>从线束呼叫StackHawk</h2><p>有几种方法可以将软件集成到线束工作流程中。对于这个例子，我们希望在EC2实例上运行Shell脚本来调用StackHawk，然后解析结果。最简单的方法是将EC2实例定义为端点[云提供商]，这样我们就可以在一个工作流中管理这些shell脚本。</p><p>设置-&gt;云提供商-&gt;添加云提供商。类型是物理数据中心。您可以将提供者命名为“斯塔克豪·DC”</p><figure class="w-richtext-figure-type- "/><p>一旦你点击提交，斯塔克豪·DC就会出现。</p><figure class="w-richtext-figure-type- "/><p>回到StackHawk应用程序，您可以添加一个映射到新云提供商的Harness环境。</p><p>设置-&gt;堆栈工作-&gt;环境+添加环境</p><p>名称:斯塔克豪扫描仪</p><p>环境类型:非生产</p><figure class="w-richtext-figure-type- "/><p>像前面的Kubernetes Harness环境一样，您需要创建一个基础设施定义。</p><p>姓名:斯塔克豪·森特斯</p><p>云提供商类型:物理数据中心</p><p>部署类型:SSH</p><p>云提供商:斯塔克豪·DC</p><p>主机名:本地主机</p><p>连接属性:任何</p><figure class="w-richtext-figure-type- "/><p>点击Submit——您现在已经连接到EC2实例了。</p><p>Harness能够协调来自Shell、Serverless、Kubernetes等多种类型的部署。您可以利用<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#services" target="_blank">线束服务</a>作为管道来跨管道执行StackHawk命令。</p><p>为StackHawk命令创建新的线束服务。</p><p>设置-&gt;堆栈工作-&gt;服务+添加服务</p><p>名称:StackHawk命令</p><p>部署类型:安全外壳(SSH)</p><p>工件类型:其他</p><figure class="w-richtext-figure-type- "/><p>单击提交–现在您可以使用此服务来部署。</p><figure class="w-richtext-figure-type- "/><p>为了让Harness管理执行StackHawk扫描所需的命令，创建一个代表它的<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#workflows" target="_blank"> Harness工作流</a>。</p><p>设置-&gt;堆栈工作-&gt;工作流+添加工作流</p><p>名称:StackHawk扫描</p><p>工作流类型:滚动部署</p><p>环境:StackHawk扫描仪</p><p>服务:StackHawk命令</p><p>基础设施定义:StackHawk CentOS</p><figure class="w-richtext-figure-type- "/><p>点击提交后，将会生成一个模板化的工作流。阶段、名称和顺序可以被改变、压缩等。</p><figure class="w-richtext-figure-type- "/><p>您可以通过单击+ Add Step，在步骤3“部署服务”下插入StackHawk调用。在添加步骤UI中，搜索“Shell”并选择Shell脚本。</p><figure class="w-richtext-figure-type- "/><p>单击下一步。围绕填写一个<a href="https://docs.stackhawk.com/hawkscan/running-hawkscan.html" target="_blank"> shell脚本，说明StackHawk扫描需要什么。确保选择分配给Shell(例如CentOS)代理的代理选择器(ec2)。这些部分将生成stackhawk.yml，运行stackhawk扫描器，并调用Docker映像来运行易受攻击的应用程序的容器。该脚本接受来自线束秘密管理器和工作流本身的变量。在此步骤之后，将对其进行配置。</a></p><p>根据您在Docker合成中对Docker映像的命名，您需要修改Docker Run命令以反映新的映像名称和标签。</p><p>名称:Shell脚本</p><p>类型:Bash</p><p>对委托执行:选中</p><p>代表选择器:ec2</p><p>脚本:</p><p>#Make DIR和CDmkdir-p ~/stack hawk-scan SCD ~/stack hawk-scans # Docker Run if needs Udo Docker Run-RM-publish 3000:3000-name nodeexpressvulny rlachhman/demos:stack hawk # Create stack hawk . YAML cat &gt; stack hawk . yml&lt;&lt; 'EOF'# stackhawk configuration for Node Appapp:  # An applicationId obtained from the StackHawk platform.  applicationId: ${workflow.variables.stackhawkappid} # (required)  # The environment for the applicationId defined in the StackHawk platform.  env: Production # (required)  # The url of your application to scan  host: ${workflow.variables.stackhawkhost} # (required)EOF#Run Scansudo docker run --rm -v $(pwd):/hawk:rw -e API_KEY=${secrets.getValue("stackhawkapikey")} -i stackhawk/hawkscan:latest stackhawk.yml 2&gt;&amp; 1 | tee scan results . txt</p><figure class="w-richtext-figure-type- "/><p>单击提交–现在工作流有了执行扫描的命令。</p><figure class="w-richtext-figure-type- "/><p>上面的脚本将接收StackHawk API键、AppID、应用程序的运行地址的输入，然后将扫描结果导出到本地文件中。</p><p>将它包装在Harness工作流中的好处是，您可以提示用户输入项目。您可以在工作流中设置两个变量来提示StackHawk AppID和运行图像的地址。</p><p>在右侧的StackHawk扫描工作流中，单击工作流变量并添加以下内容。</p><p>变量名:stackhawkappid</p><p>类型:文本</p><p>必填:已勾选</p><p>变量名:stackhawkhost</p><p>类型:文本</p><p>必填:已勾选</p><figure class="w-richtext-figure-type- "/><p>单击保存，工作流变量就就位了。</p><figure class="w-richtext-figure-type- "/><p>如果您想添加其他变量，可以通过以下格式访问它们:</p><p><em> $ {工作流程。变量。变量名称} </em></p><p>接下来，使用Harness的Secret Manager来存储您的StackHawk API密钥。</p><p>安全-&gt;机密管理+添加加密文本</p><p>姓名:stackhawkapikey</p><p>值:您的api密钥</p><figure class="w-richtext-figure-type- "/><p>单击提交。你现在可以知道这个秘密了。访问机密类似于访问工作流变量。</p><p><em> $ {秘密。getvalue(" key _ name ") </em></p><p>基本的扫描已经完成，现在是时候创建一些部署逻辑了。</p><h2>部署管道</h2><p>最终，您会想要部署应用程序。回到Harness平台的第一步是为Kubernetes部署创建一个Harness服务。</p><p>设置-&gt;服务+添加服务</p><p>名称:节点应用程序</p><p>部署类型:Kubernetes</p><figure class="w-richtext-figure-type- "/><p>单击Submit后，Harness将创建部署所需的Kubernetes脚手架。</p><p>Harness需要通过在服务中单击+ Add Artifact Source并选择Docker Registry来了解要部署什么工件。</p><figure class="w-richtext-figure-type- "/><p>根据您是否从头开始运行Docker合成，您需要用您的名称替换图像名称。如果使用预烘烤的，利用以下。</p><p>源服务器:Harness Docker Hub[默认情况下启用公共Docker Hub]。</p><p>Docker镜像名称:rlachhman/demos[或您的repo/name]。</p><figure class="w-richtext-figure-type- "/><p>点击Submit后，您的服务就可以部署了。</p><figure class="w-richtext-figure-type- "/><p>您将需要添加一个定义如何部署步骤的线束工作流。对Kubernetes来说相当简单。</p><p>设置-&gt;堆栈工作-&gt;工作流+添加工作流</p><p>名称:部署节点应用程序</p><p>工作流类型:滚动部署</p><p>环境:产品</p><p>服务:节点应用程序</p><p>基础设施定义:产品</p><figure class="w-richtext-figure-type- "/><p>单击Submit后，您的节点应用程序就有了要部署的工作流。</p><figure class="w-richtext-figure-type- "/><p>最后剩下的步骤是解释结果，并将工作流缝合到一个内聚的DevSecOps管道中。</p><h2>自动化您的DevSecOps管道</h2><p>自动化是DevSecOps的关键。由于StackHawk扫描是在管道中以编程方式执行的，因此它们也可以以编程方式进行解释。</p><p>类似于在Shell脚本中执行扫描，您可以创建另一个Harness工作流来解释扫描结果。</p><p>设置-&gt;堆栈工作-&gt;工作流+添加工作流</p><p>名称:解释扫描</p><p>工作流类型:滚动部署</p><p>环境:StackHawk扫描仪</p><p>服务:StackHawk命令</p><p>基础设施定义:StackHawk CentOS</p><figure class="w-richtext-figure-type- "/><p>与StackHawk扫描类似，将interpet脚本添加到工作流的步骤3中。</p><figure class="w-richtext-figure-type- "/><p>+添加步骤-&gt;外壳脚本</p><p>名称:Shell脚本</p><p>脚本类型:Bash</p><p>对委托执行:选中</p><p>代表选择器:ec2</p><p>脚本:</p><p># Change Foldercd ~/stack hawk-scans # Parse results export totalhighfroviderations = $(grep-I ' \<risk scanresults.txt="" grep="" high="" violations:="" logic="" if="" violations="" matchif="" then="" preventing="" deployment="" forward="" with=""/></p><figure class="w-richtext-figure-type- "/><p>点击提交，解释就完成了。该脚本将解释来自StackHawk扫描控制台输出的扫描结果，如果存在严重违规，则停止部署。</p><p>最后一步是将扫描、解释和部署结合在一起。</p><h2>运营开发部门管道</h2><p>The power of the <a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#pipelines" target="_blank">Harness Pipeline</a>是将粒度步骤缝合在一起，成为一个功能齐全/可操作的DevSecOps管道。</p><p>创建线束管线很简单。顺序将是扫描的管道阶段，然后是解释，如果符合卫生标准，则是部署。</p><p>设置-&gt;堆栈工作-&gt;管道+添加管道</p><p>名称:DevSecOps</p><figure class="w-richtext-figure-type- "/><p>点击“提交”后，您可以向每个工作流添加一个阶段。</p><figure class="w-richtext-figure-type- "/><p>单击+圆圈添加第一阶段，即StackHawk扫描。</p><figure class="w-richtext-figure-type- "/><p>点击提交，添加另外两个；解释和部署。</p><figure class="w-richtext-figure-type- "/><p>一旦完成，你的CD抽象模型就完成了。你准备好执行了！</p><figure class="w-richtext-figure-type- "/><h2>运行您的DevSecOps管道</h2><p>要运行您的示例，请转到左侧导航，单击Continuous Deployment，然后启动New Deployment。</p><p>您将需要部署“StackHawk”应用程序，并填写您的StackHawk AppID和运行容器地址。</p><p>应用:StackHawk</p><p>管道:DevSecOps</p><p>stack hawk appid:your _ stack hawk _ app _ id</p><p>stackhawkhost:您的运行主机或ip地址</p><p>工件/节点应用程序标签:your _ Tag[或者#stackHawk，如果使用rlachhman的例子的话]</p><figure class="w-richtext-figure-type- "/><p>点击“提交”——你现在可以开始比赛了！注意:管道将失败，因为这个应用程序很容易受到攻击。在第二阶段，您可以看到部署已经被阻止。</p><figure class="w-richtext-figure-type- "/><p>回到StackHawk控制台——您现在可以对漏洞进行分类。</p><figure class="w-richtext-figure-type- "/><p>开发愉快！使用StackHawk，您可以确认漏洞并重新运行管道以成功部署。</p><h2>DevSecOps和Harness:一起更好</h2><p>Harness作为首要的软件交付平台，可以帮助您实现您的DevSecOps目标。作为一种整合新技术和扫描方法的不偏不倚的方式，Harness平台可以成为软件交付中发生的范式转变的渠道。今天一定要注册一个<a href="https://harness.io/free-trial/" target="_blank">驾驭账号</a>！</p><p>干杯，</p><p>拉维</p><p>‍</p></div></div>    
</body>
</html>