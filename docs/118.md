# 线束|线束采用 DevOps

> 原文：<https://www.harness.io/blog/devops-adoption>

在这篇博文中，我们将回顾 Harness 对 DevOps 的采用。我们将让您深入了解我们实施了哪些策略来拥抱 DevOps 原则和文化。

开发和运营(DevOps)是文化、工具和实践的结合，提高了组织向客户交付产品和服务的能力。DevOps 伞下有很多工具和堆栈。您可以选择它们的任意组合，掌握它们，并且它们应该与组织的需求保持一致。这就是 DevOps 的伟大之处——什么都有——这使得采用 DevOps 变得轻而易举。但是我们今天不是在这里讨论工具——我们已经有很多关于工具的帖子了！

开发运维工程师/团队应该遵循一些最佳实践来创建高效的环境。这些实践将允许他们交付具有高可用性的产品和服务，并在产品或服务正式上市之前很久就能从多个地方获得反馈。在这篇博文中，我们将回顾 Harness 对 DevOps 的采用。我们将让您深入了解我们长期以来实施了哪些策略来支持 DevOps 原则和文化。

## 代码验证过程

### 左移进路

Harness 利用 Git 提供的钩子来验证某些事情，甚至在开发人员推送代码来创建 PRs 之前。Git 挂钩不过是由不同的 Git 命令调用的脚本。这些可以本地复制到每个开发者的机器上。这些脚本可以包含任何类型的逻辑(例如:在推送之前验证开发人员机器上的最新代码，提交消息格式和大小)，它们可以用任何编程或脚本语言编写。这有助于识别与 PRs 相关的某些问题，如合并冲突或不正确的提交消息——并节省大量时间和构建/计算资源。

### CI 管道

没有人喜欢[b](https://harness.io/blog/bugs-data-driven-quality/)T2u[ggy](https://harness.io/blog/bugs-data-driven-quality/)或者易受攻击的代码。为了防止这种情况，所有进入发布或主分支的代码都应该在合并到这些分支之前得到正确的验证。在 Harness，只要开发人员在 GitHub 中提出 PR (pull request ),一系列作业就会在 Harness CIE 中开始运行(例如:Bazel Build、单元测试、功能测试、静态检查和其他杂项检查)。如果所有这些工作都通过了，那么 PR 将接受至少两个高级开发人员的手工审查，如果他们都同意，那么 PR 中更改/添加的代码将被允许合并到发布或主分支。

在 Harness，每天都有超过 100 个 PRs 被 CI 渠道在 35 分钟内提出并验证(取决于变更集)。下面是 Harness 遵循的公关流程的高级图。

## 多重环境

交付稳定且无缺陷的产品或服务的最佳方式是在类似于[生产环境](https://harness.io/blog/deployment-environments/)的环境中进行适当的测试。这只能通过创建多种环境来实现，在这些环境中，人们可以测试新代码并正确地获得反馈。在向客户发布产品和服务之前，Harness 使用以下 4 种环境来测试其产品和服务:

*   PR 环境:这是开发者测试他们的 bug 修复和新特性的第一个环境。
*   QA 环境:在这里，测试团队为即将发布的版本运行自动化和手动测试用例。测试人员也使用这个环境。
*   登台/登台环境:该环境在当前版本之后运行 1 或 2 个版本，用于部署生产环境。
*   生产环境:如果一个产品或服务通过了上述所有环境，那么它就被部署在这里，并向所有的 Harness 客户提供 GA。

## 备份和故障转移策略

### 备份

随着时间的推移收集的数据对所有组织都很有价值。因此，为数据库和存储磁盘制定备份策略非常重要。如果您的数据库和存储磁盘在云上，请利用云供应商提供的定期备份或快照功能。如果它们不在云上，设置一个 cron 作业(使用 scp 或 rsync 实用程序)定期进行备份。在 Harness，我们使用 GCP 提供的快照功能来备份服务器使用的所有存储磁盘。

### 故障切换

没有人能提供 100%的正常运行时间。然而，99.99999%是可能的，这可以通过设置冗余来实现。主系统和冗余系统应该位于不同的区域(云可用性区域)，100%奇偶校验，并且彼此完全隔离。如果主系统出现故障，那么一个冗余系统将取代它的位置，为客户提供服务。

## 基础设施作为代码

建立整个[基础设施](https://harness.io/blog/infrastructure-as-code/)来托管产品/服务并不是一件容易的事情。它包含了一大堆堆叠在一起的组件来创建一个生态系统。基础设施包括虚拟机、数据库、存储磁盘、负载平衡器、VPC、子网、防火墙等。基础设施越庞大，一旦出现问题，重建就越困难。因此，以脚本的形式记录所有组件是很重要的。

Terraform 和 [Ansible](https://www.ansible.com/) 是很好的开源基础设施供应和配置管理工具。这些工具只需在键盘上轻轻一点，就可以创建多个环境，并且可以根据需要升级或降级您的基础架构。他们绝对让 DevOps 工程师的生活更轻松！

### 版本控制脚本

当我们以 IaC 的形式管理基础设施时，这意味着它也像任何其他代码一样:它随时都有可能崩溃。最好使用版本控制系统(VCS)工具，如 Git、SVN 等来管理 IaC。

VCS 记录开发人员对脚本所做的每一个更改。如果您必须将中断的更改恢复到最后的稳定状态，并为不同的环境维护不同版本的基础架构，这将非常有用。

### 验证 IaC 脚本

IaC 脚本也应该接受静态检查，像任何其他代码一样，在合并到主/发布分支之前进行验证——以及来自高级成员的手动审查。这确保了脚本是无错误的，并且它们遵循适当的林挺/编码约定。

## 云采用

如今，所有组织都在将他们的基础架构迁移到云中，并遵循 SaaS 概念，通常称为订阅。想想看:优步、网飞、Spotify 等。

使用云消除了购买和维护基础设施来托管应用程序或服务的麻烦。云提供了大量可供选择的服务，如计算资源、数据库服务、监控服务、日志服务和高互联网连接性。

云是由供应商管理的，他们只负责为客户使用的基础设施提供安全保护- **而不是**在其上运行的应用程序。每个人都喜欢供应商提供托管在云上的安全产品或服务。

在 Harness，我们非常重视安全性。以下是我们在该领域遵循的一些最佳实践。我知道这更多的是 SecOps 而不是 DevOps，但是在一些组织中，安全性也属于 DevOps。

### 安全的应用程序端点

*   **VPC 和子网:**在云中，没有 VPC 就不可能部署任何东西。VPC 隔离您的环境，这是一个很好的实现方法。可以有多个子网来托管您的服务器、数据库和存储磁盘。建议:前端服务器使用公共子网，后端服务器使用私有子网。
*   **HTTPS 而不是 HTTP:** 前端服务器提供面向公众的 URL 来访问组织的产品/服务，或者使用 HTTP 协议的任何通信，应该可以通过安全的 HTTP 进行访问。建议安装证书时使用安全 HTTP，而不是普通 HTTP。

### 安全的服务器端点

*   **对后端服务器的最小访问:**后端服务器，如数据库或运行组织业务逻辑的服务器，应该对任何其他机器(入口和出口)的最小访问，并且应该由防火墙规则、安全组或 NACL 严格控制。除了负责这些服务器的组织员工之外，任何人都不应看到或访问这些服务器。
*   **使用堡垒主机:**应避免直接登录后端服务器或前端服务器。总是使用另一个秘密主机，称为堡垒主机，通过 SSH 安全地登录到这些服务器。注意:SSH 运行在端口 22 上。此端口应该只允许堡垒主机访问组织的服务器。

## 监控和可观察性

一旦产品或服务被推广到生产中，总是要监控它的指标(传入/传出流量、服务器负载等)。).设置阈值以防止停机。在 Harness，我们使用多个系统，如 Prometheus、Grafana 和 GCP 监控服务。

数字很好，但图表更好！图表使理解趋势变得更加容易(例如，构建时间、拉请求变更集大小、代码行数等)。)随着时间的推移在组织内发生*。这些度量有助于减少现有流程中的缺陷，并允许创建更高效的流程。在 Harness，来自 GitHub 和 Harness CI 的各种指标被纳入 ElasticSearch。从那里，在 Kibana 中创建图形用于可视化。Harness 还使用 Looker 来构建包含各种指标的仪表板。*

## *停靠和编排*

### *码头化*

*应用架构从[单片发展到微服务](https://harness.io/blog/microservices-deployment-strategies/)，这很好。然而，微服务架构有它自己的包袱，因为它涉及许多不同配置的不同组件。管理所有组件的配置可能会很棘手。管理所有配置的最佳方式是 Docker 映像的形式。这样，您可以记录组件中的内容以及任何第三方依赖项的版本。将组件从一个地方运送到另一个地方要容易得多。在 Harness，我们以 docker 文件的形式编写所有组件配置。我们将它们作为 Docker 映像部署在每个环境中。*

### *管弦乐编曲*

*因为所有组件都独立运行在不同的机器上，所以需要确保所有组件(以 Docker 容器的形式)都按预期工作。现在市场上有很多编排工具，比如 Docker Swarm、Kubernetes 等等。在 Harness，我们利用 GKE 来部署我们的服务。所有环境都部署到 GKE，这提供了高可用性。*

## *文化变迁*

### *与团队的定期会议*

*DevOps 不只负责一个团队。他们在产品的许多领域工作。因此，讨论他们需要什么，他们面临什么问题，以及可以做什么来改善他们的[开发者体验](https://harness.io/blog/developer-experience/)是必要的。在 Harness，我们定期举办公开论坛。来自不同团队的领导通过 Zoom 电话讨论他们的问题和要求。*

### *开发人员的空闲组*

*我们创建了几个松弛小组，每个人都可以在这里讨论问题的解决方案并提出建议。在这些小组中，任何人都可以参与并创建线程。这让每个人都知道已解决问题的解决方案。*

## *结论*

*DevOps 工程师以极大的方式帮助企业，他们帮助保持产品和服务的安全和无缺陷。它们能够在开发和运营的每一步提供更快的反馈。在您的 DevOps 采用流程中遵循上述一些最佳实践将改善和增强与基础架构相关的一切，实现您的产品/服务的高可用性，并减少从故障中恢复的停机时间。*

*看起来你喜欢阅读最佳实践文章！您是否读过我们的 [CI/CD 最佳实践](https://harness.io/blog/ci-cd-best-practices/)文章？当您准备深入研究 CI/CD 时，这是一个很好的起点。*