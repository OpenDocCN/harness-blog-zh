# APM:数据科学家的视角| Harness

> 原文：<https://www.harness.io/blog/what-ails-application-performance-monitoring>

使用应用性能监控(APM)解决方案有两个主要原因。1.为您的应用程序收集和可视化数据。2.当不好的事情发生时得到提醒。

使用[应用性能监控(APM)](https://www.gartner.com/document/3904665) 解决方案有两个主要原因:

1.  **为您的应用程序**收集和可视化数据。这些数据可能是响应时间、错误率、数据库调用——您明白了。几乎所有 APM 工具都可以通过最少的配置和工作进行收集和可视化。它们都支持功能强大的可视化工具，可以快速排除故障。
2.  当不好的事情发生时，得到提醒 **。**您的工程师定义什么对您的应用不利，您设置规则在这种情况发生时触发警报。

那么，APM 今天遇到了什么问题？如果你说基于规则的警报，答对了！！基于规则的警报不佳的首要原因是您定义的规则是静态的，而您的应用程序数据是动态的。

不幸的是，这些规则很容易设置，所以这是工程社区的 goto 方法。结果是:无效的监控，大量的误报警报使得寻找真正的停机就像大海捞针。

首先，让我们看看收集的数据的性质和目前使用的两个最流行的规则。

## 数据

我们正在处理标准的单变量时间序列，其中每个时间步长(t)报告一个数据点(y)。

例如，假设您想要了解用户登录的应用程序响应时间。APM 代理(通常在您的应用程序中运行)收集所有用户登录的响应时间，并报告每分钟的平均值。因此，每分钟(t)得到一个平均响应时间值(y ),每分钟重复一次。

这样生成的序列有 3 个基本组成部分，适用于任何时间序列:

*   **趋势**(T)——数据水平在较长时期内的总体变化(上升、下降、横向变化)。下面是 JVM 堆利用率的图表，清楚地显示了一个增长趋势。

*   **季节性**(S)——受季节性因素(一天中的时间、一周中的日期、一年中的月份等)影响的固定周期模式。下面的图表描述了在我们自己的[软件交付平台](https://harness.io/platform/)中捕获的软件部署数量。你可以清楚地看到傍晚和晚上以及周末的低谷。高峰期在一周的中间，此时公司会积极部署软件。

*   **随机性(R)——从潜在模式中观察到的随机偏差。**

因此，任何时间序列都可以建模为趋势(T)、季节性(S)和随机性(R)的函数。例如，附加模型看起来像这样:

Yt = Tt + St+ Rt

根据应用的不同，不同的模型针对不同的组件。例如，趋势是跟踪人口增长的一个很好的指标。现在，让我们继续讨论警报中最常用的两条规则。

## 基于趋势的警报

确定趋势包括去除潜在时间序列中的季节性和随机性。时间序列定义变为:

Yt= Tt

任何时间步长(T)的趋势(T)通常被建模为先前时间步长的值的函数。

Yt = f(Vt-1，Vt-2，…。)

在 APM 警报的上下文中，函数 *f* 总是一种移动平均线的形式。一些例子是:

然后通过比较 Yt(预测值)和实际观察值 *Yt* 发出警报。例如，它可以是一个简单的警报规则:

Yt > 2 * Yt

问题是，几乎每一次观察都会偏离基于季节性或随机性的趋势。这是一个图表，描述了我们的线束平台上的实际负载。蓝线是一个月内实际测量的负载，橙线是 5 天移动窗口内的简单平均值。

这里是一个放大的版本，显示了由于季节性和随机性，移动平均值如何落后于实际测量值。

这里是 Yt - Yt 的散点图:实际值和预测值之间的差异。请注意，这里的每个点都有资格发出警报，从而使您的警报不可靠。

对于 APM，我们需要为可靠的警报建模季节性和随机性，而不是趋势，这与基于趋势的策略完全相反。

## 基于标准差的警报

基于标准差的警报将错误和响应时间等不同指标建模为随机变量。建模时假设从独立分布*中抽取的不同随机变量样本的平均值*收敛于[正态分布](https://en.wikipedia.org/wiki/Normal_distribution)(参见[中心极限定理](https://en.wikipedia.org/wiki/Central_limit_theorem))。

用英语来说，这意味着如果您正在测量所有服务实例的错误率，则服务实例的平均错误率可能是正态分布的。一般来说，如果您有一个大型的服务实例基础结构、高负载量和足够大的观察窗口来进行采样，就可能会出现这种情况。即便如此，在警报方面，it 仍面临两大挑战:

-应用程序或事务中的错误是最可靠的警报指标。查看我们自己的数据和客户的数据，我们发现错误率不是正态分布的。主要原因是它是稀疏的——0 个错误的周期，然后出现峰值，如下图所示。

Errors per minute

使用基于分布的方法，每个峰值都会向您发出警报(您的平均值接近 0)。这等同于说“当错误> 0 时，随时提醒我”。通常，峰值是零星的，不可操作的。更好的预警方法是寻找与过去观察到的不同的持续模式。

-分配方法消除了时间维度。它对一段时间内的观察值进行采样，以构建基线正态分布。通常，当观察值大于基线正态分布平均值的三个标准差时，会触发警报。

所选的时间段应该足够大，以获得足够的样本，使分布收敛到正态。这可能是一周的观察值，一个月，或者在稀疏事务的情况下更长。

下面是 1 小时内整个吊带 SaaS 平台的负载分布。显然，样本数量不足以呈正态分布

Distribution of Calls/min (1hr window)

3 天内的负载分布更接近正态分布(见下图)。请注意，当您深入到事务级别时，您的时间窗口需要长得多——至少几个月:

Distribution of Calls/min (3-day window)

像上面基于趋势的方法一样，分布方法不能捕捉季节性和随机性。它还会忽略任何模式，因为警报是由单个观察结果驱动的。我们来看一个具体的例子。

上图显示了我们在停机期间 1 小时内监控的应用程序的负载。绿色圆圈表示一天中这个时间的正常负载，红色圆圈表示负载下降，并且下降持续了很长时间。上午 8:15，应用程序最终达到峰值并崩溃。这里的下降实际上表明了导致后来崩溃的一个正在进行的问题。

您可以看到该应用程序在崩溃前最后 3 天的负载分布。分布以 10，500 个呼叫/分钟的平均值为中心，单个标准偏差范围在 6500 个呼叫/分钟到 14，500 个呼叫/分钟之间，如蓝盒图所示(就在 X 轴上方)。

使用标准差策略，当观察值超过三个标准差时，通常会触发警报，即*呼叫/分钟> 20，000 或呼叫/分钟< 2，500* 。

让我们将红色圆圈中观察到的负载值作为 **X** s 叠加在上面的基线分布之上。

很明显，所有的 **X** 都在平均值的一个标准差之内。标准偏差方法显然忽略了这种停机的开始，只会在完全崩溃时触发。基线时间窗口越长，漏检(假阴性)就越普遍。时间窗口越短，假阳性警报越普遍(没有足够的数据点来获得真实的分布)。

## 结论

在 Harness，我们将来自 APM 提供商、数据库、内部指标跟踪器等的所有监控信号输入到我们自己的 [24/7 Service Guard](https://harness.io/blog/product-updates/harness-24-7-service-guard/) 解决方案中。这使用强大的异常检测技术(无规则)来生成对底层信号的警报。基于该信号，工程师跳转到底层工具和仪表板以进行进一步的故障排除。好处是有效的监控和更好的睡眠:)。无论您使用什么工具，都要注意使用基于规则的警报的危险。

干杯！
斯里拉姆。