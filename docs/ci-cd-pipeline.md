# CI/CD 管道:您需要知道的一切|线束

> 原文：<https://www.harness.io/blog/ci-cd-pipeline>

构建良好的 CI/CD 管道有助于软件交付过程的自动化。了解 Harness 如何构建 CI/CD 管道来加快部署过程。

## CI/CD 管道和软件交付

在现代软件开发中，编写源代码只是将您的想法融入到野生产品中的旅程的一部分。自信地构建、打包、测试、验证和安全地部署到产品中的能力跨越了几个领域和学科。描述开发和部署管道的常见名称是 [CI/CD](https://harness.io/blog/what-is-ci-cd/) 。

[持续集成](https://harness.io/blog/what-is-continuous-integration/) (CI)代表自动化构建和打包软件所需的所有步骤。[连续交付](https://harness.io/blog/what-is-continuous-delivery/) (CD)展示了安全地将您的工件部署到生产环境中的所有建立信任、基础设施和部署步骤。

## 什么是 CI/CD 管道？

CI/CD 管道是一系列协调的步骤，能够将源代码一直引入到生产中。这些步骤包括构建、打包、测试、确认、验证基础架构，以及部署到所有必要的环境中。根据组织和团队结构，可能需要多个管道来实现这个目标。CI/CD 管道可以由某种事件触发，例如来自源代码存储库的 pull 请求(即:代码变更)，工件存储库中新工件的出现，或者某种与发布节奏相匹配的常规时间表。

通常，CI/CD 管道由 [CI/CD 平台](https://harness.io/blog/what-is-cicd-platform-why-should-i-care/)进行编排，这些平台是为管理所需的跨学科编排而专门构建的。CI/CD 管道本身可以在 CI/CD 工具中表示为领域特定语言(DSL ),或者在 Harness 平台中表示为声明性格式(如 YAML)。由于存在大量的语言和技术选择，现代 CI/CD 管道关注结果。

### CI/CD 管道的优势

不像软件语言，你可以从一家公司到另一家公司采用方法和设计模式，部署几乎总是独一无二的。软件是你之前和期间决策的顶点。两个应用程序(及其支持基础设施)很少是相同的。软件开发和交付是迭代的练习，并且管道被期望每天执行多次，为了 bug 修复，以及其他原因。通过采用 CI/CD 管道的系统方法，团队可以更清楚地了解将他们的想法投入生产需要什么。随着新的建立信任练习变得流行，它们可以作为质量门添加到 CI/CD 管道中。因为管道是系统化的，所以瓶颈很容易被发现和补救，而不是一个有很多移交的脱节的人驱动的过程。

### 您的 CI/CD 渠道的目标

在 CI/CD 渠道中可以有许多目标。CI/CD 渠道的结构往往遵循其驱动的目标。

#### 由环境驱动

随着系统变得更加分散，需要部署服务的位置数量也在增加。如果您的主要目标是部署到多个环境/位置，您的 CI/CD 管道将更倾向于以部署为中心，有利于协调服务必须穿越的所有环境。

#### 由测试驱动

测试自动化和编排是 CI/CD 管道的常见用途。必须将几种不同的测试方法链接在一起，自动化测试的自然归宿就在您的管道中。随着测试越来越严格，随着管道越来越接近生产，“每阶段时间”越来越长。

#### 由服务驱动

随着微服务的兴起，部署往往会包含一个以上的服务。如果管道用于服务编排，则需要并行(或顺序)部署几个服务。这些管道往往用于编排几个服务，以确保其部署的一致性。

#### 由结果驱动

最终，特征必须与期望相匹配。注重结果的管道往往具有更长的最终阶段，并且能够在部署结束时不结束。结果可能意味着确保 SLA/SLOs/SLIs，如果被突破，管道是恢复 MTTR 的管道。部署后数小时或数天，可能会出现倒退或结果变化。

#### 由人驱动

在有管道之前，人们高度参与进展部署。如果部署过程仍然是相当手工的，有许多批准门(即:由人驱动)，这些管道往往是长期运行的，并用于跟踪人工工作流。现代管道试图避免这种反模式。

## CI/CD 管道元素

CI/CD 管道中的典型构造块涵盖了从源代码到部署到生产的整个范围。

#### 构建元素

需要为潜在的部署构建和打包源代码。有许多不同的[持续集成工具](https://harness.io/blog/continuous-integration-tools/)可用于自动化 CI/CD 管道的这一阶段。由于依赖于语言，在可部署单元中使用的语言的构建工具需要被调用和执行。例如，如果利用 JAVA，需要调用 Maven 或 Gradle 来构建 JAVA 发行版。自动化构建元素也可以是打包步骤的一部分。进一步以 JAVA 为例，如果需要构建 JAVA 应用程序的 Docker 映像，调用所需的 Docker Compose 步骤。以构建为中心的测试可以在构建元素中运行，比如单元测试和依赖扫描。

#### 基础设施要素

现代 CI/CD 管道具有基础设施感知能力。与过去基础设施在应用部署之前等待的管道相比，随着基础设施即代码的兴起，现在基础设施在管道执行期间被供应。基础设施供应的成功或失败是 CI/CD 管道进展的关口。随着工件在环境中的进展，基础设施供应，例如执行 Terraform 脚本或云提供商脚本，用于准备下一个环境。

#### 测试元素

大多数管道的主要目标是灌输信心。教科书上灌输软件信心的方法是运行测试。测试元素有多种形状和形式。随着测试方法的发展，CI/CD 管道是作为质量关口执行测试的自然场所。除了以构建为中心的测试之外，需要完整应用程序的测试，比如集成测试、浸泡测试、负载测试和回归测试，是很自然的选择。现代测试方法，如混沌工程，也可以扩展到基础设施层面。

#### 释放元素

有助于实现连续部署的实际部署行为是发布元素。需要以滚动、蓝绿色或淡黄色方式部署？您 CI/CD 管道中的发布元素将负责该编排。

##### 滚动部署

滚动部署是一种发布策略，其中正在运行的实例按顺序更新。为了扩展这一点，旧的应用程序版本被关闭，然后新的版本在它的位置出现，直到序列中的所有节点都被替换。

##### 蓝绿色部署

蓝绿部署是一种为安全而设计的发布策略。随着两个并行版本的生产运行，新版本(蓝色)将通过负载均衡器取代稳定版本(绿色)，该负载均衡器保持稳定版本运行，直到重新调整其用途或将其退役被认为是安全的。实施蓝绿色部署使回滚变得更加容易。但是，另一方面，所需的基础架构(生产的两个拷贝)的调配和运行成本可能很高。

##### 金丝雀部署

金丝雀部署是一种增量发布策略，其中新的变更(金丝雀)被增量地推出，最终取代稳定版本。Canary 部署分多个阶段运行。例如，第一阶段可能交换 10%的节点，一旦成功，将增加到 50%的节点，最后是 100%的节点。实现 canary 部署的主要原因是它们在发布期间提供的安全性，以及比蓝绿色部署使用的资源更少。另一方面，金丝雀部署可能很复杂，因为推广金丝雀需要验证。

#### 验证元素

验证元素可以被用作决策点，以在管道中前进，继续提升工件，并在部署发生后对其进行监控。有许多监控和可观察性工具，它们在寻找回归的能力方面是最好的。现代 CI/CD 管道可以从多个标记(包括这些监视和可观察性工具)做出决策，并决定是否应该进行前进或后退。现代 CI/CD 管道还能够系统地验证正在部署或已经部署的设备的健康状况。测试和验证不应该以部署结束，这是持续测试目标的关键。

## 优质 CI/CD 管道的特征

好的管道是快速且可重复的。优秀的管道快速、安全且可重复。

《T2 加速》一书指出，精英执行者的交付周期不到 1 小时，生产部署的变更失败率不到 15%。因此，在代码到达最终用户之前，一个好的管道将在一个小时内完成，并捕获 95%的异常和回归。

如果您的代码需要一个多小时才能到达生产环境，或者如果 10 个部署中有 2 个以上失败，您可能需要重新考虑您的 CI/CD 管道设计和策略。

## CI/CD 管道示例

将所有的管道元素放在一起是具有挑战性的，尤其是当跨越不同的技能和团队时。现代 CI/CD 工具允许以声明性格式对管道进行建模，这使得将所有需要的元素快速缝合在一起成为可能，从而在管道中实现灵活性和健壮性。

分布式应用程序很少有一个需要部署的基础设施。例如，如果您的应用程序包含无服务器部分，则运行时间较长的工作负载可能会部署到 [Kubernetes](https://kubernetes.io/) ，而无服务器部分则部署到云提供商，例如 [AWS Lambda](https://aws.amazon.com/lambda/) 。通过利用 CI/CD 管道，您能够跨管道维护上下文和配置，从而实现跨阶段部署到多个基础架构的目标。

将验证元素包含在 CI/CD 管道中是很有挑战性的，因为它们通常需要将某种决策编码到管道中。它们是迈向自动化目标的重要组成部分。在 canary 部署场景中，自动将 canary 提升到下一阶段是至关重要的。自动化应该涵盖金丝雀的升级和降级[回滚]。下面的管道显示了验证和金丝雀促销之间的关系。

## 自动化 CI/CD 管道如何帮助开发团队

在现代组织中，CI/CD 管道是将开发人员的代码投入生产的管道。软件工程是一种迭代练习，通过拥有自动化的 CI/CD 管道，工程师能够在没有人工干预的情况下执行管道。想象一下，每次您必须运行测试套件或为下一个环境准备基础设施时，都必须与外部团队进行协调。这将导致更少的迭代，并延长建立信心的步骤，使其在你的同事面前不显得愚蠢。

通过允许自助服务，开发人员可以更快地了解他们的更改需要什么样的严格性，并做出调整。DevOps 团队的一个主要目标是提高管道的可学性和可用性。某些由环境驱动的管道可能会让开发人员通过 pre-prod 一直执行，然后需要另一个管道才能到达生产环境。这将允许大量的迭代，直到开发团队熟悉管道。完全自动化的 CI/CD 管道将更进一步，并完全自动化到生产中。

## 自动化您的 CI/CD 渠道

有了 Harness [软件交付平台](https://harness.io/products/platform/)，任何人和任何组织都可以实现 CI/CD 管道的自动化。Harness 有助于解决最困难的 [CI/CD 挑战](https://harness.io/blog/ci-cd-challenges/)，例如新技术的引入、验证/促进您的部署，以及在失败情况下的行动。测试、批准和验证形式的所有编排都可以在 Harness 平台中轻松连接。通过利用[持续集成](https://harness.io/products/continuous-integration/)将代码的构建、测试和打包自动化到工件，并在几分钟内构建部署管道，同时通过利用[持续交付](https://harness.io/products/continuous-delivery/)将工件安全地部署到生产中。

准备好研究 CI/CD 解决方案了吗？立即获取一份我们的 [CI/CD 购买指南](https://harness.io/learn/ebooks/buyers-guide-for-ci-cd-ebook/)。