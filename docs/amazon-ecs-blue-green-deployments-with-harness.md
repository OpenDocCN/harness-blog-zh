# 亚马逊 ECS 蓝绿色部署|线束

> 原文：<https://www.harness.io/blog/amazon-ecs-blue-green-deployments-with-harness>

如何使用 Harness 简化 Amazon ECS 蓝绿色部署？了解蓝绿部署的优势&两种实施方式。

随着硬件变得越来越经济实惠，[蓝绿色部署](https://harness.io/blog/blue-green-canary-deployment-strategies/)变得越来越普遍。蓝绿色部署允许客户验证全新版本的应用程序，而完全不会干扰生产流量。

在蓝绿部署中，两个版本的应用程序共存。蓝色版本(生产版本)是接收生产流量的实际应用程序，而绿色版本(试运行版本)是可用于测试的空闲版本。

新的应用程序总是被创建为绿色版本。开发人员可以彻底测试这个版本的应用程序。一旦这个新版本通过验证并且可以安全地提升到生产环境中，它几乎可以立即成为生产版本。

现在，开发人员可以选择缩小旧版本的应用程序，或者保留一段时间。或者，如果需要，可以切换回生产版本。

**蓝绿调配的好处**

*   *如果在新版本(绿色版本)中发现问题，可将其用于故障排除，而生产流量仍不会中断，因为原始版本未被触及*
*   *几乎没有停机时间，因为生产和暂存应用程序之间的切换几乎是瞬间完成的。路线被简单地更新。*

**好消息…** Harness 现在为 Amazon ECS 蓝绿色部署提供一流的支持。为了更好地满足客户需求，Harness 提供了 2 种不同风格的 ECS 蓝绿色部署:

1.  使用弹性负载平衡器
2.  使用 Route53 DNS 更新

## 使用弹性负载平衡器(ELB)

通过为 ECS 配置弹性负载平衡器(ELB ),您可以在负载平衡器后面运行多个版本的服务。为了实现 ECS 蓝绿色部署，Harness 用户只需要使用两个不同的*目标组*，每个目标组都有自己的监听器。目标组是一个或多个 ECS 服务注册实例的逻辑分组。

在这个拓扑中，为弹性负载平衡器(ELB)定义了两个监听器，每个监听器监听不同的端口。侦听生产端口的侦听器将流量转发到与生产服务相关联的目标组，而另一个侦听器将流量转发到与登台服务相关联的目标组。

## 让我们看看它到底是如何工作的

**在部署开始之前**
考虑以下场景:
-当前服务于生产流量的 Amazon ECS 服务版本是“服务-0”
--“服务-0”配置有“目标-组-0”
-例如，在端口 80 上侦听的侦听器正在将流量转发到“目标-组-0”，(与“服务-0”相关联)。因此{HTTP:80}是生产侦听器，它将流量转发到生产 ECS 服务，" Service-0"

当前系统快照:

**创建新版本的服务**
现在，用户想要部署新版本的 ECS 服务，“Service-1”:
-用户将为这个新服务配置另一个目标组，比如“Target-Group-1”
-例如，在端口 8080 上侦听的侦听器被配置为将流量转发到这个目标组。这是一个阶段侦听器{HTTP:8080}，它在部署新版本后将流量转发到阶段 ECS 服务

系统快照:

因此，如果您注意到，生产流量是不间断的。

**更新侦听器规则**
在“服务-1”启动、验证并准备好升级到生产后，需要发生以下步骤:
-新创建的服务现在成为生产服务(蓝色版本)，并且当前生产服务成为登台服务(绿色版本)
-在更新侦听器规则后，通过更新与 ELB 关联的侦听器规则以将生产流量转发到目标组-1 并将流量登台到“目标组-0”

系统快照来实现此交换:

因此，现在，任何来自 ELB 的{HTTP:80}的生产流量都被转发到“目标组-1”(一组“服务-1”的注册实例)。此时，用户可以决定是缩减旧服务“服务-0”的规模，还是将其保持一段时间。

## ****如何轻松** **它看起来在驾驭****

**Harness 现在使用弹性负载平衡器为 ECS 蓝绿色部署提供一流的支持，并在验证/批准完成后负责切换侦听器规则。Harness 还允许用户使用 Splunk、AppDynamics、New Relic 等执行各种类型的验证。只需按照这些简单的步骤来创建 ECS 蓝/绿工作流。**

1.  **为 ECS 服务提供任务定义。**
2.  **使用 ELB 创建线束 ECS 蓝绿色工作流**
3.  **配置您的工作流设置。在这里，用户可以选择弹性负载平衡器、生产监听器和阶段监听器。Harness 将确定与阶段侦听器相关联的目标组，并将其用于正在创建的新 ECS 服务。**
4.  **一旦新版本通过验证，Harness 将更新监听器以切换到生产 ECS 服务。下面是整个工作流执行的样子:**

**因此，只需在 AWS 中一次性设置 ELB、目标组和侦听器规则，您就可以完全依靠 Harness 来执行任何未来的 ECS 蓝/绿部署。**

## **ECS 蓝绿部署与 53 号公路更新**

**将旧版本服务的生产流量交换到新版本服务的另一种方法是路由 53 DNS 交换。在这个架构中，我们的两个服务(蓝色和绿色)都有一个与之关联的服务发现服务。这将使服务与托管 DNS 区域中的 URL 相关联，该区域是在创建服务发现服务的命名空间时创建的。**

**假设服务与记录 **service_a.com** (蓝色服务)和 **service_b.com** (绿色服务)相关联。此外，我们在另一个名为 service.com**的托管区创造了另一项记录。现在，由于 Route 53 使用户能够以一定的权重获得 service.com 的 CNAME 记录。这些权重转化为每个服务上的流量百分比。****

**最初，*所有的*流量都流向蓝色服务。我们提出绿色服务并对其进行持续验证。

如果通过验证发现了问题，不会造成损害，因为我们的生产流量不会受到影响。**

**一旦我们对验证感到满意，我们就可以开始将 PROD 流量转移到服务的新版本。我们可以一步完成*或*我们可以分多个步骤完成。根据我们希望发送到新版本服务的流量比率，我们可以用适当的权重更新 DNS 记录。例如，我们可以向新服务发送 10%的流量。**

 **最终，我们可以将所有 PROD 流量迁移到绿色版本，并*交换*服务上的标签。**

 **这可以通过简单的线束实现:**

1.  **为 ECS 服务提供任务定义**
2.  **使用 DNS 创建线束 ECS BG 工作流(路线 53)**
3.  **设置您的工作流程**

**我们可以有任意多的**改变路线 53 权重**步骤。让我们看看工作流是如何工作的。**

## **Harness ECS 蓝绿色部署的显著特征**

**实现蓝绿部署有多种方式；然而，在线束设计和实现中有一些显著的特征:**

1.  ***没有到 PROD* 的登台流量:在某些实现中，一旦部署完成，PROD(蓝色)服务也将处理登台(合成)流量。这具有潜在的危险，因为如果某个错误导致 stage 流量激增或以某种方式不正常运行，生产可能会受到影响。这种危险不仅仅发生在展开期间，也可能发生在没有展开的时候。**
2.  ***流量交换前的连续验证(CV):*在某些情况下，在流量交换发生前，对绿色服务的验证是有限的。例如，这可能就像某个目标群体的健康检查验证一样简单。有了 Harness，在我们开始交换流量之前，我们就拥有了机器学习驱动的 CV 的全部能力。**

**萨蒂扬·尚克尔和阿德韦特·班达雷**