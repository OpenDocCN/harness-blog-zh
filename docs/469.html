<html>
<head>
<title>Build a Canary Deployment in 4 Mins with Harness CD | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用线束CD |线束，在4分钟内完成金丝雀部署</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/build-canary-deployment#0001-01-01">https://www.harness.io/blog/build-canary-deployment#0001-01-01</a></blockquote><div><p>在4分钟内从头开始构建全自动的canary部署。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>差不多十年前我们建立AppDynamics的时候，APM市场嘲笑我们。“不可能，以前听过所有这些说法”，“你不能这么做，这是作弊”，“BS，你不可能在4分钟内监控生产。”当时，监控市场上散落着30多家厂商和产品，坦率地说，这些厂商和产品都不能胜任这项工作。难怪人们不相信我们。</p><p>如果我告诉你，你可以使用Harness在4分钟内从零开始构建一个全自动的金丝雀部署，你会相信我吗？让我们试一试，看看会发生什么。<br/></p><figure class="w-richtext-align-center w-richtext-figure-type-image"/><h2>什么是金丝雀部署？</h2><p>Canary部署基本上减少了将新软件工件部署到生产中的范围、影响和风险。您不是同时在所有生产节点上部署一个新的工件，而是分阶段部署到这些节点的子集，每个阶段都经过验证，以确保工件和您的应用程序行为正常。</p><p>例如，您可能有一个跨生产堆栈的三阶段canary部署，如下所示:</p><figure class="w-richtext-figure-type- "/><p>在每个部署阶段之后，您将在执行下一个部署阶段之前，验证工件和应用程序的稳定性、性能和质量。如今，大多数组织都是由4-6名工程师手动执行这一验证步骤，他们每人花30-60分钟查看监控工具和日志文件，以确保一切正常。</p><p>在这篇博客中，我将向你展示如何在5分钟内自动完成整个过程。</p><h2>步骤1:创建新的应用程序</h2><p>转到:<strong>设置&gt;应用程序&gt;创建新应用程序</strong></p><p>创建一个新的应用程序(一个管理服务和工件的逻辑组)应该需要10秒钟。</p><figure class="w-richtext-figure-type- "/><h2>步骤2:创建新服务</h2><p>显然，我们需要一些东西来部署，所以让我们创建一个新的服务。</p><p>进入:<strong>设置&gt;您的应用&gt;添加服务</strong></p><p>输入<strong> My Microservice </strong>作为服务名，选择<strong> Docker Image </strong>作为工件类型。接下来，通过引用存储库中的特定工件来添加工件源。<strong>这需要20秒钟。</strong></p><figure class="w-richtext-figure-type- "/><h2>步骤3:创建新环境</h2><p>我们现在需要一个地方来部署我们的新服务和工件。</p><p>转到:<strong>设置&gt;您的应用程序&gt;添加环境</strong></p><p>将您的环境命名为<strong>生产</strong>，并选择<strong>生产</strong>作为环境类型。</p><p>接下来点击<strong>添加服务基础设施</strong>，选择<strong>我的微服务</strong>作为你的服务，然后选择<strong>亚马逊ECS </strong>作为部署类型(Harness也支持Kubernetes)。接下来，选择您的云提供商帐户、地区和想要部署到的集群。<strong>这个过程需要20秒钟。</strong></p><figure class="w-richtext-figure-type- "/><h2>步骤4:创建Canary工作流</h2><p>工作流告诉Harness如何将服务部署到环境中。</p><p>转到:<strong>设置&gt;您的应用&gt;添加工作流</strong></p><figure class="w-richtext-figure-type- "/><p>命名您的工作流程。选择<strong> Canary Deployment </strong>作为工作流类型，然后选择您刚刚创建的环境(生产)。这应该需要<strong>10秒钟。</strong></p><h2>步骤5:创建预先部署步骤</h2><p>现在，您将看到一个工作流向导，它将引导您完成canary部署设置。让我们添加一个简单的预部署步骤，它将通过电子邮件通知我们canary部署即将开始。</p><p>转到:<strong>+在<strong>预部署步骤</strong>下添加步骤</strong>，并选择<strong>电子邮件</strong></p><figure class="w-richtext-figure-type- "/><p>在<strong>收件人、主题和正文</strong>字段中输入详细信息。这应该需要你20秒钟。</p><p>Harness还为您提供了通过HTTP REST调用任何第三方工具的选项，此外还有Bamboo和Jenkins jobs之类的原生集成，您可能希望在任何部署之前就开始集成。</p><h2>步骤6:创建Canary部署阶段</h2><p>现在有趣的部分来了。我们扮演上帝，创造金丝雀。</p><p>让我们为微服务创建一个3阶段canary部署，分别部署到您环境的10%、50%和100%。</p><p>在<strong>部署阶段</strong>下点击<strong>+添加步骤</strong>创建阶段1。</p><figure class="w-richtext-figure-type- "/><p>选择您刚刚创建的<strong>我的微服务</strong>和<strong>生产</strong>环境。<strong>这需要5秒钟。</strong>现在点击<strong>升级容器</strong>并输入您希望在第一阶段升级的节点数量(10%)。这需要10秒钟。</p><figure class="w-richtext-figure-type- "/><p>我们现在需要指定Harness将如何验证作为canary阶段的一部分部署的服务。</p><p>单击<strong> +Add Verification </strong>并选择您的监控工具，它将为Harness提供所需的数据，以便在部署后验证您的服务。</p><figure class="w-richtext-figure-type- "/><p>除了Splunk、Elastic和Sumo Logic等日志工具之外，Harness还与AppDynamics和New Relic等APM工具进行了现成的集成。这应该会花费你30秒的时间。</p><p>对于每个验证源，您需要指定目标应用程序细节和默认时间段，以便Harness的无监督机器学习算法可以立即开始处理、分析和验证每个验证源提供的数据。</p><p>Harness不需要人工查看监控指标或日志数据来验证每个金丝雀阶段，而是可以通过比较每个金丝雀阶段前后的指标值和事件数据内容来完全自动化整个步骤。</p><figure class="w-richtext-figure-type- "/><p>对canary阶段2和3重复上述步骤，canary工作流向导应该如下所示:</p><figure class="w-richtext-figure-type- "/><p>此时，您有几个可选步骤需要考虑:</p><ul role="list"><li><strong>通知策略</strong> -您希望通过canary工作流程中的哪些事件通知他人？</li><li><strong>失败策略</strong> -如果你的金丝雀阶段验证失败了，你想采取什么步骤？默认情况下是自动回滚。</li><li><strong>工作流变量</strong> -您想要“模板化”这个canary工作流以便其他团队或服务可以使用相同的部署工作流吗？</li></ul><p>完成后，您的工作流应该如下所示:</p><figure class="w-richtext-figure-type- "/><h2>步骤7:为Canary工作流创建管道</h2><p>线束中的管道由串行或并行执行的一个或多个阶段组成，每个阶段引用一个特定的部署工作流。大多数Harness客户有一个4到5阶段的CD管道，允许他们在他们的开发、QA、准备和生产<a href="https://harness.io/blog/deployment-environments/" target="_blank">环境</a>中部署他们的服务/工件。对于我们的canary部署，让我们创建一个简单的单阶段管道来调用我们刚刚创建的Canary工作流。</p><p>转到:<strong>设置&gt;您的应用&gt;添加管道</strong></p><p>单击蓝色的<strong> + </strong>圆形按钮，添加一个名为<strong> Production </strong>的新管道阶段，并选择我们刚刚创建的canary工作流。这将花费你30秒的时间。</p><figure class="w-richtext-figure-type- "/><h2>步骤8:创建一个触发器来执行我们的CD管道</h2><p>最后一步是现在创建一个触发器，它将执行包含我们的canary工作流的管道。这很重要，因为您可能只想在特定条件下触发生产金丝雀工作流。</p><p>转到:<strong>设置&gt;您的应用&gt;添加触发器</strong></p><p>为您的触发器输入一个名称，然后为您的触发器选择New Artifact 上的条件<strong>，最后，选择您刚刚在步骤7中创建的管道。这将花费你1分钟的时间。</strong></p><figure class="w-richtext-figure-type- "/><p>就是这样！您已经完成了金丝雀部署的构建。</p><p>Harness与您现有的canary部署流程相比如何？如果您对评估Harness感兴趣，您可以今天就<a href="https://harness.io/products/continuous-delivery/" target="_blank">尝试我们的CD模块</a>。</p><p>干杯！</p><p>史蒂夫(男子名)</p><p>@伯顿说</p></div></div>    
</body>
</html>