# 利用 Kubernetes 进行内部部署|利用

> 原文：<https://www.harness.io/blog/harness-uses-kubernetes-for-on-premises-deployment>

Kubernetes 使用 Harness 进行内部部署—以快速、可靠、安全和可重复的方式自信地将代码部署到生产环境中。

我们在 Harness 的目标是让我们的客户尽可能快地部署他们的软件。我们的客户喜欢我们，因为他们可以放心地使用 Harness 将他们的代码部署到产品中。我们非常重视这一目标，并努力将这一目标融入我们的日常工作中。这意味着 Harness R&D 团队正以极快的速度不断推出新功能。这意味着一天多次推出代码。因此，我们的云解决方案始终保持最新和最强大的功能。

然而，管理我们内部版本的 Harness 变得很有挑战性。任何在企业软件领域工作过的人都知道我们在发布和升级周期方面所面临的困难。任何企业软件的内部解决方案都很少升级，可能一年几次，有时甚至更少。

这种现象有多种原因:

*   客户没有更频繁升级的节奏
*   升级管理是一项开销
*   为什么要触摸工作正常的东西？

从企业软件开发人员的角度来看，这可能会引入其他问题:

*   在很长一段时间内管理多个版本会变得非常昂贵
*   处理不同版本的 bug 修复是一场噩梦，会消耗 R&D 团队大量的时间
*   更长的发布周期意味着更多的突破性变化被推出，整个 R&D 团队在发布时处于紧张状态
*   在发布和采用之间总是有一个时间差，代码维护开销会显著增加。

当你一天多次频繁释放时，这些问题会成倍增加。那么，我们应该如何平衡较慢的内部版本和更频繁的基于云的版本呢？

为了应对这一挑战，Harness 采用了**现场连接**模式。
**内部联网**是我们为客户提供的首选交付机制，这些客户喜欢在自己的环境中安装线束作为内部解决方案。

该架构的中心思想是 Harness 将在客户环境中安装/升级和管理 Harness 的内部版本。在客户的环境中运行着一个代理，其唯一目的是管理 Harness 的内部安装。我们称这个代理为**驾驭** **大使**。

大使定期检查线束云是否有任何可用的升级，然后升级下游的内部线束安装。

联网的内部安装有两种类型:

*   **基于 Docker 的联网内部安装程序**
*   **基于 Kubernetes 的联网内部安装程序**

基于 Docker 的连接本地安装程序适用于当前环境中没有 Kubernetes 集群的客户。

这两种类型都提供了高可用性，并且可以根据客户的需求进行扩展/缩减。

本博客的其余部分将更多地关注基于 Kubernetes 的内部安装程序。

## **线束连接的 Kubernetes 内部架构**

上面显示了内部连接的 Kubernetes 线束架构的高级架构。客户必须在其防火墙隔离区环境中安装大使。**大使**实质上是[线束代表](https://ngdocs.harness.io/article/f9bd10b3nj-install-a-kubernetes-delegate)，其唯一目的是管理客户的线束 Kubernetes 现场安装。

大使安装在 DMZ 中的一个盒子上，该盒子具有到 **Harness Cloud** 的出站连接，从那里它可以将更新和工件以及入站连接拉到私有 Docker 存储库和为 Harness 微服务供应的 Kubernetes 集群。可以完全阻止它访问任何其他内部网络。

一旦工件被推送到私有 Docker 存储库中，大使就在配置的名称空间中协调线束安装/升级到 Kubernetes 集群中。

这种架构非常灵活。它可以适应不同客户环境中可能存在的细微变化。例如，在负载平衡器的 K8s 集群/入口控制器/网络配置中。

这种架构的另一个优点是没有秘密/凭证离开客户场所。证书(如 Docker 注册证书)位于大使箱上。大使将简单地使用凭证来执行安装/升级任务。

### **客户获胜:**

客户可以两全其美，即云的速度和内部的舒适性:

1.  由于软件是现场安装的，因此该设备可以满足诸如人工扫描、监控等安全要求。
2.  客户的数据永远不会离开公司。
3.  由于 Harness 安装在 K8s 上，我们获得了 K8s 必须提供的所有好处。
4.  更新可以根据客户的时间表推出。
5.  客户无需任何长时间的升级周期就能获得最新、最强大的功能，而升级周期是任何企业软件的典型特征。

### **线束获胜:**

1.  为新客户安装线束非常简单快捷。大多数安装从开始到结束不到一个小时。
2.  Harness 可以通过点击一个按钮为客户推送软件更新(如果您使用 Harness，这就是您可以推送软件更新的方式。本质上，内部部署的 Harness 就是使用 Harness 进行部署。它是如此的元，我知道)
3.  我们不再需要维护旧的发布分支/处理兼容性问题。这使得我们的开发周期更简单，我们的资源使用效率更高
4.  凭借我们独特的验证服务和 [24x7 全天候服务保障](https://harness.io/blog/harness-24-7-service-guard/)，我们从未发布过令人紧张的版本。

使用这种架构，我们目前能够以平均每周一次的速度向客户推送更新，并且可以根据客户的要求进行定制。

如果客户出于任何原因需要紧急更新，推送更新就像点击按钮一样简单。

这种架构不仅限于部署线束。**您可以使用这种模式利用 Harness 将您的内部企业软件部署到您的客户。**

简化软件交付是我们的使命，我们认为使用这种模式向我们的企业客户交付线束证明了线束能够快速移动而不会断裂。

干杯！
鲁沙巴沙。