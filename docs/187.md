# Google 计算引擎| Harness 的智能云自动停止

> 原文：<https://www.harness.io/blog/autostopping-google-compute-engine>

自动停止再次罢工！以下是如何使用它的谷歌计算引擎。本文包含分步指导。现在就试试吧！

云支出正在上升，如果管理不当，它可能会成为公司资源的负担。我们已经看到，通过智能管理非生产工作负载上的闲置资源，可以节省很大一部分成本。[空闲资源](https://harness.io/blog/cloud-cost-management/idle-resources/)是那些正在运行但没有主动接收流量的资源(如虚拟机)。因此，运行它们被认为是云浪费。

我们已经看到，如果这些资源管理得当，公司每月可以节省 70%以上的非生产云计算成本。我们在之前的一篇关于 Kubernetes 集群自动停止规则的博客中讨论了如何为 Kubernetes 做这件事。

利用智能云自动停止是一种智能的自动化方式，通过有效管理云资源的空闲时间来动态优化云资源的使用，从而协调非生产工作负载的使用。自动停止目前支持 AWS、Azure、GCP 和 Kubernetes 集群。

## 自动停止规则的优势

*   自动检测空闲时间并关闭空闲资源。
*   配置规则以调度资源，避免在非高峰时段浪费资源。
*   检测到流量后，资源会自动打开，从而减少工时并节省云成本。
*   创建规则之间的依赖关系，以管理服务于特定目的的基础架构。

## 如何为 Google 计算引擎虚拟机创建自动停止规则

这包括两个主要步骤:

1.  创建一个负载平衡器，用于路由和检测到要管理的虚拟机的流量。
2.  创建一个规则，该规则将映射要使用上一步中创建的负载平衡器管理的虚拟机。

### 自定义负载平衡器

这包括以下步骤:

*   **提供域名**。这将用于将流量路由到负载均衡器。与云 DNS 的一流集成正在进行中，以进一步帮助您将 DNS 映射到自定义负载平衡器。自定义负载平衡器也可以放在基础设施内的流量路径中。

*   **配置自定义负载平衡器。**由于定制负载平衡器是由 Harness 创建和管理的，因此您可以选择自己喜欢的实例类型。负载平衡器需要与其管理的虚拟机位于同一个 VPC 中。多个自动停止规则可以利用单个负载平衡器来管理跨不同区域和分区但在同一 VPC 内的虚拟机。

### 自动停止规则

这包括以下 3 个步骤:

*   **配置自动停止规则。**根据您的喜好选择一个理想的*空闲时间*，不使用时自动关闭虚拟机。选择要管理的虚拟机。他们需要在同一个*区域。*

*   **设置 DNS 链接。**选择用于规则的负载平衡器。还要在负载平衡器上配置路由和健康检查。您也可以输入用于路由的自定义域。

*   **查看配置。**验证所有细节是否正确，然后确认创建规则。

成功保存和创建规则后，您可以利用自动停止来管理这些计算引擎虚拟机。只要它们的空闲时间超过配置的空闲时间，自动停止就会自动关闭它们。当下次使用配置的 DNS 链接访问虚拟机时，自动停止将为用户实时显示该虚拟机。

## 谷歌计算引擎的自动停止是如何工作的

实现自动停止涉及两个操作来解决优化空闲资源的问题:

1.  启动/停止主机虚拟机。
2.  检测流向主机的流量。

这最好通过使用自定义负载平衡器来执行，它会将流量路由到已配置的虚拟机。当虚拟机处于停止状态时，用户会看到一个默认的进度页面，在此期间，虚拟机会重新启动，我们称之为“预热”使用定制的负载平衡器，所有这些都是可能的。

自动停止是在以下组件的帮助下实现的:

*   自定义负载平衡器
*   使者
*   专有服务
*   驾驭 SaaS

### 自定义负载平衡器

可以将单个自定义负载平衡器配置为用于属于同一 VPC 的多个自动停止规则。VPC 跨越多个区域，这使我们可以通过为多个规则使用单个定制负载平衡器来节省成本。由于本机 GCP HTTP(s)负载平衡器处于测试阶段，因此选择了自定义实现而不是本机负载平衡器。推出不受一个负载平衡器中可配置的规则数量限制的定制负载平衡器也是经济高效的。

这个定制的负载平衡器由 Envoy 和其他专有服务组成。

### 特使代理

Envoy 是一个 L7 代理，设计用于大型现代面向服务的架构。对于任何应用程序来说，它通常都是作为边站运行的，从而抽象出网络拓扑，因此被恰当地称为特使网格。它预先构建了对滤波器链的支持，以支持复杂的操作。简而言之，过滤器链更像是任何 API 服务设置中的中间件链。

虽然这不是自动停止中使用的内容，但下面是在端口 8080 上运行但在端口 80 上侦听的服务的静态配置示例:

静态 _ 资源:
监听器:
-名称:监听器 _0
地址:
套接字 _ 地址:{地址:127.0.0.1 port _ value:80 }
filter _ chains:
-filters:
-name:envoy . filters . network . http _ connection _ manager
typed _ config:
" @ type ":type . Google APIs . com/envoy . extensions . filters . network . http _ connection _ manager . v3 . httpconnection manager
stat _ prefix:ingress _ http
codec _ type:AUTO
route _ config:
name:local _ route
virtual

特使由集群和监听器组成。集群是 AWS ALB 目标组的目标等价物。侦听器代表传入端口，请求将从该端口传入，并根据路由配置和路由路径匹配被路由到集群。可以在监听器中配置过滤器来执行某些操作。

Harness 智能云自动停止将 Envoy 和其他专有服务用于自定义负载平衡器，该平衡器将流量路由到已配置的 Google 计算引擎虚拟机。

## Google 计算引擎自动停止入门

*   [报名参加演示](https://harness.io/products/cloud-cost/)，一名线束专家将帮助您开始使用线束云成本管理。
*   查看这些[文档](https://ngdocs.harness.io/article/4brkwfy8yt-create-auto-stopping-rules-for-gcp)，了解更多关于为谷歌计算引擎创建自动停止规则的信息。