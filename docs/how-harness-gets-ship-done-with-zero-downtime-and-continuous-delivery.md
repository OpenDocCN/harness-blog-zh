# 如何在零停机时间和 CD |吊带的情况下完成运输

> 原文：<https://www.harness.io/blog/how-harness-gets-ship-done-with-zero-downtime-and-continuous-delivery>

零停机时间的 CD:让我们从 Harness 工作流引擎的简化架构概述开始。立即了解更多信息。

这是工程师对我们如何实现零停机、零影响部署的看法。让我们从与本主题相关的 Harness 工作流引擎的简化架构概述开始。

## 概观

Harness 有一个名为 ***Manager*** 的关键组件，负责编排管道和工作流的执行。管理器是一个横向扩展的多租户服务，它与 ***代表*** 协调工作流步骤的执行。

委托是在客户的前提下运行的管理流程。这是 Harness 架构的一个关键部分，它使 Harness 能够在客户环境中编排复杂的工作流，而无需访问客户资源(只有客户代表需要访问客户资源)。

下面是一个管道执行示例:

图中的每个方框代表一个州。对于与客户资源交互的状态，执行需要经理和客户代表之间的沟通。因为只有代表可以访问客户资源，所以他们是做实际工作的人。

下面的框图说明了一个这样的状态的执行流程。方块 **M** 代表管理进程，方块 **D** 代表委托进程。

1.  执行/通知事件已排队
2.  事件出列并由管理器处理
3.  [如果需要],经理创建一个任务[对代表执行]
4.  任务由经理处理
5.  任务被分配给代理人。委托开始执行。
6.  将任务状态报告委托给经理

如果状态机不处于终端状态，流程返回步骤 1。

## 主要挑战

Manager 是一个多租户服务，运行在一个集群中。委托是在客户处运行的独立流程。可能会有数千个委托流程(每个客户有多个委托)，随着我们的发展，这一数字还会增加一个数量级。代表们坐在不同环境和不同网络连接质量的客户场所。虽然作为中央服务的管理器可以更可靠、更快速地升级，但是代理的升级过程需要不同的时间来收敛。这给我们的升级过程带来了独特的挑战。

为了可靠地执行，要求执行中涉及的所有进程相互兼容。

以下两个图表显示了执行中涉及不兼容版本的情况(颜色代表服务的特定版本):

**上图描述了一个场景，其中代表使用的版本不同于经理。**

**上图描述了一个场景，其中一个管理器实例与另一个管理器实例的版本不同。**

此外，对于 Harness SaaS，在任何给定时间都有许多客户正在执行工作流。在客户没有持续活动的情况下，永远没有升级线束的好时机。当我们升级 Harness 本身时，我们需要确保这些执行不受影响。

## 我们的方法:支持多个活动版本

为了实现无缝升级，我们采用了支持多个活动版本的方法。执行中涉及的所有实体都知道它们的版本；并且只有兼容的版本才参与执行。

下图说明了这一点。请注意，彩色实体是版本感知的。从管理器到委托的调用被版本化(使用 HTTP 头),队列和任务实体被版本化，以便只有兼容的管理器进程才能处理它们。

让我们放大到经理端实现。下图描述了 Manager 的流量，这是一个 Kubernetes 部署。它有一个负载平衡器、入口控制器、Kubernetes 服务和管理器单元。

我们为我们部署的每个管理器版本创建特定于版本的部署、服务和入口对象。由于基于 HTTP 头的入口规则，来自代理的流量到达相同版本的管理器 pod。此外，我们还有一个主要服务，它每次指向一个特定版本的管理器 pod。所有客户流量都流向主服务。

当需要部署一个新版本时，我们让旧版本保持运行，同时在管理者和代表端启动新版本(在上图中以绿色显示)(这类似于[蓝绿色](https://harness.io/blog/istio-support-for-blue-green-and-canary/)，但更灵活，因为它可以有两个以上的活动版本)。

所有现有的执行都在以前的版本上继续进行，没有中断。由于主服务仍然指向旧版本，因此还没有客户请求命中新版本。这使代表们有充分的机会使用新版本来启动流程，并向新经理注册。

当验证完成时，新版本已准备就绪，可以为客户请求提供服务，所有代表的连接都已建立。此时，主服务被更新以指向新版本，并且来自用户的新呼叫开始去往新版本。见下图。

请注意，我们将长期保留旧版本的管理器和代理。在旧版本上开始的执行在同一版本上继续进行。这些执行可能需要几个小时才能完成(例如，带有验证的长管道，触发 Jenkins 作业，并等待它们完成)。

保留旧版本给了我们额外的即时回滚能力。由于旧版本的所有代理仍然运行并连接到旧版本的管理器，回滚只需要将主服务翻转回旧版本的管理器。这为我们节省了启动前面讨论的委派流程的预热时间。

在代理端，我们有类似的并行运行多个版本的能力。代理盒上的代理[称为观察者]获取所需版本的目标状态，并确保这些版本在代理盒上启动并运行。每个委托进程都使用基于 HTTP 头的路由连接到相应版本的管理器。

虽然我们有一种机制可以一次保持多个版本活动，但为了操作简单，在任何给定的时间都保持两个版本(n+1 版本展示拆除 n-1)。

当然，我们使用 Harness 来部署 Harness，下面显示了我们自己的部署的执行:

部署步骤是:

1.  拆卸经理/代表的 n-1 版本
2.  部署 n+1 版本
3.  验证 n+1 上的服务健康状况
4.  将主开关切换到 n+1

这种机制使我们能够实现零停机时间，随时升级线束。我们的生产部署每天进行一次。回滚机制在过去 4 周内使用了两次。

我们在不断发展我们的系统，并乐于分享我们的知识。

普内特&布雷特。