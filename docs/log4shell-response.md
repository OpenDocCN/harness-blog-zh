# 日志 4 外壳响应|线束

> 原文：<https://www.harness.io/blog/log4shell-response>

Harness 对最近 log4shell 漏洞的回应。了解我们如何补救这种情况并确保您的安全。

2021 年 12 月 9 日，安全研究人员在 Java 日志库 *log4j* 中公布了一个为期 0 天的漏洞，该漏洞通过记录特定字符串导致远程代码执行(RCE)。该漏洞适用于版本 2.0 < = log4j < = 2.14.1，并在常见软件应用程序中广泛使用。

CVE-2021-44228，被称为 *Log4Shell* ，可能允许攻击者控制日志消息或日志消息参数，并在启用消息查找替换时执行任意代码。我们一了解到这个漏洞，Harness 就开始了大范围的发现工作，以识别和验证 log4j 在我们的代码库中的存在。

## 补救工作

Harness 的事故响应流程旨在快速通知相关利益相关方，并实现对运营或安全事件的快速响应。在这种情况下，我们的 IR 流程包括来自工程、安全、客户成功和法律部门的代表。

我们很快发现了 log4j-api:2.12.1 和 log4j-to-slf4j:2.12.1 支持我们的主要 SaaS 环境组件的几个实例。Harness 使用这些库来收集和分类由我们的平台生成的各种消息。我们接下来的步骤是确定补救的优先级并触发我们的事件响应流程，首先是修补面向外部服务的漏洞。

[Harness 微服务部署](https://medium.com/harness-engineering/the-importance-of-knowing-your-customer-setup-4fe9b300df87)在谷歌云平台(GCP)的 Kubernetes 集群上完成。随着 Harness 的不断扩展，我们将微服务部署到 GCP 的多个 Kubernetes 集群，这些集群对客户数据进行水平分区，以确保我们的应用程序的性能。

我们还维护了一个 API 网关微服务，它作为一个反向代理，将客户请求路由到正确的集群。这个网关是我们打补丁的第一优先，我们能够成功地应用一个修补程序，而不会对性能或可用性产生任何影响。

不久之后，我们系统地将 log4j 2.15.0 补丁应用于我们三个生产 k8s 集群的后端服务。你可以在这篇博文的[中了解更多关于我们的部署和生产架构的信息。](https://medium.com/harness-engineering/harness-deployment-architecture-a667fe359342)

虽然 Harness 委托不支持 HTTP/HTTPS 终止(或运行任何嵌入式 web 服务),并且此漏洞不会对我们客户环境中的委托部署产生任何直接影响，但我们将很快用相同版本的库升级我们的委托。

## 更新日期:2021 年 12 月 17 日

Harness 知道 [CVE-2021-45056](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) ，这可能允许控制线程上下文映射的攻击者绕过 log4j 更新 2.15.0 中提供的缓解措施。阿帕奇[将这个 CVE](https://logging.apache.org/log4j/2.x/security.html) 归类为低(3.7)。

Apache 已经推荐将 log4j 库额外升级到版本 2.16.0。此更新目前正在我们的 QA 周期中，我们在 12 月 22 日星期三的标准主要版本将包括跨 SaaS 环境的 *log4j 2.16.0* 和 Harness delegate。

12 月 15 日，Harness 发布了我们的本地服务的更新版本(73021)，其中包含所有管理服务和委托中的 log4j 2.16.0 更新。客户可以通过正常机制获得更新的映像。

UTC 时间 12 月 17 日，Harness 向 SaaS 生产 1 和生产 2 实例发布了版本 73119。在此版本中，SaaS 的线束委托现在包括 log4j 版本 2.15。

## 更新日期:2021 年 12 月 20 日

12 月 17 日，安全研究人员发现了 2.15.0 中引入的 log4j 缓解的旁路，如果被成功利用，将允许远程代码执行。

由于严重性和影响的增加，Harness 立即在我们的生产环境中加快了 log4j 2.16.0 补丁的发布。截至 12 月 18 日，所有生产集群和网关服务都已成功修补到 2.16.0。

12 月 18 日，Apache 发布了 2.17.0，缓解了 [CVE-2021-4104](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4104) (影响 log4j 1.2)和 [CVE-2021-45105](https://logging.apache.org/log4j/2.x/security.html) (影响 log4j-core JAR)。

我们尚未检测到受影响组件在我们的环境中的使用。目前，CVE-2021-4104 和 CVE-2021-45105 中确定的风险不适用。我们将继续评估新补丁的适用性，并监控 Apache 的安全页面是否有任何更新。