# 迁移到线束特征标志:我们的技术之旅|线束

> 原文：<https://www.harness.io/blog/migrating-feature-flags-technical-journey>

最近，我们发布了一篇博文，解释了为什么我们从自主开发的特性标志解决方案迁移到利用特性标志。虽然那篇文章涵盖了我们迁移的许多原因，但我们希望分享技术之旅，包括我们遇到的障碍以及迁移是什么样的。

最近，我们发布了一篇关于[为什么我们从自主开发的特性标志解决方案中迁移](https://harness.io/blog/feature-flags/migrating-feature-flags/)来利用特性标志的博文。虽然那篇文章涵盖了我们迁移的许多原因，但我们希望分享技术之旅，包括我们遇到的障碍以及迁移是什么样的。

开发线束特征标志的主要驱动因素之一是为我们的内部工程团队解决问题。我们当前的特征标志机制在设计和功能上非常简单。

在这篇博客的剩余部分，我将把我们自己开发的解决方案称为**本地特征标志**，更新后的机制将是**利用特征标志**。

当我们迁移到 Harness 特性标记时，我们想要达到的目标之一是让 Harness 的特性标记更加强大——但同时，为开发人员保持同样的简单性。

### 具有本地特征标志的世界状态

在 Harness 讨论特征标志的历史是很重要的。我相信这个故事会引起许多组织的共鸣。

特性标志是大约三年前的一个周末由一名工程师作为一个附带项目开发的，作为一项临时服务来满足一些紧急需求。不久，它迅速发展成为一项关键服务，几乎被所有应用程序使用。

我们还将用户群从开发人员扩大到产品经理、客户成功和 QA。我们不得不为一个软件工程师投资大约三个月来构建一个前端服务，仅仅是为了管理功能标志。即使有这样的投资，这个工具也只能进行简单的特性标记管理。

局部特征标志仅支持简单的布尔特征标志。可以全局或按客户启用/禁用标志。当开发人员想要添加一个新的特性标志时，他们会在这个 enum 类中添加一个条目。在应用程序启动时，FeatureFlagService 会将所有新标志同步到本地数据库。

对功能标志的任何更新将通过 API 完成，以添加客户特定的覆盖或在全局级别启用/禁用标志。

FeatureFlagService 会每隔几分钟刷新一次本地内部缓存，feature flag 的新更新值会反映在应用程序中。

一些观察结果:

*   很简单。特性标志是代码库的一部分，这对开发人员来说很直观。添加一个新的特性标志就像在这个 enum 类中添加一个条目一样简单。
*   每个环境都需要独立管理。我们无法同时管理所有环境的功能标志。
*   这项服务能力有限。我们无法添加更详细的规则来管理功能标志。

### 我们技术之旅的迁移计划

推出特性标志管理的变化，虽然看起来很简单，但仍然是一个非常关键的变化。这几乎类似于改变整个平台中的基础设施层。这种改变总会遇到阻力，而且理由很充分:

*   如果工作正常，为什么要改变呢？古老的格言，“如果它没坏，就不要修理它！”
*   说服 SREs/Ops 我们是否知道它不会造成中断。
*   说服所有开发人员采用这种新机制。

为了解决这些问题，我们决定遵循一个三步流程。这种分阶段的方法使我们能够降低在整个平台上进行这种改变的相关风险。

#### 将本地特征标志移植到利用特征标志:

我们在 Harness Feature Flags 中创建了一个项目，还准备了用于 QA、试运行和生产的所有环境。

我们使用以下步骤映射了将本地特征标志迁移到线束特征标志的机制。首先，我们在主应用程序中包含了一个用于管理 API 的 Java SDK(目前处于私有测试阶段)。

Admin SDK 允许我们使用 Harness 功能标志服务器管理功能标志。我们将本地特征标志机制映射到线束特征标志中的等效表示。我们在主应用程序中编写了一个简单的迁移服务，它将在启动时为每个特性标志运行以下机制。

这允许我们将所有现有的特性标志移植到 Harness 中。

#### 在审核模式下运行线束特征标志

在我们成功地将所有特性标志导入到 Harness 之后，我们准备开始使用它来管理特性标志；然而，就像任何新软件一样，我们必须向我们的工程领导证明我们已经为黄金时间做好了准备。

为此，我们决定首先在审计模式下测试线束特性标志。

我们将线束特征标志与本地特征标志系统并行运行，其中线束特征标志仅记录最终值。

如果本地和线束特征标志系统之间的值不匹配，我们会将其记录为错误。

这让我们能够验证 SDK 的:

1) SDK 精度。任何不匹配都可能是由于服务器端问题或 SDK 错误造成的。

2)性能。我们运行了 6 个以上的环境，评估了 200 多个功能标志，跟踪了大约 4000 个客户帐户。在审计模式下运行这个系统让我们确信 SDK 不会降低我们的目标应用程序的速度。我们在审计模式下运行系统超过 4 周。这些数据给了我们前进到下一步也是最后一步的信心。同时，为了准备接下来的步骤，我们在代码库中添加了一个配置，以便在使用 Harness 特性标志和使用本地特性标志之间进行切换。

我们开始在 QA 中使用线束特征标志。我们为所有 QA 环境打开了它，并让 QA 团队从我们的管理控制台管理特性标志。在这一点上，我们不赞成使用本地特性标志，我们已经完全转而在所有 QA 环境中利用特性标志。我们在 QA 中又监测了一周的使用情况。

#### 自动特征标志创建机制

为了保持与本地 FeatureFlags 机制相同的简单性，我们在代码中添加了一个小的增强，以自动将新的功能标志同步到我们的 Harness 功能标志服务器。这一增强利用了已经集成的 admin SDK 和之前编写的迁移服务来将新标志同步到 Harness Feature Flags 服务器。

这种同步仅在我们的 QA 环境中启用，确保功能标志在生产中开放之前可用并准备好进行管理。

该同步机制的整体流程图如下:

#### 生产首次展示

我们决定咬紧牙关，在周末转而使用特色旗帜。我们打开全局配置，开始使用线束特征标志。第 2 步和第 3 步给了我们足够的信心，我们不会错过任何东西，并且我们不会对产品的推出产生任何影响。

### 今天利用特征标志

如今，Harness Feature Flags 管理着 6 个环境和 4000 多个客户的 200 多个功能标志。

今天，我们已经成功地将 Harness 特性标志用于 Harness 中的所有产品，同时保持了一致而简单的开发人员体验。

目前，我们正在积极监控所有相关方(运营、产品经理、质量保证和开发人员)对功能标志的使用，并继续致力于改善每个人的功能标志管理体验。以下是我做出这种颠覆性改变的要点:

1.  总是计划分阶段做出改变。
2.  收集足够的数据来做出客观的决定。
3.  一旦你开始了这个过程，并且有足够的指标来支持这个决策，就要坚持到底。
4.  沟通是关键。确保所有利益相关者都参与进来，并考虑他们的顾虑。

感谢大家和我们一起踏上这段旅程！[利用功能标志](https://ngdocs.harness.io/article/0a2u2ppp8s-getting-started-with-continuous-features)已经改善了许多工程师的生活，我们也希望改善你们的生活。升级您的特色旗帜游戏- [今天就预订一个演示](https://harness.io/demo/)。