# 使用线束 CD |线束，在 4 分钟内完成金丝雀部署

> 原文：<https://www.harness.io/blog/build-canary-deployment>

在 4 分钟内从头开始构建全自动的 canary 部署。

差不多十年前我们建立 AppDynamics 的时候，APM 市场嘲笑我们。“不可能，以前听过所有这些说法”，“你不能这么做，这是作弊”，“BS，你不可能在 4 分钟内监控生产。”当时，监控市场上散落着 30 多家厂商和产品，坦率地说，这些厂商和产品都不能胜任这项工作。难怪人们不相信我们。

如果我告诉你，你可以使用 Harness 在 4 分钟内从零开始构建一个全自动的金丝雀部署，你会相信我吗？让我们试一试，看看会发生什么。

## 什么是金丝雀部署？

Canary 部署基本上减少了将新软件工件部署到生产中的范围、影响和风险。您不是同时在所有生产节点上部署一个新的工件，而是分阶段部署到这些节点的子集，每个阶段都经过验证，以确保工件和您的应用程序行为正常。

例如，您可能有一个跨生产堆栈的三阶段 canary 部署，如下所示:

在每个部署阶段之后，您将在执行下一个部署阶段之前，验证工件和应用程序的稳定性、性能和质量。如今，大多数组织都是由 4-6 名工程师手动执行这一验证步骤，他们每人花 30-60 分钟查看监控工具和日志文件，以确保一切正常。

在这篇博客中，我将向你展示如何在 5 分钟内自动完成整个过程。

## 步骤 1:创建新的应用程序

转到:**设置>应用程序>创建新应用程序**

创建一个新的应用程序(一个管理服务和工件的逻辑组)应该需要 10 秒钟。

## 步骤 2:创建新服务

显然，我们需要一些东西来部署，所以让我们创建一个新的服务。

进入:**设置>您的应用>添加服务**

输入 **My Microservice** 作为服务名，选择 **Docker Image** 作为工件类型。接下来，通过引用存储库中的特定工件来添加工件源。**这需要 20 秒钟。**

## 步骤 3:创建新环境

我们现在需要一个地方来部署我们的新服务和工件。

转到:**设置>您的应用程序>添加环境**

将您的环境命名为**生产**，并选择**生产**作为环境类型。

接下来点击**添加服务基础设施**，选择**我的微服务**作为你的服务，然后选择**亚马逊 ECS** 作为部署类型(Harness 也支持 Kubernetes)。接下来，选择您的云提供商帐户、地区和想要部署到的集群。**这个过程需要 20 秒钟。**

## 步骤 4:创建 Canary 工作流

工作流告诉 Harness 如何将服务部署到环境中。

转到:**设置>您的应用>添加工作流**

命名您的工作流程。选择 **Canary Deployment** 作为工作流类型，然后选择您刚刚创建的环境(生产)。这应该需要**10 秒钟。**

## 步骤 5:创建预先部署步骤

现在，您将看到一个工作流向导，它将引导您完成 canary 部署设置。让我们添加一个简单的预部署步骤，它将通过电子邮件通知我们 canary 部署即将开始。

转到:**+在**预部署步骤**下添加步骤**，并选择**电子邮件**

在**收件人、主题和正文**字段中输入详细信息。这应该需要你 20 秒钟。

Harness 还为您提供了通过 HTTP REST 调用任何第三方工具的选项，此外还有 Bamboo 和 Jenkins jobs 之类的原生集成，您可能希望在任何部署之前就开始集成。

## 步骤 6:创建 Canary 部署阶段

现在有趣的部分来了。我们扮演上帝，创造金丝雀。

让我们为微服务创建一个 3 阶段 canary 部署，分别部署到您环境的 10%、50%和 100%。

在**部署阶段**下点击**+添加步骤**创建阶段 1。

选择您刚刚创建的**我的微服务**和**生产**环境。**这需要 5 秒钟。**现在点击**升级容器**并输入您希望在第一阶段升级的节点数量(10%)。这需要 10 秒钟。

我们现在需要指定 Harness 将如何验证作为 canary 阶段的一部分部署的服务。

单击 **+Add Verification** 并选择您的监控工具，它将为 Harness 提供所需的数据，以便在部署后验证您的服务。

除了 Splunk、Elastic 和 Sumo Logic 等日志工具之外，Harness 还与 AppDynamics 和 New Relic 等 APM 工具进行了现成的集成。这应该会花费你 30 秒的时间。

对于每个验证源，您需要指定目标应用程序细节和默认时间段，以便 Harness 的无监督机器学习算法可以立即开始处理、分析和验证每个验证源提供的数据。

Harness 不需要人工查看监控指标或日志数据来验证每个金丝雀阶段，而是可以通过比较每个金丝雀阶段前后的指标值和事件数据内容来完全自动化整个步骤。

对 canary 阶段 2 和 3 重复上述步骤，canary 工作流向导应该如下所示:

此时，您有几个可选步骤需要考虑:

*   **通知策略** -您希望通过 canary 工作流程中的哪些事件通知他人？
*   **失败策略** -如果你的金丝雀阶段验证失败了，你想采取什么步骤？默认情况下是自动回滚。
*   **工作流变量** -您想要“模板化”这个 canary 工作流以便其他团队或服务可以使用相同的部署工作流吗？

完成后，您的工作流应该如下所示:

## 步骤 7:为 Canary 工作流创建管道

线束中的管道由串行或并行执行的一个或多个阶段组成，每个阶段引用一个特定的部署工作流。大多数 Harness 客户有一个 4 到 5 阶段的 CD 管道，允许他们在他们的开发、QA、准备和生产[环境](https://harness.io/blog/deployment-environments/)中部署他们的服务/工件。对于我们的 canary 部署，让我们创建一个简单的单阶段管道来调用我们刚刚创建的 Canary 工作流。

转到:**设置>您的应用>添加管道**

单击蓝色的 **+** 圆形按钮，添加一个名为 **Production** 的新管道阶段，并选择我们刚刚创建的 canary 工作流。这将花费你 30 秒的时间。

## 步骤 8:创建一个触发器来执行我们的 CD 管道

最后一步是现在创建一个触发器，它将执行包含我们的 canary 工作流的管道。这很重要，因为您可能只想在特定条件下触发生产金丝雀工作流。

转到:**设置>您的应用>添加触发器**

为您的触发器输入一个名称，然后为您的触发器选择 New Artifact 上的条件**，最后，选择您刚刚在步骤 7 中创建的管道。这将花费你 1 分钟的时间。**

就是这样！您已经完成了金丝雀部署的构建。

Harness 与您现有的 canary 部署流程相比如何？如果您对评估 Harness 感兴趣，您可以今天就[尝试我们的 CD 模块](https://harness.io/products/continuous-delivery/)。

干杯！

史蒂夫(男子名)

@伯顿说