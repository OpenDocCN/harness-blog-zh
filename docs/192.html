<html>
<head>
<title>Introducing Recommendations API: Find Potential Cost Savings Programmatically | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>介绍建议API:以编程方式寻找潜在的成本节约|利用</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/recommendations-api#0001-01-01">https://www.harness.io/blog/recommendations-api#0001-01-01</a></blockquote><div><p>有了推荐API，现在有了收集Harness CCM提供的见解和建议的编程方式。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>Harness的<a href="https://harness.io/platform/cloud-cost-management/" target="_blank">云成本管理(CCM)平台</a>是一个强大的平台，旨在节省您在公共云中的成本。合理确定资源大小并最终装箱是增加密度和降低成本的关键。随着时间的推移，跟踪使用情况并了解趋势可能是一项数学练习，并保持对指标高保真度的跟踪。<a href="https://harness.io/blog/introducing-cloud-cost-recommendations/" target="_blank">利用CCM建议</a>允许通过围绕Kubernetes工作负载提出的谨慎<a href="https://developer.harness.io/docs/cloud-cost-management/use-cloud-cost-management/ccm-recommendations/home-recommendations/" target="_blank">建议</a>来消除繁重的工作。</p><p>随着推荐API的引入，现在有了编程方式来收集Harness CCM提供的见解和建议。通过一个<a href="https://harness.io/blog/graphql-harness-your-way/" target="_blank"> GraphQL </a>查询，您可以检索CCM正在观察的每个Kubernetes集群的结果。</p><h2>按API列出的Kubernetes建议</h2><p>实施<a href="https://harness.io/blog/implementing-cloud-cost-savings/" target="_blank">您的第一个建议</a>，收集CCM提供的见解可以让CCM观察到的每个工作负载受益。<a href="https://developer.harness.io/docs/first-gen/cloud-cost-management/cost-explorer-apis/workload-recommendations-api/" target="_blank">建议API </a>是一种在Kubernetes集群中收集见解并在整个企业中扩展成本节约的好方法。</p><p>通过进入Setup - &gt; Harness API Explorer，利用<a href="https://developer.harness.io/docs/first-gen/firstgen-platform/techref-category/api/harness-api-explorer/" target="_blank"> API Explorer </a>，您可以执行所需的GraphQL查询。在制定查询时，您需要决定希望在查询中接收多少百分比的采样，然后过滤适当的结果作为查询变量。</p><p>如果您不熟悉如何进行采样，采样使用实际的CPU和内存利用率，并使用直方图方法进行分析。深入研究建议UI有助于直观地了解您希望从建议API中获得的抽样百分比。</p><p>通过调整利用率采样，您可以调整建议，使其更倾向于成本优化的工作负载或性能优化的工作负载。通过这种方式，您不仅仅是信任一个合理调整的建议，您还可以自己定义建议中包含哪些数据，从而节省进行数据验证和提出替代建议的时间和精力。</p><figure class="w-richtext-figure-type- "/><p><em>显示百分位数的建议用户界面。</em></p><h3>执行您的第一个建议API查询</h3><p><a href="https://developer.harness.io/docs/first-gen/firstgen-platform/techref-category/api/harness-api" target="_blank">线束文档</a>提供了一个优秀的GraphQL查询来帮助您。唯一需要优化的两个部分是查询中抽样的百分比和查询变量中要过滤的数据。</p><p>可以将百分比“<em> p50 </em>”元素更改为另一个采样百分比。</p><figure class="w-richtext-figure-type- "/><p>查询:</p><p>query($ filters:[工作负载过滤器]，$limit: Int！){<br/>k 8 sworkloadverences(filters:$ filters，limit:$limit){ <br/>节点{ <br/>预计节省量<br/>命名空间<br/>工作负荷名称<br/>集群名称<br/>工作负荷类型<br/>容器重新推荐{ <br/>容器名称<br/>当前{ <br/>请求{ <br/>名称<br/>数量<br/> } <br/>限制{ <br/>名称<br/>数量<br/> } <br/> } 【T19</p><p>使用查询变量，您可以添加/删除/修改过滤器以显示更多或更少的结果。在本例中，删除了特定集群的过滤器，因此所有具有<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank">部署</a>的集群都进入默认的<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank">命名空间</a>。可以很容易地删除名称空间过滤器，以便显示所有集群中的所有部署。</p><p>查询变量:</p><p>{<br/>" filters ":[<br/>{<br/>" namespace ":{<br/>" operator ":" EQUALS "，<br/> "values": ["default"] <br/> }，<br/>" workload type ":{<br/>" operator ":" IN "，<br/>" values ":[" Deployment "]<br/>}<br/>}<br/>，<br/> 【limit】:1000【T60】</p><p>可以在API Explorer中执行查询和查询变量。</p><p>设置-&gt;线束API浏览器。</p><figure class="w-richtext-figure-type- "/><p><em>执行推荐GraphQL查询。</em></p><p>返回建议后，您可以看到不同采样百分位数的建议。</p><p>结果:</p><p>{<br/>" data ":{<br/>" k8sworkloadverences ":{<br/>" nodes ":[<br/>{<br/>" estimatedSavings ":11.96，<br/> "namespace": "default "，<br/> "workloadName": "cv-demo "，<br/>" Cluster name ":" Example Harness K8s Cluster "，<br/> "workloadType": "Deployment "，<br/>" container recommendations ":[<br/>{<br/> <br/>【推荐】:{ <br/>【请求】:【<br/> { <br/>【名称】:【cpu】，<br/>【数量】:【25m】<br/>}，<br/> { <br/>【名称】:【内存】，<br/>【数量】:【297m】<br/>}<br/>，<br/>【限制】:<br/> { <br/>【名称】:【内存】，<br/>。 <br/>【数量】:【25m】<br/>}，<br/> { <br/>【名称】:【内存】，<br/>【数量】:【258m】<br/>}<br/>]<br/>}<br/>}<br/>}<br/>}，<br/>{<br/>【estimatedSavings】:null，<br/>【命名空间】:【默认】，<br/>“默认”。 <br/> { <br/>【名称】:【内存】，<br/>【数量】:【250m】<br/>}<br/>，<br/>【限制】:【<br/> { <br/>【名称】:【内存】，<br/>【数量】:【250m】<br/>}<br/>]<br/>}，<br/>【p50】:{<br/>【请求】:【<br/>。</p><p>下一步是对工作量采取行动。</p><h2>如何合理调整K8s工作负载</h2><p>有了返回的建议，简单地调优工作负载的资源限制和请求就可以通过Harness实现。我们有一个详细的博客，围绕<a href="https://harness.io/blog/implementing-cloud-cost-savings/" target="_blank">实施云成本节约</a>的步骤。虽然只是用更新的资源限制/请求修改清单，并通过Harness重新部署。</p><p>之前:</p><figure class="w-richtext-figure-type- "/><p>之后:</p><figure class="w-richtext-figure-type- "/><p>随着工作负载的调整，下一步将是调整和优化Kubernetes集群本身。</p><h2>如何调整K8s集群的大小</h2><p>纵观所有的见解，想象下一步是否会在重新创建集群时调整集群的大小。</p><p>例如，如果使用AWS EKS，节点机器类型(例如什么EC2实例类型)是一个关键部分。对于这个例子，我通常使用一个<a href="https://aws.amazon.com/ec2/instance-types/t3/" target="_blank"> t3.xlarge </a>，它有4个CPU和16g内存。</p><p>虽然你的操作系统和Kubernetes有开销。假设工作节点可以访问所有4个CPU份额和所有16gb内存，但实际情况并非如此。</p><h3>K8s需要多少开销？</h3><p>Kubernetes worker节点有一些运行开销。您运行的每个pod都有开销，并且每个节点上都有沉没守护进程成本。查看一个worker节点上没有工作负载的基线，您可以看到如果Kubernetes在开销后可以访问100%的可用资源时的可用资源量。</p><p>通过运行<em> free -m </em>，进入一个空的worker节点:</p><figure class="w-richtext-figure-type- "/><p>如您所见，这个节点只有14.2 GB的空闲内存。如果您有两个各有8 GB资源的pod，这里只能放置一个。</p><p>在空工作节点上运行Top:</p><figure class="w-richtext-figure-type- "/><p>在空闲的任何给定时间，kubelet(节点代理)和docker/container守护进程之间占用了1-3%的CPU。</p><h3>许多小豆荚或几个大豆荚</h3><p>了解放置容量的实际可用性是关键。Pod规模取决于工作负载。拥有更多小型吊舱相对于更少大型吊舱有什么好处吗？根据工作负载，如果较小的单元需要扩展和隔离，那么使用较小的单元是一个好主意。尽管每个Pod本身都有占用可用容量的开销。</p><p>Kubernetes在工作负载规模和集群规模方面肯定不是一劳永逸的。像任何系统和软件一样，优化和调优是一个持续的过程。Kubernetes的好处是能够更快地重新创建，从而允许迭代。</p><h2>重建适当大小的Kubernetes集群</h2><p>合理调整Kubernetes集群的规模有两个方面:平衡按需放置的集群容量可用性与询问每个工作负载和应用所有者的使用情况。</p><p>平台工程师的任务是提高工程效率，并为Kubernetes集群提供足够的容量。虽然如果对工作负载放置和违反直觉的配额进行严格控制，价值主张会开始减弱，但Kubernetes提供的自助服务功能会转变为旧的虚拟机模式。</p><p>在进行讨论和做出调整决策时，数据和分析至关重要。随着时间的推移，利用CCM的建议可以消除实际使用中的猜测。</p><p>通过汇总不同工作负载的建议，使用类似<a href="https://eksctl.io/" target="_blank"> EKSCTL </a>的工具重新创建Kubernetes集群，只需调整节点类型和/或节点数量就可以节省成本。</p><p>#创建EKS集群<br/> eksctl创建集群\<br/>-name big-money-Cluster \<br/>-版本1.19 \<br/>-region us-east-1 \<br/>-node group-name standard-workers \<br/>-node-type T3 . xlarge \<br/>-nodes-min 1 \<br/>-nodes-max 3 \<br/>-node-ami auto \<br/>-ssh-access \<br/>-ssh-ssh-</p><p>通过基于Harness CCM建议的谨慎调整，您已经走上了增加密度和节约成本的道路。</p><h2>Harness，您的云成本合作伙伴</h2><p>在Harness，我们的使命是实现云支出的民主化，并在您消耗云资源的同时，帮助传播有价值的谨慎信息。</p><p>不仅仅限于Kubernetes，Harness CCM还可以帮助跟踪和可视化跨多个资源的公共云支出，这些资源也可以通过API 提取<a href="https://developer.harness.io/docs/first-gen/cloud-cost-management/cost-explorer-apis/ce-cost-explorer-apis/" target="_blank">。</a></p><figure class="w-richtext-figure-type- "/><p><em>线束CCM仪表板</em>。</p><p>敬请关注，并确保今天就报名参加<a href="https://harness.io/platform/cloud-cost-management/" target="_blank">云成本管理</a>的演示。</p><p>干杯，</p><p>拉维</p></div></div>    
</body>
</html>