# 你可能搞乱微服务|线束的 5 种方式

> 原文：<https://www.harness.io/blog/5-ways-to-mess-up-microservices>

与构建和部署微服务相关的五大挑战。

如今，似乎每个人都热衷于微服务，而整体架构正慢慢淡出人们的视线。

当然，潮流来来去去，它们得到的关注往往被夸大了，并不能反映真实的情况。然而，对于微服务，似乎有更多的共识认为这一趋势将会持续下去。有道理。从概念上讲，微服务扩展了工程师们已经使用了几十年的原则。

在本帖中，我们将探讨与构建和部署微服务相关的主要挑战，并了解如何解决这些挑战。

## 微服务的另一面

关注点分离(SoC)是一种设计原则，它规定软件应该由“关注点”或整体功能决定的不同部分构建，它已经被使用了 30 多年来规定技术应该如何构建。在单片应用程序中，它体现在典型的三层体系结构中表示层、业务层和数据层的分离。

微服务采用了这个概念，并将其颠倒过来。他们采用相同的应用程序，并以这样的方式将其分离，即应用程序的单一代码库可以被分解并单独部署。

好处是巨大的，但也是有代价的，通常体现在时间和金钱方面的运营成本更高。除了将现有应用程序转换到容器所带来的巨大前期投资之外，维护该应用程序也带来了新的挑战。

尽管人们大肆宣传微服务的故障排除挑战，但真正的挑战是了解系统的实际工作方式。

## 问题 1:好像监控一个整体还不够困难

虽然单块应用程序有自己的挑战，但是回滚单块应用程序中的“坏”版本的过程相当简单。在容器化的应用程序中，事情要复杂得多。无论您是逐渐将单一应用分解为微服务，还是从头开始构建新系统，您现在都有更多服务需要监控。这些情况中的每一种都可能:

*   使用不同的技术和/或语言
*   在不同的机器和/或容器上运行
*   有自己的版本控制

因此，系统变得高度分散，对集中监控和日志记录的需求也越来越强烈。

容器化应用程序的组件可以彼此独立地构建和部署，因此如果部署后出现问题，我们首先需要确定哪些服务需要回滚(并不总是像听起来那么容易)，并考虑回滚会如何影响其他服务。

**要点 1:** 如果您认为监控整体架构很难，那么微服务的难度是前者的 10 倍，并且需要在主动措施方面投入更多资金。

## 问题#2:日志记录分布在服务之间

当谈到监控应用程序时，首先想到的是:日志、日志、日志。相当于碳排放的 IT，服务器每天都会产生数 GB 的非结构化文本，最终导致硬盘溢出以及疯狂的摄取、存储和工具成本。

即使使用整体架构，您的日志可能已经让您的工程师有些头疼了。众所周知，它们很肤浅，很少包含有用的变量值或提供对根本原因的直接洞察。即使在一个 monolith 中，代码路径也会跨越多个层，因此与同一问题相关的日志可能会出现在不同的位置。

有了微服务，你的日志变得更加分散。一个简单的用户事务现在可以通过许多服务，所有这些服务都有自己的日志框架。要解决一个问题，您必须从事务可能通过的所有服务中提取所有不同的日志，以了解哪里出错了。

在 Harness，我们的团队通过使用 Harness 服务可靠性管理模块解决了这个问题。首先，我们不依赖日志来排除应用程序的故障。线束服务可靠性管理模块可以识别所有错误和变慢，即使它们没有被记录。当我们在日志中看到一个错误时，我们会在日志中插入一个链接，从而进入真正的根本原因屏幕。

在那里，我们可以看到导致问题的完整上下文，包括涉及哪个应用程序、服务或容器，完整的堆栈跟踪，以及每一帧的可变状态，即使它分布在许多服务或机器之间，还有系统指标等等。

**要点 2:** 微服务就是将事物分解成单个组件。作为一个副作用，Ops 程序和监控也会因服务而中断，并失去监控整个系统的能力。这里的挑战是使用适当的工具重新集中。

## 问题#3:由一个服务引起的问题可能会在其他地方引起麻烦

如果您跟踪特定服务中的一个中断的事务，您不能保证您正在查看的同一个服务是罪魁祸首。

实际上，有几种可能的情况来解释正在发生的事情:

*   它接收到的输入是坏的，因此您需要了解是什么导致了之前的服务行为不当
*   输出从以下服务返回了一些意外的响应，在这种情况下，您需要了解下一个服务的行为
*   可能的情况是依赖关系比一对一更复杂，并且有多个服务导致了这个问题

无论问题是什么，微服务的第一步是了解从哪里开始寻找答案。数据分散在各处，甚至可能根本无法从您的日志和仪表板指标中访问。

**要点 3:** 对于 monoliths，你通常知道你至少在寻找正确的方向，微服务使你更难理解问题的来源以及你应该从哪里获得数据。

问题#4:找到问题的根本原因

## 此时，您已经确定了有问题的服务，从日志中提取了所有需要的数据，包括堆栈跟踪和一些变量值。您可能也有某种 APM 解决方案，如 New Relic、AppDynamics 或 Dynatrace。从那里，您将获得一些关于一些相关方法异常高的处理时间的额外数据。

但是……问题的真正根源是什么呢？

您(希望)从日志中获得的可变数据的前几位很可能不是移动指针的数据。它们通常更像是面包屑，指向下一条线索，而不是更远。在这一点上，我们需要尽我们所能来揭示我们的应用程序背后更多的“魔力”。

在绝望的时候，这可能意味着向特定的服务添加更多的日志并重新部署，希望问题会随着更多的上下文重新出现。理想情况下，我们应该能够通过主动设置监控解决方案来识别我们自己的预见所不能识别的内容，从而避免这种情况。

**要点 4:** 当微服务中的错误的根本原因跨越多个服务时，关键是要有一个集中的根本原因检测工具。服务可靠性管理通过在 SDLC 的所有阶段监控应用程序，识别所有问题(包括未捕获的异常)，并提供快速解决问题的完整环境，帮助团队积极主动。


问题#5:版本管理和服务之间的循环依赖

## 另一个问题是，我们之前提到过，但我们认为值得强调的是，从典型整体架构中的层模型过渡到具有微服务的图形模型。

在转换过程中，可能会出现两个与检查依赖关系相关的问题。

如果您的服务之间有一个依赖循环，当某个事务可能陷入循环时，您很容易出现分布式堆栈溢出错误。

1.  如果两个服务共享一个依赖项，并且您以影响另一个的方式更新其中一个的 API，那么您将需要更新两个。
2.  更多的服务意味着不同的发布周期，增加了复杂性。当一个问题在一个版本中消失，而在另一个版本中又出现时，重现这个问题可能会非常困难。

‍ **要点 5:** 在微服务架构中，你甚至更容易受到源于依赖性问题的错误的影响。

最后的想法

## 正如科技行业的大多数进步一样，微服务采用了一个熟悉的概念，并将其颠倒过来。他们重新思考大规模应用程序的设计、构建和维护方式。随之而来的是许多好处，但也有新的挑战。当我们一起看这 5 个主要挑战时，我们可以看到它们都源于同一个想法。微服务带来的真正挑战是让我们自己重新熟悉我们的应用和系统是如何真正工作的。

底线是，采用微服务这样的新技术需要新的核心能力才能取得成功。服务可靠性管理使团队能够通过访问所需数据和填补传统工具无法覆盖的空白来克服微服务带来的挑战。

底线是，采用微服务这样的新技术需要新的核心能力才能取得成功。服务可靠性管理使团队能够通过访问所需数据和填补传统工具无法覆盖的空白来克服微服务带来的挑战。