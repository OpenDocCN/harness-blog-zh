# 自动 CI CD 回滚到 30 秒|线束

> 原文：<https://www.harness.io/blog/automated-ci-cd-rollback>

Build.com 取消了他们大部分的核查工作。找出你也能做到的方法。

潜在客户和分析师有时会问“是的，我得到了控制，但是您真的有在生产中自动部署、验证和回滚的客户吗？”是的，实际上，我们有。自动化听起来很可怕，但话说回来，把你的任务关键型应用程序搬到云中的大型书店也同样可怕。

在我继续之前，我只想对 Ed、Tim 和 Build.com 的团队大声疾呼，他们是 Harness 的早期信徒，更重要的是，他们非常相信 CI/CD 和使用机器学习来自动化生产部署的验证和回滚。

以下是他们如何在短短几周内成功实现端到端部署流程自动化的案例:

## 部署管道

下面的第一个截图显示了 Build.com 的实际部署流程，由 7 个不同的阶段和工作流程组成:

*   阶段 1 和 2–开发和测试工作流(并行执行)
*   阶段 3 至 5—edu/沙盒/试运行工作流(并行执行)
*   第 6 阶段–人工批准
*   第 7 阶段–生产工作流程

您可以看到，在生产工作流失败的阶段 7 之前，部署管道看起来很坚固。

## 失败的生产工作流程

下面我们可以更详细地看到失败的生产流程。

工作流从 canary 部署开始，第 1 阶段升级 20%的生产环境。接下来，Harness 在 New Relic 中标记这个新部署，然后立即连接到 New Relic 和 Sumo 逻辑，以验证服务/应用程序的性能和质量。

在此验证过程中，Harness 无监督机器学习算法开始分析、比较和标记两种工具从应用程序中捕获的数千个日志条目和时序指标中的异常/回归。

从上面的截图可以看出，应用程序性能验证成功，但应用程序质量验证失败。这通常表明 Harness 观察到了一些独特和意想不到的事情，通常是服务/应用程序中引入的新事件、错误或异常。

## 使用机器学习进行连续验证

在利用之前，6 到 7 名团队领导将花费 60 分钟来验证每个生产部署。现在，一名工程师可以在几分钟内完成这项工作。

下面是一个截图，确认了为什么上述应用程序质量验证步骤失败。通过分析 Sumo Logic 中的应用程序日志数据，Harness 的机器学习算法能够检测到四种新的质量回归。具体来说，Harness 检测到 4 个新的异常，这些异常在之前的任何部署中都没有发现过。

您在下图中看到的灰点代表“基线事件”或“集群”——这些是 Harness 随着时间的推移了解到的事件，被归类为“正常”，因为它们在部署期间经常被观察到。红点代表未知事件或发生频率出乎意料的事件。在生产部署过程中，这些通常是让你头疼的事情。

在检测到这些退化的几秒钟内，Harness 执行了一个“智能回滚”，将服务/应用程序带回到上一个工作版本(工件和运行时配置)。值得一提的是，智能回滚可以作为工作流的一部分完全自动化，也可以通过手动干预(人工)来控制。

## 智能回滚(32 秒内)

如果我们放大上述工作流的顶部，您将看到在 canary 部署的第 1 阶段失败后确实发生了回滚的视觉确认:

也许这次部署失败最令人满意的方面是自动回滚到前一个工作版本所花费的时间…..仅仅 **32 秒**。上次我在 10 月份与 ed、Tim 和团队聊天时，他们告诉我，由于脚本、依赖项和配置的数量，他们平均需要 32 分钟来手动回滚生产部署。Build.com 是仅次于家得宝的第二大电商市场，电商收入超过[5 亿美元](https://www.forbes.com/sites/georgeanders/2016/01/04/whod-start-a-tech-firm-in-chico-chris-friedlands-zany-path-to-riches/#7b7864ea50b7)，所以每一分钟的停机和回滚都很重要。

因此，这证明了今天可以端到端地自动化您的整个 CI/CD 流程。在 Build.com 的案例中，他们使用 Jenkins 进行持续集成，使用 Harness 进行持续交付，使用[对 New Relic 和 Sumo 逻辑数据进行持续验证](https://harness.io/platform/continuous-delivery/continuous-verification/)。更好的是，这部电影中没有人因为机器学习的使用而受到伤害或被取代。