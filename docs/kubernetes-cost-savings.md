# Kubernetes 成本管理策略:成本节约|利用

> 原文：<https://www.harness.io/blog/kubernetes-cost-savings>

我们要讨论的第二个 Kubernetes 成本管理策略是成本节约。这意味着缩小规模、合理调整和自动缩放。

我们策略系列的第二部分！上周，我们从能见度开始。今天，我们来看看成本节约。

一旦你对 Kubernetes 的成本有了[的了解](https://harness.io/blog/kubernetes-cost-visibility/)，你就可以开始更有效地节省成本。同样，如果你不知道钱的去向，你个人也很难省钱，当你*了解钱的去向后，你就可以决定在哪里削减开支。*

实现成本节约的最大困难之一是交付和维护应用程序的不同团队的多样性。基础设施、云操作和平台团队管理集群，而应用和开发运维团队管理部署在这些集群上的服务和应用。这项工作跨越了这些团队，以实现最佳的资源效率，但也带来了更多的复杂性，涉及到如此多的团队和基础架构消费者。

让我们来看看你在 Kubernetes 上省钱的一些方法。

*这篇文章摘自我们的电子书《Kubernetes 的成本管理策略》。如果你喜欢你看到的内容，坚持到最后，我们会为你链接完整的电子书。它是免费的——最棒的是，没有栅门。*

## 您将看到的示例

通过对成本节约的深入了解，你将能够找到各种各样的节约机会。其中包括:

*   寻找未使用的或“僵尸”集群和节点，您可以杀死
*   基于实际节点资源需求与初始假设的合理规模
*   增加机架密度，以最佳方式利用节点资源并降低闲置成本
*   存储未充分利用或未连接
*   为高需求和高请求的工作负载分配适当的资源

## 战略一:集群缩小规模

集群越少，意味着计算成本越低。但是，删除整个集群并不是降低集群成本的唯一方法。您应该能够看到您的 Kubernetes 资源是如何被利用的，并且您应该能够理解哪些资源是未被分配的。这些是唾手可得的水果，能让你马上在 Kubernetes 上省钱。

从很多方面来说，裁员是一种奇特的说法，意思是“找到你提供和支付的没有人使用的东西，然后扔掉它。”无论是整个集群，还是过度配置的集群中的节点，削减未分配的 Kubernetes 资源都是节省成本的快速方法。

从这里开始，最简单的方法是将 Kubernetes 连接到 Prometheus(或类似的工具),这样您就可以设置您的监控。从那里，您将能够看到您的利用，闲置，和未分配的资源。对于这种策略，您需要查看未分配的资源，并减少那些您确实不需要的资源。

使用好的 Kubernetes 成本管理工具也可以让你对这些信息一目了然，这样你就可以最大限度地减少 Prometheus 设置的工作量。例如，Harness 提供了这种现成的可见性，以便您可以按集群查看已利用、闲置和未分配成本的明细。您还可以看到，在工作负载级别，根据相同的指标，有多少内存、CPU 和存储在消耗。

### 风险

集群缩减，尤其是如果您要取消整个集群，可能会充满很多风险，需要巧妙的工程设计来使其工作而不中断服务。想象一下，如果你有 5 个人做一项工作，然后你把它减少到 2 个。这会如何影响你完成工作的能力？你必须聪明地处理这些限制，同时确保你不会在需要做的事情上失误。

与所有基础架构变更一样，您还需要确保未分配的容量不是在您取消它之前其他人有需求的结果。尤其是如果您是手动完成的，并且没有自动缩放器，那么为新节点或新集群增加或减少资源可能会很麻烦。

### 最有用的时候

裁员对所有人都合适。Kubernetes 的美妙之处在于，您可以定义对控制平面或主节点的需求，结果会神奇地得到处理。然而，就像所有的事情一样，浪费很有可能会积累起来，并且您将拥有变成“僵尸”的资源——在某个时间提供了资源，但随后就被闲置或遗忘了。

鉴于集群和工作负载管理器之间的划分，像这样的集群级优化通常最适合基础设施、CloudOps 和平台团队，当然，任何管理集群的供应、使用和操作的团队都可以使用这种优化。

集群精简对于所有级别的组织来说都是一个很好的策略，也是最容易实施的策略之一，并且可以节省大量成本。建议您使用自动缩放器来充分利用这一策略。

## 策略二:合理调整工作负载

如果缩小规模是为了消除未分配的资源，那么合理调整规模就是最小化闲置资源成本的方法。在这种情况下，您不是查看哪些资源完全没有使用，而是查看哪些资源没有得到充分利用，通常是在 pod 级别。这允许您移动工作负载，并为您需要为节点调配的计算资源创建更好的配置文件。

合理的规模调整通常会增加机架密度，从而更好地优化整个节点的资源使用。为此，您首先需要了解历史使用情况或工作负载模式。有了这些知识，您可以理解，如果平均 CPU 利用率为 40%，那么您可能不需要最初认为的计算水平，并且您可以更改配置以使用成本占用空间更小的计算资源。

另一方面，要确保为节点分配适当的资源。在上面的例子中，如果你的 CPU 利用率是 40%，但是你总是内存不足怎么办？在这种情况下，你不能只获得较小的资源。您必须完全更改您的请求和限制配置文件，以降低相对 CPU 利用率，但增加内存参数。然而，更常见的是 CPU 和内存都被过度配置。无论哪种情况，您都希望确保为需要处理的工作负载选择正确的工作节点。

与裁员一样，您希望首先了解已利用、闲置和未分配的成本，这可以通过连接到 Prometheus(或类似工具)并可视化您的使用情况来实现。对于这个策略，你要看看你的闲置成本。在此基础上，您需要决定在调整资源大小或转移工作负载方面的最佳前进道路。这些基本步骤将使你走上减少闲置资源和提高成本效益的道路。

或者，像 Harness 这样的工具可以极大地减少寻找合理调整机会所需的工作，然后计算出正确的[请求和限制](https://harness.io/blog/recommendations-deep-dive/)应该是什么。通过这种方式，您的历史数据被用来自动生成推荐的资源配置文件，因此您所需要做的就是进行更改。

### 风险

实施良好的规模调整策略的最大风险是对数据理解不足。如果您不能很好地了解您的资源和工作负载相对于您设置的请求和限制的执行情况，就不可能调整规模。信息贫乏或没有信息会导致资源严重调配不足并导致性能问题，或者严重过度调配并引发成本方面的危险信号。

除了死记硬背的工作负载级指标之外，一个很容易忘记的关键考虑因素是应用程序级指标。例如，对于基于 JVM 的微服务，您应该确保考虑像 JVM 堆大小这样的应用程序级指标。您是否也针对这些需求进行了适当的规模调整？

与裁员一样，您还需要确保在整个 Kubernetes 环境中共享资源的情况下不会影响到其他人。

### 最有用的时候

合理调整最终可能会涉及很多技术问题。因此，对于拥有跟踪利用率指标的良好方法的组织来说，它是最有用的，这可以像插入 Prometheus 以捕获核心基础架构指标一样简单。这种策略对于那些知道如何在不破坏东西的情况下移动工作负载的团队来说是很好的，并且可以有效地将预期使用与开销安全网分开，以确保满足性能和成本考虑。

鉴于集群和工作负载管理器之间的差异，像这样的工作负载级优化通常最适合应用程序和 DevOps 团队，当然，任何管理 Kubernetes 工作负载的供应、使用和操作的团队都可以使用它。

对于希望更好地调配和使用现有资源的团队来说，合理调整是一个可靠的成本节约策略。建议您使用自动缩放器(在这种情况下，特别是垂直 Pod 自动缩放器)来充分利用这种策略，因为自动缩放会处理宏观级别的优化，让您专注于更微观的调整，这些调整会带来适当的调整，而不会产生太多额外的开销。

## 策略三:自动缩放

如果您不必手动跟踪和优化您的 Kubernetes 足迹，为什么不采用自动化的方法呢？自动缩放使您能够指定在什么条件下应该提供更多资源，或者何时应该终止资源。此外，您可以设置资源供应的下限和上限，这样您就不会无意中在任一方向上做了太多事情。

Kubernetes 提供自动缩放器，允许您自动缩放您的工作负载或单元([水平单元自动缩放器](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/)、[垂直单元自动缩放器](https://cloud.google.com/kubernetes-engine/docs/how-to/vertical-pod-autoscaling)、 [Kubernetes 事件驱动自动缩放器](https://keda.sh/))，以及自动缩放您的集群或节点([集群自动缩放器](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler))。

当您希望基于定义的指标自动扩展工作负载时，您将希望通过 HPA、VPA 或 KEDA 使用工作负载或 pod 自动扩展。如果与目标指标相比，您对一个单元或工作负载的使用超过了阈值，则可以扩大规模，例如使用更多单元或增加资源限制。类似地，如果与目标指标相比，使用率非常低，那么事情可以缩小规模。扩展单元和工作负载的能力仅受限于这些单元和工作负载所在节点的可用资源，这意味着如果一个节点的资源达到极限，您的自动扩展就会停止。

自动缩放集群或节点使 pod 缩放更加有效。虽然单元扩展会影响群集或节点内资源的扩展和配置，但这种扩展会有效地决定所有单元和工作负载可用的资源总量。在单元扩展充分利用可用资源的情况下，节点扩展决定了可用资源的数量和类型。Cluster Autoscaler 检测单元何时处于挂起状态(等待资源),并增加要添加挂起单元的节点数量。当不再需要节点时，它还会检测到相反的情况，并降低资源消耗。

### 风险

糟糕的自动缩放策略是任何 Kubernetes 成本节约努力的祸根。如果限制设置不正确或通过奇怪的边缘情况满足条件，可能会导致失控的自动缩放，从而导致成本大幅增加。与此同时，自动缩放是一个很好的试金石，甚至是你的假设中出现问题的领先指标。例如，您可能会看到猖獗的非异常扩展，这意味着用户增长，或者成本失控，自动化可能是第一个需要关注的地方。

### 最有用的时候

自动扩展对于任何需要某种形式的云自动化的组织都很有用。如果你在 AWS、GCP 或 Azure 中应用自动缩放策略，你可能会想在 Kubernetes 中利用自动缩放。设置了正确的限制，并控制了出现的任何问题(如成本滚雪球或僵尸资源)，对于任何希望使用 Kubernetes 更好地花钱的组织来说，自动伸缩都是一个巨大的进步。

## 结论

我们看到，利用这些 Kubernetes 成本节约策略，Harness 客户的账单减少了 80%。虽然这些策略可以单独用于降低 Kubernetes 的成本，但当您可以利用所有这些策略时，它们才是最有效的。降低成本要记住的关键是，没有良好的可视性是众所周知的困难。正如您在这些策略中所看到的，对正在发生的事情有一个很好的理解对于最大化回报和降低与任何基础架构变化相关的风险是至关重要的。

在我们的下一篇文章中，我们还有最后一个策略:成本预测。然而，如果你不想等那个帖子上线，你可以现在就下载完整的电子书- *它是免费的，不需要电子邮件地址！*立即下载 Kubernetes 的[成本管理策略](https://harness.io/learn/ebooks/ebook-cost-management-kubernetes/)电子书，了解有关成本可见性、成本节约和成本预测的所有信息！