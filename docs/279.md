# 在 CI | Harness 中使用“When”指令和内置变量

> 原文：<https://www.harness.io/blog/when-directive-built-in-variables>

通过使用“when”指令和内置变量，用户可以将单个管道用于类似的用例，而不是创建和维护多个。让我们学习所有关于条件执行的知识！

“ **when** ”指令使管道能够根据给定的条件来确定是应该执行一个步骤还是一个阶段。

为什么需要它？

假设我们需要构建一个执行以下逻辑的管道:

1.  构建并推送应用程序的映像
2.  运行集成测试以测试应用程序是否正常工作 **//仅针对拉取请求**
3.  创建吉拉票 **//仅在执行过程中出现故障**

这是一个非常常见的用例。

在构建、测试和推送应用程序时，用户通常需要根据构建类型运行/跳过一些步骤和阶段。当推送到特征分支、改变 PR 或构建标记时，可能需要管道逻辑中的一些变化。

实现这一点的方法是使用“when”指令。“when”指令允许用户设置:

1.  基于状态的条件:根据步骤/阶段的状态执行-成功(默认行为)、始终或失败。
2.  JEXL 条件:用户可以在状态之上设置附加条件。

例如，具有如下配置条件的阶段，如果在该阶段执行之前没有发生错误，将只为拉请求构建运行。

在 YAML 管道中，情况看起来像这样:

当:
pipelineStatus: Success
条件:<+codebase . build . type>= = " PR "

在上面的例子中，我们将“when”指令与[内置变量](https://ngdocs.harness.io/article/576gjpak61-built-in-cie-codebase-variables-reference)相结合。还可以将 JEXL 条件与其他变量(如管道变量、阶段变量和步骤输出变量)一起使用，以有条件地确定阶段/步骤应该何时执行。

## 使用带有“When”条件的内置变量时的最佳实践

我们有多种类型的内置变量；管道、用户变量、触发器和基本代码。

格式为的变量保存与作为 CI 阶段的一部分执行的克隆操作相关的信息。格式的变量保存与管道触发方式相关的信息。

一些内置变量可能在运行时无法解析，这取决于管道的触发方式(手动、webhook 等)。)和构建类型(标记、分支、PR)。例如，仅在生成标记时填充，而仅在管道由拉请求 Git 事件触发时填充。

为了使处理变量更容易，内置变量有一个字符串默认值“null”。这意味着您可以测试变量值是否等于“null ”,以查看值是否被填充。

因此，如果您有一个 stage，它应该只执行以某个模式开始的标签，比如“v .”标签，那么您可以使用一个 JEXL 将 regex 模式匹配到来轻松实现这一点。您仍然可以使用这个管道来构建一个 PR，或者一个分支，在这些情况下，这个阶段将被跳过，因为将被解析为字符串“null”，这与模式不匹配。

当:
pipelineStatus: Success
条件:< +codebase.tag > ~/v.*/

## 结论

在这篇博文中，我们学习了所有关于条件执行的知识，使用了“when”指令和内置变量。

我们展示了用户如何为相似但略有不同的用例使用单个管道，而不是创建和维护多个管道。

要了解更多信息，请参考: