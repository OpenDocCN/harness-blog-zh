# 基础设施即代码(IaC):如何实现最佳实践|利用

> 原文：<https://www.harness.io/blog/infrastructure-as-code>

在很长一段时间里，基础设施被排除在这个实践之外。在引入配置管理和基础设施即代码(IaC)之前，我们在数据中心手动管理服务器。

在现代计算时代，可重复性、可审计性和简单性是许多蓬勃发展的科技公司的核心原则。应用程序代码存储在 Git 或 SVN 中，并执行代码审查。部署以自动化的方式进行，使开发人员能够将软件和功能“完成”，从而为客户提供价值。在很长一段时间里，基础设施被排除在这个实践之外。在引入配置管理和基础设施即代码(IaC)之前，我们在数据中心手动管理服务器。

今天，世界上大多数基础设施都托管在云提供商拥有的数据中心，如亚马逊网络服务(AWS)、谷歌云平台(GCP)和微软 Azure。随着我们推出新的基础设施，我们实际上正在与每个平台提供的后台健壮 API 进行交互。这为一个全新的范例打开了大门。基础设施可以通过 API 调用进行部署和配置，这就为 [Terraform](https://docs.harness.io/article/9pvvgcdbjh-terrform-provisioner) 、 [CloudFormation](https://docs.harness.io/article/4xtxj2f88b-map-cloud-formation-infrastructure) 、Pulumi 和其他 IaC 工具提供了一个缺口来填补！

*Infrastructure as Code Providers*.

## 什么是基础设施即代码(IaC)？

现在，我们已经了解了企业如何管理基础设施的进展，让我们来讨论一下作为代码的基础设施到底是什么。

正如我们将我们的应用程序代码签入 Git repos(这是所有事情的真实来源)一样，我们可以使用代码描述我们的云基础架构的形状和特征。在 Terraform 中，这意味着编写 HCL ( [HashiCorp 配置语言](https://www.terraform.io/docs/language/syntax/configuration.html))并将代码签入源代码控制。

当需要更改基础架构时，只需打开“Terraform”Git repo 的拉请求，通过审查流程，然后这些更改将最终应用到您选择的一个或多个云平台(混合云)。

你可能会问，像 Terraform 这样的工具如何跟踪它所管理的内容，如何防止多个工程师同时应用他们的更改？通常，在 AWS 的情况下，会有一个被指定为“远程状态”的 S3 存储桶这是 CloudFormation 和 Terraform 存储它们为一组给定资源管理的基础设施视图的地方。为了防止多个工程师同时应用更改，可以使用 Terraform 的 DynamoDB 状态锁定，它只是使用 DynamoDB 作为锁定机制。

这一切都是为了实现企业云基础架构的可靠、可重复、安全和可审计的表示。

## 基础设施作为代码解决了什么问题？

我个人可以分享一些管理内部和云基础架构的经验。在 AWS 控制台中手动设置基础架构，甚至通过一次性脚本来设置都很麻烦，并且不具备很好的可伸缩性，而且配置漂移非常微妙，如果没有工具来跟踪动态基础架构的生命周期，很容易失去对偏差的跟踪。

使用 Terraform 这样的工具，结合版本控制，我们能够跟踪对我们的基础设施所做的每一项更改。以前，在 IaC 之前，我们经常使用配置管理工具，比如 Puppet 或 Ansible，并利用它来解决它不擅长解决的问题。

在当今的企业中，新服务需要快速推出，随着开发人员工作效率的提高，从推出第一个环境到投入生产的时间越来越短。为了让 DevOps 能够扩展，我们需要能够为我们提供可重复、可扩展且透明的方式来管理云基础架构的工具。建立第二个环境应该是复制一个变量文件，稍微调整一下，然后部署它。这与旧的做事方式形成了鲜明的对比:在控制台中浏览，四处点击，并希望自己没有错过任何东西，同时使用大量潜在的配置选项来配置过多的云资源。基础设施即代码(IaC)是一种合理管理分布式复杂基础设施的方式。

*A look into Terraform*.

## 将基础设施用作代码的好处和最佳实践

### 速度

基础设施作为代码的力量来自于它赋予工程师的灵活性。您不能复制和粘贴 SQS 队列、RDS 实例、红移集群等。在控制台中，我们自己通过 SDK 直接管理它们并不是对时间的最好利用。通过 IaC，您可以利用 GitHub 上的开源模块，以及 HashiCorp Terraform 注册表中的开源模块。这大大减少了在您的基础架构中启动新组件的 HCL 代码量。就应用您的更改而言，与其他配置管理工具一样，Terraform 能够使用多线程以并发方式部署您的基础架构，从而减少实际部署更改所需的时间。语法也更具声明性，而不是一个巨大的 JSON 或 YAML blob，使用起来既困难又麻烦。我们见过多少次由于 JSON 格式错误而导致的问题？

### 一致性

对于开发人员和软件工程师来说，跨多个环境的配置漂移可能是一场噩梦。诸如“为什么这在试运行中很好，但在生产中却不行？”有了 CloudFormation、Terraform 和其他基础设施自动化工具，一切都将成为过去。当利用 GitOps 风格的工具对您的托管资源进行变更时，您可以查看应用后变更的“计划”和“结果”。如果出现任何问题，可以参考这些信息。

### 有责任

在现代企业中，责任这个词可以有很多含义。我们很多人都努力在企业中体现一种无可指责的文化，但这并不意味着责任不重要。由于 IaC 存在于源代码控制中，作为事实的单一来源，我们可以跟踪谁对给定的基础设施组件进行了特定的更改，就像我们可能会在引入回归后责怪应用程序的一行代码一样。这促进了更好的沟通，因为一半的战斗是知道谁做出了改变，所以我们可以理解为什么。

### 在整个软件开发生命周期中提高效率

开发团队正在通过新的工具、简化的流程和更健壮的持续集成(CI)管道来提高速度。如果没有代码形式的基础设施，要跟上团队的特性速度可能会很有挑战性。您是否经常听到这样的话:“我们需要在明天之前为这个新应用程序准备好 3 个环境。”使用 Terraform、AWS CloudFormation 或 Pulumi 之类的工具，我们可以编写一次基础设施组件代码，并使用动态命名来避免环境之间的命名冲突。以前在 AWS 控制台中需要 3 天才能完成的工作现在只需不到几个小时。谁不喜欢用更少的时间做更多的事情呢！基础设施的另一个好处是代码，开发者可以更多地参与到审查过程中。一个很好的例子是 SQS 队列或运动流。在基础设施级别有相当多的配置会直接影响应用程序的行为。使用标准的拉式请求，我们可以从一开始就对我们的基础设施变更充满信心。正如 Dave Farley 在他的书《[连续交付](https://www.amazon.com/Continuous-Delivery-Deployment-Automation-Addison-Wesley/dp/0321601912/)》中所说，在真正的连续部署(CD)中，尽快获得反馈是至关重要的。

### 降低成本

当您的所有云基础架构都在一个地方进行管理时，基础架构的成本分析就更容易合理化。根据您选择使用的云供应商和 IaC 工具，有一些插件，例如 InfraCost，它计算基础设施中每个修改的成本影响，作为代码源代码控制库。不再需要手动使用成本计算器来计算每个总是由另一个团队激发的变更集。这种快速反馈循环方法还与 IaC 提供的速度和效率优势紧密相关！

### 多样化集成

一个不经常被强调但对使用云供应商无关的 IaC 工具有很大好处的事情是，该工具可以处理的外部系统的数量。配置漂移不仅仅局限于亚马逊网络服务、谷歌云平台和微软 Azure。我们如何更新我们的可观测性系统来反映我们基础设施的变化？我们如何在 Kubernetes 中创建服务帐户？像 Terraform 这样的 IaC 工具允许我们集中管理的不仅仅是我们的云计算资源。我个人曾使用 Terraform 来管理 Auth0 设置、Datadog 监视器和维护模式、PagerDuty 配置等等。看看 Terraform 提供的[提供商列表](https://registry.terraform.io/browse/providers)，更清楚地了解这些工具赋予我们团队的力量。

### 自助服务基础设施

根据公司旨在体现 DevOps 精神的程度，向开发人员开放 IaC 可能是您感兴趣的事情。DevOps 可能是 [Terraform](https://docs.harness.io/article/9pvvgcdbjh-terrform-provisioner) 或 [CloudFormation](https://docs.harness.io/article/78g32khjcu-cloud-formation-provisioner) 版本控制库的看门人，但最终，有了正确的护栏、变更控制流程和工具/自动化，您可以让开发人员、 [SREs](https://harness.io/blog/devops/sre-vs-devops/) 和 DevOps 为相同的声明性基础设施定义做出贡献。想象一下，如果开发人员可以自己添加对新 SQS 队列或其他基础设施组件的支持，那该有多好！

*Workflow: Adding Terraform to Harness. The process is the same for CloudFormation.*

## 作为代码的基础设施:结论

总结一下本文的内容，诸如 Terraform、Pulumi 和 CloudFormation 之类的 IaC 工具可以帮助您的团队获得速度、安全性、可靠性等诸多好处。实施这样的工具可以极大地提高团队的生产力，因为他们总是需要云基础设施来满足业务的技术需求。值得注意的是，从一开始就选择正确的工具将有助于在您引入新的第三方解决方案和 API 时为您打开大门。

为了进一步阅读，为什么不看看我们的 [Terraform 201 教程](https://harness.io/blog/terraform-201-tutorial/)？塞满了你已经在研究的主题的信息！