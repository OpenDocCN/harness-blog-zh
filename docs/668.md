# 亚马逊 EKS 集群协调器简介| Harness

> 原文：<https://www.harness.io/blog/introduction-harness-cluster-orchestrator-amazon-eks>

在本教程中，我们将详细介绍 Harness Cloud Cost Management (CCM)模块中的全新 Harness Cluster Orchestrator for Amazon Elastic Kubernetes Service(EKS)功能如何为工程、开发和 CloudOps 团队提供扩展由独特工作负载需求驱动的亚马逊 EKS 集群节点所需的所有智能。

高效管理集群基础架构需要应对一系列挑战，包括平衡工作负载要求、获得可见性、分配成本和优化集群。基于实际工作负载需求智能扩展集群节点并正确确定其规模的能力对于避免未计划的 pod 以及过度调配工作负载和集群节点是非常必要的。这种智能还必须包括充分利用云过剩容量带来的节约、预留所覆盖的节点的上下文等等。

在本教程中，我们将详细介绍[线束云成本管理](https://harness.io/products/cloud-cost) (CCM)模块中的[新线束集群编排器](https://www.prnewswire.com/news-releases/harness-launches-cluster-orchestrator-for-amazon-eks-to-help-customers-save-up-to-90-on-cloud-costs-301690863.html)如何为工程、开发运营和云运营团队提供扩展由独特工作负载需求驱动的亚马逊 EKS 集群节点所需的所有智能。此外，通过利用 CCM 的分布式 Spot 编排功能，您可以使用 Amazon EC2 Spot 实例节省高达 90%的云成本。

CCM 的 EKS 集群协调器提供工作负载驱动的智能自动伸缩，通过自动平衡云基础架构的工作负载需求，并根据工作负载需求智能自动伸缩 AWS Spot 实例，高效管理集群基础架构。它还提供了精细的成本可见性、一种方便的按存储容量使用计费和按存储容量使用显示的成本分配方法、EKS 集群的自动化优化，以及一种简化的工作负载和节点大小调整方法，以避免过度配置。

Harness 很荣幸成为亚马逊 EC2 Spot 实例的 [AWS 服务就绪计划](https://aws.amazon.com/blogs/apn/optimize-cost-and-performance-with-amazon-ec2-spot-ready-partners/)的一部分。这一称号表明，Harness CCM with Cluster Orchestrator 实现了最佳实践和 API 支持，可以在客户的云环境中成功管理 Amazon EC2 Spot 实例。加入亚马逊 EC2 Spot Service Ready 计划使 Harness 成为 AWS 合作伙伴网络(APN)成员，其产品可与亚马逊 EC2 Spot 实例配合使用，通常可用于并完全支持 AWS 客户，帮助他们从亚马逊 EC2 Spot 节省的工作负载中受益。

## 线束集群协调器入门

在我们开始之前，如果你目前没有使用 Harness CCM，你可以[免费注册](https://app.harness.io/auth/#/signup/?module=ce)。(*注意:Cluster Orchestrator 目前处于测试阶段，有一个功能标志，可以通过请求获得。*)

### 添加新集群

为 EKS 集群启用 Cluster Orchestrator 的第一步是使用 [CCM Kubernetes 集群连接器](https://docs.harness.io/article/1gaud2efd4-add-a-kubernetes-cluster-connector)将集群添加到 Harness CCM。接下来，导航到 CCM 模块中的 Cluster Orchestrator，并单击右上角的“*添加新集群”*按钮。

这将打开一个向导，允许您选择之前创建的 CCM Kubernetes 连接器。接下来，您将被要求下载一个 YAML 文件并将其应用到 EKS 集群，这将为 Harness 提供所需的权限，从而为您提供集群的粒度可见性。

### 所有集群概述

Cluster Orchestrator 的 overview 屏幕为您提供了已添加的所有 EKS 集群的高级视图。此屏幕可帮助您管理所有这些集群，其中包含总体集群开销、通过利用 AWS Spot 实例实现的节省、所有集群的总节点数(包括按需、Spot 和回退的划分)以及闲置、已用和未分配成本的集群成本明细等聚合信息。您还会看到下面列出的每个集群的表格。

在这里，您将看到与每个集群相关的元数据，包括集群名称、集群 ID、区域、节点数量、CPU/内存以及该集群的总开销。每个集群行还将显示启用集群编排器提供的编排的选项。已经启用了业务流程的集群也将如此显示。你可以在下面的 UI 图中看到这一点。

‍

### 集群概述

单击每个集群将打开一个细分，其中包含该集群的更多详细信息。在这里，您将看到该集群本月的总开销，包括集群名称、区域和标识符等详细信息，以及该集群的总节点数，包括按需、定点和回退的划分。您还将看到有多少节点由 EKS 管理，有多少节点由 Harness 管理。对于单元，您将看到单元总数，包括按需分配和定点分配。您还将看到有多少单元是预定的，有多少单元是未预定的。最后，您将看到该集群的 CPU 和内存的闲置、已利用和未分配成本的成本明细。

单击右上角的“Workloads”*选项卡，您可以更深入地了解该集群中的工作负载。您将看到所有工作负载的总支出、所有工作负载的总副本数，以及通过在 Spot 实例上运行工作负载实现的 Spot 节省。下表将显示群集中所有工作负载的列表，包括每个工作负载名称、其所属的命名空间、总副本数以及该工作负载所有副本的按需和定点拆分。您还将看到分配策略、工作负载的总成本，以及调整工作负载大小以进一步优化成本的[建议](https://harness.io/blog/recommendations-api)。*

*现场实例非常适合于现场就绪的现场就绪工作负载，但是您不希望与任何类型的现场中断风险相关联的关键工作负载需要更高级的处理。Cluster Orchestrator 针对现场编排的分发策略正好提供了这一点。这是在集群上使用一个名为工作负载分布规则的定制资源进行配置的，它支持几个节省成本的功能。*

#### *拆分工作负载副本*

*利用工作负载分配规则，您可以拆分单个工作负载的副本，使其在现场和按需节点上运行，从而最大限度地节省成本，同时最大限度地降低中断风险。这意味着，例如，如果您的工作负载有四个复制副本，您可以在现场节点上运行其中一个复制副本，在按需节点上运行另外三个复制副本。这使您甚至可以在关键或生产工作负载中利用现场节省，否则您只能在按需节点上运行。*

#### *分销策略*

*如果希望在最少数量的点节点上运行所有点副本，可以设置成本优化的分布策略。这有助于通过运行最低要求的 Spot 节点来最大化 Spot 节省，但是这种策略更容易出现 Spot 中断。或者，您可以设置一个中断最少的分发策略，确保所有的点副本尽可能运行在不同的点节点上。这将大大减少 Spot 中断的机会，使其在可用性方面更加安全，因为 Spot 中断意味着其他 Spot 副本仍在不同于被中断的 Spot 节点上运行。*

#### *基于按需生产能力*

*与自动扩展组类似，您可以配置基本按需容量，以确保运行最少数量的按需复制副本；除此之外，只有上述第一个选项中的即期/按需分配比率将生效。*

*单击“Nodes”选项卡将为您提供该集群中所有节点的概览。您将看到该群集中运行的节点列表，包括节点名称、每个节点上运行的工作负载数量、节点实例类型、实现(即时或按需)、CPU、内存、节点年龄以及节点的当前状态。*

## *设置业务流程*

*为 EKS 集群设置流程编排需要以下步骤。*

### *群集权限*

*为 EKS 集群设置流程编排的第一步是下载一个 YAML 文件并将其应用到集群。这为集群协调器提供了执行 EKS 集群协调所需的权限。*

*‍*

### *定点实例*

*一旦将 YAML 文件应用到集群并验证了权限，下一步就是设置现场协调。在这里，您可以选择是在 Spot 实例上运行所有 EKS 工作负载，还是只运行 Spot 就绪的工作负载。在这种情况下，现场就绪指的是具有多个副本的工作负载。*

*您还能够挑选想要在 Spot 实例上运行的单个工作负载。一旦您做出了这个选择，您将会看到一个使用 Spot 实例相对于按需对等实例的预计节省量。*

### *集群首选项*

*接下来，您可以配置以下集群首选项 *:**

#### *集群缓冲区*

*集群缓冲区为集群的总容量增加了扩展空间，并且可以针对现场和按需节点进行单独配置。*

#### *反向回退重试*

*当在现场中断事件期间现场容量不可用时，Cluster Orchestrator 将暂时回退到按需节点，以保护可用性要求。但是，该解决方案会定期检查 Spot 容量，因此一旦容量再次可用，它可以反向回退到 Spot。使用反向回退重试选项，您可以配置执行重试的时间间隔。*

#### *节点删除延迟*

*默认情况下，没有单元的节点将从集群中删除。使用节点删除延迟选项，您可以在执行此删除操作之前配置一个延迟。*

#### *单一副本工作负载的装箱*

*通常，装箱会排除单个副本工作负载，以避免在将它们从一个节点移动到另一个节点时出现中断；但是，使用此选项，您可以配置集群协调器，以包括单个副本工作负载的装箱，从而实现更积极的装箱策略。*

#### *CPU 限制*

*使用此选项，您可以为 EKS 集群配置 CPU 资源限制(最小和最大)。*

#### *节点首选项*

*接下来，我们配置节点*的首选项*。*

#### *节点选择–按节点实例族*

*此选项允许您配置希望 EKS 集群节点来自哪个实例系列。当决定启动哪个实例系列节点时，Cluster Orchestrator 将只启动此处选择的实例系列中的节点。*

#### *节点选择–按节点约束*

*如果您对希望在 EKS 集群节点中包含或排除的确切实例族不太在意，则可以使用此选项配置节点约束。这将简单地将节点限制在 CPU/内存的这些最小和最大约束条件下，而不管节点实例系列如何。*

#### *计划/自动停止*

*特别是对于非生产 EKS 集群，您可以设置调度或自动停止。*

*‍*

#### *整个集群调度*

*使用此选项，您可以为整个 EKS 集群设置固定的正常运行时间或停机时间计划。*

*‍*

*例如，您可以在工作日、周末和公司假日的非工作时间关闭整个集群。*

#### *特定工作负载自动停止*

*Harness 云成本管理最强大的功能之一是[自动停止](https://harness.io/blog/cloud-autostopping)。对于非生产 EKS 集群，您可以为单个集群工作负载配置自动停止。这比时间表节省得多，因为它可以动态地缩减空闲时间超过预配置时间的工作负载。该功能还可以实时扩展工作负载，以便在需要时为新的传入请求提供服务。这有助于您为最细粒度的闲置窗口节省成本，并且在访问缩减的工作负载时没有任何困难。*

## *Cluster Orchestrator 为 EKS 带来的优势*

*对您的 EKS 集群使用集群编排器有多种好处，从利用即时编排功能(即使对于关键生产工作负载)节省高达 90%的成本，到通过上下文感知自动扩展集群节点来提高集群效率。*

### *内置定点编排*

*线束集群编排器内置了全点编排。其核心是，这是使上述分销战略成为可能。借助这种编排，您可以在 Spot 实例上运行您的工作负载，与按需实例相比节省高达 90%,而无需担心 Spot 中断带来的可用性挑战。*

### *备用 Spot 实例*

*收到来自 AWS 的 Spot 中断通知后，Cluster Orchestrator 将自动提供备用 Spot 实例。这个备用 Spot 实例将具有可用的 Spot 容量、足够的资源来运行 pod，并且未来中断的可能性最小。*

### *即时到按需回退*

*当 Spot 容量不可用于该实例时，Cluster Orchestrator 会临时从 Spot 切换到 On-Demand。这保持了服务的可用性，并避免了容量不足的情况，尽管随需应变的成本暂时较高。*

### *按需发现反向回退*

*在从 Spot 到 On-Demand 的回退过程中，Cluster Orchestrator 会定期监控可用的 Spot 容量。当它发现 Spot 容量可用时，它反向回退到 Spot。该操作完全自动化，不需要人工干预。*

### *智能装箱*

*Cluster Orchestrator 具有内置的装箱功能。这确保了最佳数量和选择的 pod 被打包到集群节点上，从而可能释放和优化集群节点资源。由于将此类应用程序从一个节点移动到另一个节点可能会导致中断，因此您可以选择为单个复制副本应用程序启用装箱，否则这些应用程序会默认排除在装箱之外。*

### *利用承诺*

*Cluster Orchestrator 与另一个名为 Commitment Orchestrator 的利用功能进行了一流的集成，该功能可以协调保留实例(ri)和节省计划的购买和利用，从而最大限度地节省成本并最大限度地提高计算支出覆盖率。当 Spot 不适用或不可用时，这种集成使集群编排器能够将承诺覆盖的节点优先于按需节点。*

### *自动缩减闲置工作负载*

*使用 Spot 实例和提交可以节省大量成本，但是没有什么比将空闲工作负载减少到零更好的了。Cluster Orchestrator 与 Harness CCM 的自动停止功能实现了一流的集成，可自动将空闲工作负载缩减至零。这包括缩减其他相关服务、虚拟机、RDS 数据库等。自动停止还会根据网络流量的需要，自动扩大工作负载，为新的传入请求提供服务。*

#### *示例:非生产集群节省了 84%*

*让我们以一个非生产 EKS 集群为例，来说明利用 Harness CCM 和集群协调器可以实现多么惊人的节省。*

*这个示例非生产 EKS 集群有 10 个 m4.xlarge 节点运行在美国东部(俄亥俄州)的 Linux 上。*

***EKS EC2 节点:10***

*每个节点:*

*   *CPU - 4*
*   *内存- 16 GiB*
*   *价格-144 美元/月*
*   *Linux 上美国东部(俄亥俄州)的 m4.xlarge*

***每节荚数:4***

*每个 Pod:*

*   *中央处理器- 1*
*   *内存- 4 GiB*
*   *价格-36 美元*

***不带集群协调器**:按需成本，整月运行:1440 美元*

***使用集群协调器&自动停止**:动态空闲时间缩减后的按需成本:533 美元(907 美元或节省 63%*)**

*假设:*

*   *平均值。跨 pod 每月 70%的空闲时间*
*   *量滴任何时候都有 1 个节点*

***动态闲置时间缩减后的最终现货成本**:231 美元(1209 美元，节省 84%)*

*假设:*

*   *在美国东部(俄亥俄州)Linux 上运行 m4.xlarge 比按需节省 81%*
*   *70%现场节点，30%按需节点*

### *集群成本可见性*

*Harness CCM 的[成本透视](https://docs.harness.io/category/e7k0qds7tw-ccm-perspectives)功能提供了对您的 EKS 集群成本的精细可见性。这显示了 14 天内每小时的成本细分，如下所示。这对于将成本高峰精确定位到发生的具体时间非常有价值。*

*您还可以深入到每个工作负载，以便更详细地了解一段时间内的 CPU/内存利用率，如下所示。*

*利用这种深入、精细的成本可见性以及我们的成本类别，可以为按存储容量使用计费和按存储容量使用显示提供无缝体验。成本类别允许您根据成本时段定义和跟踪成本，成本时段可用于各种结构，如团队、部门、业务单位等。，如下图所示。您可以维护这些相同的成本时段和成本类别定义，以便在各种成本视角下使用，从而便于大规模管理。*

### *工作量建议*

*Harness 提供了调整工作负载大小的建议。建议的请求和限制配置可确保您满足历史 CPU/内存工作负载要求，同时还能显著节省成本。这提供了额外的调优选项来满足您的实际需求，如下所示。*

### *异常检测*

*线束 CCM 最受欢迎的特性之一是异常检测。借助这一功能，您可以在每天出现成本高峰时收到通知，这样您就可以主动采取纠正措施，而不是等到月底才收到云账单或报告。更强大的是，您可以通过电子邮件或 Slack 配置警报，因此您不必经常查看仪表板或报告。*

## *利用 Harness 管理您的集群和云成本*

*在本教程中，您已经完成了为 AWS EKS 集群成功启用集群协调器所需的所有步骤。您还看到了这样做在高效管理集群和显著节约成本方面的所有好处。*

*适用于 EKS 的 Cluster Orchestrator 为 Spot orchestration 提供了强大的新分发策略，以及许多其他功能，可帮助您充分利用 Spot 实例为所有集群工作负载节省高达 90%的成本。此外，您可以利用 Harness CCM 的所有其他功能来有效地管理和控制您的集群和云支出。*

*无论您的目标和目的是正确管理您的集群和云成本，并实现显著的开支节约，驾驭 CCM 已经涵盖了您。*

*准备好观看集群协调器的运行了吗？[立即注册](https://harness.io/demo/next-gen-ccm)参加个性化演示！*