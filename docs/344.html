<html>
<head>
<title>How to Write Your First Plugin for CI - Custom Git Plugin | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何为CI编写第一个插件——定制Git插件| Harness</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/write-first-plugin-for-cie#0001-01-01">https://www.harness.io/blog/write-first-plugin-for-cie#0001-01-01</a></blockquote><div><p>在这篇文章中，我们将学习更多关于插件的步骤，并且我们将创建一个定制的git插件。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>插件是执行预定义任务的Docker容器。它们可以用来克隆git存储库、构建Docker容器、上传工件等等。插件配置是CI流程中的一个步骤。</p><h2>为什么插件很重要</h2><p>插件是高度可扩展和基于容器的。它们本质上是模板化的脚本，可以用任何编程语言编写。与管道步骤中的脚本相比，管理插件更加干净和容易。在本文中，我们将讨论如何为CI编写第一个插件。这很简单，只是让你适应这个过程。当谈到插件时，世界真的是你的牡蛎，所以我们希望你能在这个主题上了解更多，并继续写作！让我们深入到插件步骤。</p><h2>插件步骤</h2><p>首先:什么是插件步骤？简而言之，CI阶段由三种不同类型的步骤组成:运行步骤、运行测试步骤和插件步骤。插件步骤将插件的Docker映像作为Docker容器运行，以执行由其定义的任务。</p><p>插件步骤有3个输入:</p><ol role="list"><li><strong>图片</strong>:这是插件Docker图片。插件步骤通过运行Docker容器来执行插件Docker映像中存在的入口点。</li><li>ConnectorRef :这是一个Docker连接器，提供了获取插件图像的凭证。如果图像是公开的，可以使用匿名Docker连接器。</li><li><strong>设置</strong>:设置是插件参数，作为环境变量提供给插件。环境变量名大写并以PLUGIN_为前缀，以防止命名冲突。示例环境变量可以是:</li></ol><p>让我们来看一个示例插件步骤。下面的步骤使用“插件/下载”插件图像，它下载源到目标路径中提到的url。在这里，它将AWS CLI下载到工作区目录，文件名为<em> awscli.zip </em>:</p><h6>-step:type:plugin<br/>name:download<br/>identifier:download<br/>spec:download<br/>connector:docking<br/>image:plugins/download<br/>settings:https://awscli . Amazon ws . com/awscli-exe-Linux来源:https://awscli . Amazon ws . com/awscli-Linux</h6><p>下面是一个CI管道，上面的插件步骤正在运行:</p><figure class="w-richtext-figure-type- "/><h2>为CI编写第一个插件</h2><p>现在我们已经介绍了插件步骤的基础，让我们来编写一个自定义插件！</p><p>我们将编写一个定制的git插件，克隆一个公共的git库并打印最后的提交信息。它将接受以下设置作为输入:</p><ol role="list"><li>repo_url: Git存储库url。</li><li>分支:要签出到的存储库的分支。</li><li>路径:克隆存储库的目录路径。默认情况下，它被假定为工作区目录。</li></ol><p>下面是实现定制git插件功能的bash脚本<em> clone.sh </em>:</p><h6>#!/bin/sh <br/> set -xe <br/> <br/> #如果没有设置路径，那么使用当前目录<br/> path=${PLUGIN_PATH:-。}<br/>mkdir-p $ { path }<br/>CD $ { path }<br/><br/>#克隆公共git repo并签出到分支<br/> git克隆${PLUGIN_REPO_URL}。<br/>git check out $ { PLUGIN _ BRANCH }<br/><br/>#打印最后一次提交<br/> git log -1 - stat</h6><p>现在，我们必须创建一个运行上述脚本的Docker映像。这可以通过将这个脚本指定为<a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" target="_blank"> Dockerfile </a>中的入口点来实现。以下是完整的Dockerfile文件:</p><h6>从alpine/git <br/> <br/> #将克隆脚本复制到Docker映像<br/>复制clone . sh/usr/local/bin/<br/><br/>#使克隆脚本可执行<br/>运行chmod+x/usr/local/bin/clone . sh<br/><br/>entry point["/usr/local/bin/clone . sh "]</h6><p>之后，我们需要构建这个映像并将其发布到Docker注册中心，并在CI管道中使用它。对于这个例子，图像被推送到“shubham 149/git-plugin”Docker Hub repo。</p><p>让我们在CI管道中使用这个定制的git插件。下面的插件步骤将在codebase目录中克隆“shubham 149/git-plugin”github存储库。</p><h6>-步骤:<br/>类型:插件<br/>名称:自定义git克隆<br/>标识符:克隆<br/>规格:<br/> connectorRef: dockerhub <br/>图像:shubham149/git-plugin <br/>设置:<br/>路径:代码库<br/>repo _ URL:https://github.com/shubham149/git-plugin.git<br/>分支:主</h6><p>下面是使用我们的定制git插件步骤运行的CI管道:</p><figure class="w-richtext-figure-type- "/><p>定制git插件源代码的链接:<a href="https://github.com/shubham149/git-plugin" target="_blank">https://github.com/shubham149/git-plugin</a></p><p>上面的例子使用一个bash脚本来创建一个插件。但是写插件就没有这个限制了。插件可以用你选择的任何编程语言编写。这里有一个用golang写插件的样板模板:<a href="https://github.com/drone-plugins/boilr-plugin" target="_blank">https://github.com/drone-plugins/boilr-plugin</a></p><h3>在本地测试插件</h3><p>插件可以作为Docker容器在本地环境中测试。下面是一个在本地运行定制git插件的Docker命令示例:</p><h6>dock run-RM \<br/>和plugin _ path = base code \<br/>和PLUGIN _ REPO _ URL = https://github。com/shubham 149/git插件。git \ <br/>和plugin _ branch = main \<br/>shubham 149/git插件</h6><h2>结论</h2><p>我们希望你喜欢你对插件的第一次尝试！从我们的<a href="http://plugins.drone.io/" target="_blank">插件注册表</a>可以看出，插件可以实现如此大的扩展性。从通知到Slack再到完整的Datadog集成，插件可以让一个伟大的产品变得更好。我们希望通过学习更多关于插件的知识，你会受到启发去编写你自己的插件。谁知道你能解决什么常见问题？</p><p><br/>为了进一步阅读插件，让我们看看Jenkins是如何错过我们关于<a href="https://harness.io/blog/dependency-plugin-hell-jenkins/" target="_blank">依赖地狱</a>的文章的！</p></div></div>    
</body>
</html>