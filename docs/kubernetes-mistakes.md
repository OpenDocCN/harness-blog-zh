# Kubernetes 错误:避免常见陷阱的初学者指南

> 原文：<https://www.harness.io/blog/kubernetes-mistakes>

作为初学者，有许多常见的 Kubernetes 错误需要避免。我们编制了一个列表，以及帮助绕过它们的解决方案和提示。

DevOps 已经走过了漫长的道路，Kubernetes 正在迅速接管技术世界。Kubernetes 是一个开源的容器编排系统:它自动化了容器化应用程序的部署、伸缩和管理。它是一个经济可靠地管理分布式集装箱集群的强大工具。虽然它被认为是一个复杂的工具，但如果配置不正确，它会给你带来挑战。如果不小心的话，这些 Kubernetes 的错误将会导致您的生产[环境](https://harness.io/blog/deployment-environments/)的失败。

为了避免这些陷阱，理解基本架构和 Kubernetes 的工作方式是必不可少的。这篇博客将探讨 Kubernetes 部署中的一些常见错误，它们是如何工作的，以及如何修复它们——或者用一些简单的技巧来避免它们。

## Kubernetes 的基本知识

***Image Source:*** [***Kubernetes.io***](https://kubernetes.io/docs/concepts/overview/components/)

Kubernetes 是一个容器编排平台。它使用一组 API 和命令行工具来管理集群中的容器，以自动化容器化应用程序的部署、扩展和管理。Kubernetes 的架构由一个主节点和多个节点或工作者节点组成。主节点负责集群状态和节点活动。它还管理工作负载，调度节点上的容器，并为容器分配适当的资源。节点可以是物理机或虚拟机，但是它们都需要访问 Docker 引擎和 kubelet 服务来使用 Kubernetes 集群。此外，一个节点需要与其他节点连接，以便在它们之间传输数据。

Kubernetes 使用了一个声明性的配置模型，使得针对预期和未预期的变化设计弹性系统变得容易。通过声明式配置，Kubernetes 处理容器和集群操作的底层复杂性，使构建具有高可用性、可伸缩性和安全性的集群变得简单。

您的部署越复杂，就越有可能犯这些错误。

## 忽略健康检查

***Image Source:*** [***Kaizenberglabs***](https://kaizenberglabs.wordpress.com/2019/10/28/kubernetes-essentials-readiness-liveliness-probes/)

在向 Kubernetes 部署服务时，健康检查对于帮助您保持服务按预期运行非常重要。要确认一切是否正常，了解 pod 的状态和 Kubernetes 集群的整体健康状况非常重要。要做到这一点，有启动，活性和准备就绪探测器，将帮助您了解您的应用程序的状态和运行在其中的服务。启动探测器确保 pod 成功启动和创建。活跃度探测器让我们测试应用程序是否是活动的。准备就绪探测用于确定应用程序是否准备好接收流量。

## 在容器中装载主机文件系统

在容器中挂载主机文件系统是一种常见的反模式，会导致许多失败。首先，必须知道在容器内部创建或修改的所有文件对外界是不可见的。

在容器中装载主机文件系统的主要用例是持久化数据。最简单的方法是将主机的本地目录挂载为容器文件系统中的一个目录。这样，写入该目录的任何内容都将保留在主机上。但是，装载主机文件系统会带来一些后果:

*   您不能跨多个容器共享状态(即，您不能将两个不同的目录挂载到两个不同的主机上)。
*   对主机文件系统的任何更改都将对其他容器隐藏。
*   如果不更改文件的所有权和权限，您就不能管理任何已装载目录上的文件。

为了避免这些后果，不要在容器中挂载主机的任何文件系统，除非您出于数据持久性的目的需要它们。

## 使用“最新”标签

在生产中使用最新的标签会造成混乱..由于版本和其他描述不够清楚，不建议在生产中使用它。此外，当事情发生时，它会造成更多的混乱，您需要将事情恢复到可用状态，因为您不知道应用程序运行的是什么版本。因此，最好总是使用有意义的 Docker 标签。我们中的许多人认为标签“最新”总是指向图像的新版本，但事实并非如此。默认情况下，图像获得标签“最新”，但这并不意味着什么。

## 将服务部署到错误的 Kubernetes 节点

Kubernetes 是一个复杂的系统，初学者最常犯的错误之一是将服务部署到错误的节点。在 Kubernetes 中，节点要么是主节点，要么是工作者节点。Kubernetes 中的每个作业都有一个控制器和一个调度程序。控制器在主节点上运行，调度程序在工作节点上运行。主节点的主要功能是与相应的工作节点同步，并管理集群级资源，如卷、网络和持久数据存储。

工作节点仅运行由其主节点分配的任务。这意味着如果您将服务部署到错误的节点，它可能无法正常工作——或者根本无法工作！此外，新容器的启动时间会比预期的长，因为它们需要等待一个可用的调度程序来分配任务，然后才能启动其他任务。

为了避免这种情况，在部署服务之前，您应该始终知道您的服务运行在哪种类型的节点上——主节点还是工作节点。在启动任何容器之前，您还应该检查 pod 是否可以访问集群中需要与之通信的其他 pod。

## 不采用部署模型

对于开发人员来说，应用程序部署是一项具有挑战性的任务，Kubernetes 通过其众多的部署技术使之变得容易。为了保持您的应用程序可用，并确保用户在部署新软件时不会受到可能的停机时间的影响，Kubernetes 建议使用部署策略:[蓝绿色、金丝雀和滚动](https://harness.io/blog/blue-green-canary-deployment-strategies/)。

***滚动部署策略*** 是 Kubernetes 的默认策略，用新版本的吊舱慢慢替换旧版本的吊舱。

在 ***蓝绿技术*** 中，蓝色和绿色版本同时部署，但同一时间只有一个版本是活动的。我们先把蓝色当做老版本，绿色当做新版本。所以，一开始所有的流量默认发送到蓝色，如果最新版本(绿色)满足所有要求，那么旧版本流量分流到新版本(从蓝色到绿色)。

***金丝雀部署策略*** 用于进行 A/B 测试和暗投放。它类似于蓝绿色方法，但更受控制。在这种策略中，我们将看到流量从版本 A 缓慢移动到版本 B。想想:煤矿里的金丝雀！

## 重复部署

Kubernetes 中最常见的错误之一是重复部署策略。当我们创建相同状态的多个副本，并行部署到不同的集群时，就会发生这种情况。

这是什么意思？实质上，这意味着如果一个集群停止运行，另一个集群将继续处理您的部署请求。但是，当它们恢复运行时(或者如果您添加了它们)，两个副本都将处理请求并使您的请求加倍，因为有两组副本在运行。这可能是个坏消息，因为它可能会超额预订底层主机上的 CPU 和内存。要修复这个错误，我们建议使用 Headless Service 或 Daemon Set 之类的服务类型，以便在任何给定时间只有一个版本的部署在运行。

## 在生产环境中只使用一种容器(即无状态)

最初，容器和容器化是为无状态应用程序设计的，但后来人们做了很多努力来支持有状态应用程序。随着 Kubernetes 支持容器化并支持现代数据驱动的应用程序，使用有状态应用程序变得至关重要。

开发人员犯的一个常见错误是在生产环境中只使用一种容器——通常是无状态的——而他们应该同时使用有状态和无状态容器。很多人误以为所有的容器都是一样的，其实有显著的区别。有状态容器允许您将数据存储在像磁盘这样的持久存储上，这意味着它们永远不会丢失数据。相比之下，无状态容器会一直保存它们的数据，直到它们运行，之后就永远丢失了(除非备份)。因此，同时使用有状态和无状态容器是一个很好的实践。

## 部署应用程序时不考虑监控和日志记录要求

不考虑监控和日志记录的需求可能是灾难性的。由于这种疏忽，开发人员无法看到他们的代码或应用程序是如何在生产环境中运行的。

为了避免这种错误，开发人员应该在 Kubernetes 上部署应用程序之前设置一个监控系统和一个日志聚合服务器。一旦这些系统就位，就可以测量您的应用程序的性能，并查看您需要进行哪些更改来优化它以获得更好的性能。

当您只使用 Kubernetes 本身提供的服务和工具而不使用第三方解决方案时，可能会出现供应商锁定。例如，您可以使用 CRI 容器运行时接口来部署您的容器，而不是 Docker 或 rkt 容器。此外，许多开发人员由于集群中没有足够的容量或者在一天中错误的时间部署应用程序而陷入混乱状态。

## 在没有任何安全配置的情况下部署您的应用程序

部署应用程序时，您应该始终牢记安全性。那么，当涉及到安全性时，需要考虑哪些最重要的事情呢？例如，使用可从集群外部访问的端点，不保护您的[机密](https://harness.io/blog/secrets-management-ci-cd/)，不考虑如何运行特权容器，等等。安全地。

Kubernetes 安全性是任何 Kubernetes 部署的一个组成部分。安全挑战包括:

●授权——身份验证和授权对于控制对 Kubernetes 集群中资源的访问至关重要。

●网络——Kubernetes 网络包括管理覆盖网络和服务端点，以确保容器之间的流量在集群内安全路由。

●存储——确保集群中的存储安全在于确保未经授权的用户或进程无法访问数据，并且数据。

Kubernetes API 服务器有一个 REST 接口，提供对所有存储信息的访问。这意味着用户只需向 API 发送 HTTP 请求，就可以访问 API 中存储的任何信息。为了防止未经身份验证的用户访问这些数据，您需要使用受支持的方法(如用户名/密码或基于令牌的身份验证)为 API 服务器配置身份验证。

这不仅仅是保护集群本身，还包括集群上的秘密和配置。为了防止集群受到攻击，您需要在其上配置一组安全控制。其中一个健壮的安全控制是使用 [RBAC](https://harness.io/blog/rbac/) 来保护 Kubernetes 集群:基于角色的访问控制可以用来保护 Kubernetes 集群，方法是根据分配给用户的角色来限制对资源的访问。这些角色可以配置为“管理员”或“操作员”管理员角色拥有完全访问权限，而操作员角色对群集中的资源拥有有限的权限。通过这样做，我们可以控制和管理任何访问集群的人。

无耻之徒:Harness 拥有细粒度的 RBAC 功能，我们有一篇很棒的文章解释了 Harness 软件交付平台中的[用户&角色管理，如果你感兴趣的话！](https://harness.io/blog/user-role-management/)

## 不设置资源消耗限制

如果您看到您的资源利用率和您的账单激增，那么是时候您采取控制，并确定哪些服务是必要的，哪些不是。一种方法是对您的应用程序进行压力测试。

然后，您可以对容器的 CPU 和内存设置限制。Kubernetes 在其资源利用类别中定义了[【请求】和【限制】](https://harness.io/blog/recommendations-deep-dive/)。请求代表应用程序运行所需的最小资源，限制定义最大资源。对资源没有控制权也意味着我们没有监控应用程序。我们可以在部署 YAML 中指定资源限制。

[利用云成本管理](https://docs.harness.io/article/ikxjmkqi03-recommendations) (CCM)通过展示资源优化机会，为您的 Kubernetes 集群提供建议，以减少您的每月支出。这些建议是通过分析您的工作负载过去的 CPU 和内存利用率来计算的。该实现使用直方图方法来计算建议。

## 结论

Kubernetes 很棒，但学习曲线有时会令人望而生畏。我们知道开发人员在运行 Kubernetes 时会遇到问题，因此，我们列出了这些常见的错误和陷阱以及避免它们的技巧，以便您可以高效地使用您的 Kubernetes 部署。此外，通过密切关注您与 Kubernetes 的交互并理解它与您部署的服务之间的交互差异，可以避免这些错误。

在你的申请上线之前，确保你做了尽职调查。如果你需要帮助来管理这一切，试着利用并[完成任务！](https://app.harness.io/auth/#/signup)