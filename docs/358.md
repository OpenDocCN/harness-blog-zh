# 从 Jenkins 迁移到 Harness CIE:旅程

> 原文：<https://www.harness.io/blog/jenkins-to-cie-journey>

一开始，我们给你产品视角。现在，我们给你我们的实际规划和执行见解。

在这篇博客中，我们将回顾从 Jenkins 到 CIE 的 CI 工具迁移之旅。这篇文章解释了我们如何计划和执行实际的迁移过程。对我们来说(一个 170 开发工程师的组织)，它花了大约 1 个月完成。最初的几周用于规划和确定所有者，接下来的两周我们实际上是在迁移工作。有关产品开发方面的详细信息，请参见远离詹金斯的。

首先，让我们快速浏览一下 Jenkins 所面临的问题:

1.  **Jenkins 主内存激增:**在过去的几个月里，我们一直在努力解决 Jenkins 内存激增的问题。通常，Jenkins master 的内存消耗越来越高，它无法安排构建。查看日志后，我们禁用了一些插件。这降低了问题发生的频率，但没有解决问题。过去培养 Jenkins 需要几个小时，这导致了[开发人员生产力](https://harness.io/blog/developer-productivity/)的损失。
2.  队列中等待时间长:通常，构建会在队列中停留很长时间。尽管有足够的资源可用，但是在构建执行开始和队列进入时间之间会有 10-20 分钟的延迟。这是 Jenkins 的一个性能瓶颈。
3.  **安排代理需要很长时间:** Jenkins 过去常常需要很长时间来调配 pod。我们试图寻求谷歌的支持，因为我们认为这是 GCP 方面的事情。然而，问题没有得到解决。

**规划迁移**

考虑到眼前的问题，我们想离开詹金斯。现在，面向未来的产品 Harness CI 来拯救我们了！因为它是一个基于 SaaS 的 CI 工具，所以管理 Jenkins master 的开销现在没有了，当然，那些性能瓶颈也成为了过去。

那么，我们是如何处理迁移的呢？

最初，开发团队用 PR-checks 作业(这些是为创建的每个 PR 运行的 CI 作业-这些作业作为质量关)做我们的概念验证，以查看几天内是否一切正常，并解决观察到的任何问题。一旦我们得到了开发团队的批准，我们就想出了一个将所有 Jenkins 的工作迁移到 CIE 的计划。

鉴于时间跨度很短，迁移的主要挑战是找到这些工作的所有者。以前，Jenkins 用户权限对我们来说不够严格，组织内有多人拥有作业配置权限。因此，找出谁拥有所有的工作确实是一个挑战！为了解决这种情况，我们想出了分而治之的策略。我们根据不同的方面对工作进行分组，创建更小的组，并确定这些组的所有者。

下图概述了这些步骤及其时间表。虽然项目运行了一个月，但实际的迁移在两周内完成。我将解释整个迁移过程，迁移过程中面临的问题，以及我们如何找到缓解上述问题的解决方案。

## 工程计划

基本上，在计划开始时，我们关注两件事:对作业进行分类，并找出适当的备份策略。我们还想从我们的 CIE 工作中发布我们自己的 CIE 产品。这是一个挑战，因为 CIE 修补程序版本中的任何潜在错误都很难发现。

为了避免这种情况，我们将我们的发布版本和所有其他版本分开。我们在暂存环境中运行发布版本，该环境始终是生产环境之后的一个版本，所有其他作业都在我们的生产帐户中运行。在工作和[环境](https://harness.io/blog/deployment-environments/)中有这种清晰的隔离帮助我们避免了发布的任何问题。

## 迁移的执行

### 将 Jenkins 的工作分成小组

我们根据 Jenkins jobs 的用途将其分为两组。我们编写了一个 groovy 脚本来确定作业是否在前一个月运行过。

导入 jenkins.model.Jenkins
导入 Hudson . model . abstract project
导入 Java . SQL . timestamp；

def numDaysBack = 30；
def cut of date = system . current time millis()-1000 l * 60 * 60 * 24 * numdays back；
println cut of date；

Jenkins . instance . getallitems(abstract project . class)。每个{ it->
println(" = = = = = = = = =未使用的作业:\ n = = = = = = = ")；
if (it.getLastBuild()！= null & & it.getLastBuild()。getTimeInMillis()<cut of date){
println it . get full name()；
}
println(" = = = = = = = = =当前正在运行的作业:\ n = = = = = = = = "；
if (it.getLastBuild()！= null & & it.getLastBuild()。getTimeInMillis()<cut of date){
println it . get full name()；
}
}

使用这个脚本，我们将作业分成两组:

**a)当前正在运行的作业。**

b)未使用的工作。

然后，我们查看了未使用的作业，以了解哪些作业可以清除。从 Jenkins UI 本身来看，清除这些作业是相当直接的。挑战在于确定过去没有运行的作业是否需要。对于这些工作，我们想出了一个策略，让他们禁用几个星期，看看是否有人需要他们。如果有人需要它们，我们会迁移它们。否则，这些作业将被删除。

### 备份策略

在设计我们的备份策略时，我们必须关注两个不同的方面:

Jenkins 主程序和插件的备份。

**b)作业的备份和恢复能力**。

对于第一个，我们将 Jenkins 主目录和插件目录备份到一个存储桶中。但是第二个更重要！为了确保我们不会丢失任务的配置和历史记录，我们选择了一个 [Jenkins 插件](https://plugins.jenkins.io/shelve-project-plugin/)。选择这个插件有几个原因，即:a)易用性——一切都可以在 Jenkins UI 上完成，b)它可以为从设备和主设备备份历史和配置。

### 团队协作

一旦我们完成了这些任务，我们就清楚了哪些任务需要迁移和备份，以及哪些团队应该参与其中。在工作被审查之后，我们将团队标记为管道的所有者。我们涉及了 5 个团队，他们拥有一些管道，以及在迁移过程中进行协作的构建和工具。如果我们想要粗略估计我们的工作，我必须说我们有几个构建工程师，他们与不同团队的 5 个代表一起全职工作，投入 20-30%的带宽，持续几周完成迁移。

我们使用一个简单的 Google 文档来准备工作列表，并通过文档跟踪迁移的进度。总的来说，该项目在 Asana 得到跟踪。

在下面的截图中，您可以看到我们是如何分离作业并划分团队特定的作业来开始迁移的。首先，我们对 Jenkins 和 CIE 之间的差距进行了分析，以确保我们没有遗漏任何重要内容。

### 缩减詹金斯的规模

尽管我们在迁移过程中遇到了一些小问题，但我们确实在几周内完成了大部分工作的迁移。最初，有 4 个作业我们无法迁移。其中，有两个现在正在使用我上面提到的策略。在其他团队的帮助下，我们在很短的时间内成功迁移了 167 个作业。没有所有相关人员的合作，这是不可能的。

我附上迁移的摘要，让您了解我们迁移的工作数量，以及我们不能迁移的工作。实际迁移从 6 月 31 日开始，到 5 月 13 日结束。

我们在詹金斯采取的第一步是停止安排新的工作。我们是从詹金斯政府开始这么做的。然后，我们开始缩减连接到 Jenkins 的所有节点池。一旦所有的节点池都被适当地清空，我们就确保所有的作业都被成功地迁移，并且没有人对那些未使用的作业提出任何担忧。我们在 14 号成功关闭了 Jenkins master 并宣布了它。

## **CIE 概念和最佳实践**

在迁移过程中，我意识到 CIE 中的配置非常简单易用。我必须说，比较现有的 CI 工具，如 Jenkins、Teamcity、Travis CI、GitLab 等，是一种很好的体验。去驾驭。作为一般的实践，我们使用 CI 工具来构建管道和下载代码，运行测试，运行静态检查，并发布构建过程中生成的工件。为了完成这些操作，我们需要使用 CI 连接到外部系统——例如，GitHub、Sonar、GCR、Docker Hub 等。-我们使用凭证连接到这些外部系统。我们还在 CIE 中配置构建、步骤和通知。我将尝试强调 CIE 中的不同概念和特征，以便更容易理解迁移过程的要求。

您只需要一个 SaaS CIE 帐户和一个 Kubernetes 集群，就可以开始构建开发、测试和部署应用程序的管道。

### 帐户配置

组织和项目: Harness CIE 支持项目管理的层次模型。作为管理员，您可能希望基于团队隔离 CI 作业。这将帮助您更好地控制这些项目。首先，我们创建组织，以便项目可以映射到它们。为此，请转到帐户设置→组织。此后，无论何时通过转到 Home → Projects 创建项目，都应该选择正确的组织。您可以将用户分配给组织，以便更好地管理访问控制。

**连接器和秘密:**与 Jenkins 相比，这是一个很棒的特性！所有外部连接器和机密都可以轻松管理。为此，请转到帐户设置→帐户资源。作为一个好的实践，我想提一点:CIE 确实支持帐户级和项目级的连接器和秘密。因此，在创建它们时，请确保您没有在项目级别创建不必要的项目。这将暴露出访问控制中的许多困难。

我们有许多不同类型的连接器，如 GitHub、JFrog、Vault、Docker Hub、Kubernetes 等等。因为我们使用基于 K8s 的 pod 来运行我们的构建，所以我们使用 Kubernetes 连接器来进行通信。作为帐户级别的机密，我们有用于连接器的凭证，以及一些全局机密，如用于大多数项目的吉拉凭证、签名证书等。

**代表:**这就是 CIE 应用程序如何与 Kubernetes 集群一起运行。这个 jar 负责处理用户发起的所有任务。

**认证:**您可以将公共 OAuth 提供者与 CIE 集成在一起，对用户进行认证——例如:Google、Linkedin、Bitbucket 等。

### 项目配置

**Pipelines:** 理想情况下，每个项目都应该归你公司的一个组织/团队所有。每个项目可以容纳多条管线。可以通过选择项目→项目设置来配置特定于项目的用户、连接器和机密。这是你应该妥善处理的事情。将项目、帐户连接器和机密分开应该是一种最佳实践。

### 管道和阶段配置

**阶段:**每个管道都是阶段的组合。您可以在管线创建过程中添加顺序/并行阶段。早期版本的 Jenkins 不支持这一点。复杂的管道可以分为不同的阶段。您可以使用 UI 来创建步骤，并通过拖放来排列它们。大多数其他 CI 工具都不支持这一点。

**基础设施:**这是你希望你的阶段被执行的地方。在 Jenkins，我们必须指定要提及的代理的标签。代理的配置位于“管理 Jenkins”菜单选项内的单独页面中。CIE 在这里更灵活。您可以在不同的容器中运行多个阶段——Jenkins 不支持这一点。

**步骤:**每一步都是阶段的组合。CIE 支持不同种类的步骤(例如，运行、将工件上传到 S3、构建并推送到 GCR 等。)，类似詹金斯。

**触发器:**和其他 CI 工具一样，CIE 支持带有 Timer、GitHub、Bitbucket 等的触发器。迁移时，您可以轻松地将 Jenkins 构建触发器配置为 CIE 触发器。

### 迁移的好处

迁移到 CIE 帮助我们避免了与 Jenkins 一起面临的问题。我们现在看到了其他好处:

**开发人员生产力:**随着 Jenkins 每周停机一两次，停机期间生产力会持续下降。事实上，消除队列等待时间和 pod 分配延迟极大地提高了我们开发人员的生产力。我可以说，通过迁移到 CIE，我们已经将开发人员的生产率提高了大约 20%。

**可见性:**由于 CIE 是我们自己的内部产品，我们在工具上确实有了更多的可见性。与 Jenkins 相比，间歇性故障很容易调试，在 Jenkins 中，许多事情对我们来说是“黑箱”。

**CI & CD:** 因为我们用 Jenkins 做 CI，用 Harness 做 CD，所以我们的交付管道并不统一。但是在迁移之后，我们现在可以将 Harness 专门用于 CI/CD。这使得我们有一个单一的管道来构建我们的代码并将其部署到我们的 QA 环境中。这是一个很棒的特性。展望未来，我们在这方面确实有一些改进计划！

## 结论

我们喜欢以高调结束文章，所以我们就把它留在这里吧！CIE 让我们的工程组织的生活变得更加轻松，我们相信它也能让您的工作变得更加轻松。如果你还在学习阶段，我们很乐意邀请你阅读更多关于[测试智能](https://harness.io/blog/test-intelligence/)的内容，这是一项 CIE 功能，可以为你节省更多的时间和精力。