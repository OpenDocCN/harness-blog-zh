<html>
<head>
<title>Harness CI With AWS VMs | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>利用AWS虚拟机管理配置项|管理</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/harness-ci-aws-vms#0001-01-01">https://www.harness.io/blog/harness-ci-aws-vms#0001-01-01</a></blockquote><div><p>测试版支持提供了操作指南！在本帖中，我们将探索AWS虚拟机支持的特性，并探索它们的设计和架构。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>Harness CI最近增加了对AWS虚拟机(VM)的测试版支持。这意味着CI构建可以在Harness平台中的Kubernetes集群或AWS VM上运行。在本帖中，我们将探索AWS虚拟机支持的特性，并探索它们的设计和架构。</p><p>AWS VM特性附带了对. NET的测试智能支持。它支持使用Kubernetes基础设施的Harness CI中已经存在的所有特性。一个主要的新增功能是支持在Windows操作系统上运行构建。除此之外，运行步骤还可以在主机虚拟机上执行命令。因此，AWS VM是不适合在容器内执行的CI管道的默认选择。</p><p>此外，steps可以使用AWS VM在管道上运行Docker命令。这在Kubernetes基础设施上是不可行的，因为它限制了对pod的特权访问。</p><h2>设计</h2><p>每个CI阶段都在一个专用的AWS VM上运行，该VM在构建执行完成后终止。与在多个构建中重用虚拟机相比，这种方法的一个主要优点是不需要清理工作空间，因为每个构建都在一个新的虚拟机上运行。</p><p>这个特性需要在一个代理虚拟机上安装<a href="https://github.com/drone-runners/drone-runner-aws" target="_blank"> Drone Runner AWS </a>。安装带滑道的代表的步骤可在<a href="https://github.com/harness/cie-vm-delegate" target="_blank">此处</a>查看。运行者负责AWS虚拟机的生命周期管理，包括创建、删除等。此外，它处理CI构建运行的虚拟机上的步骤的执行。运行程序在启动时启动HTTPs服务器，委托代理通过端口3000上的localhost与它进行交互。</p><figure class="w-richtext-figure-type- w-richtext-align-fullwidth"/><p>CI构建执行包括三个阶段:初始化、步骤执行和清理。所有这些阶段都是通过委派任务发生的。</p><h3>初始化</h3><p>此阶段创建运行构建所需的资源。一旦初始化任务到达委托代理，它就调用runner来创建一个VM，构建将在其上运行。</p><p>Runner使用AWS golang sdk创建一个AWS VM。作为虚拟机创建的一部分，它还会在构建虚拟机上安装一个代理，特别是lite-engine。lite-engine安装通过一个云初始化脚本进行，该脚本从云中下载并在虚拟机启动时启动它。Lite-engine启动一个HTTPs服务器，跑步者使用它通过一个安全的通道与服务器通信。</p><p>lite-engine HTTPs服务器使用自签名证书以及服务器和客户端证书。客户端证书位于运行者上，用于向服务器验证客户端(此处为运行者)的身份。lite-engine上的服务器证书用于加密传输中的数据。</p><h3>分步执行</h3><p>在步骤执行阶段，步骤按照CI管道中定义的顺序执行。一旦执行一个步骤的任务到达委托，它就调用运行器来执行它。然后，runner通过HTTPs调用lite-engine来执行该步骤。Lite-engine要么直接在VM上作为子进程运行该步骤，要么在docker容器上执行它。</p><h3>清除</h3><p>清理阶段标志着CI阶段的完成。它删除为构建执行分配的资源。委托代理在收到清理任务时，调用运行程序，运行程序删除分配给已完成构建的AWS VM。</p><h2>虚拟机池</h2><p>虚拟机启动可能需要几分钟，尤其是windows虚拟机，启动需要6-8分钟。如果虚拟机是作为构建执行的一部分创建的，那么由于虚拟机的启动时间，它会显著增加构建时间。</p><p>Harness使用一种池策略来维护用户指定数量的warm AWS实例。热实例是预先初始化的<a href="https://aws.amazon.com/ec2/" target="_blank"> Amazon弹性计算云(Amazon EC2) </a>实例，其VM启动已经完成。每当执行具有CI阶段的管道时，执行初始化任务的运行程序检查AWS实例是否存在于池中。如果存在，则将虚拟机从池中分离出来，并分配给CI阶段执行。Runner创建一个新的Amazon EC2实例来维护池的大小。因此，虚拟机池确保初始化只需几秒钟就能完成，而不是几分钟。</p><figure class="w-richtext-figure-type- "/><p>VM池必须定义为运行程序配置文件的一部分。它允许设置池的大小，以及虚拟机的配置，包括AMI、实例类型、网络等。</p><h2>结论</h2><p>将CI与AWS VM结合起来，可以灵活地在Amazon EC2实例上运行Linux和Windows版本。我们希望这一高层次的设计概述能够让我们深入了解Harness CI如何与AWS虚拟机协同工作。</p><p>想亲眼看看吗？现在就报名参加你的<a href="https://app.harness.io/auth/#/signup/?module=ci" target="_blank">免费试用</a>驾驭CI吧！</p></div></div>    
</body>
</html>