# Kubernetes 成本分析:管理您的 Kubernetes 成本|利用

> 原文：<https://www.harness.io/blog/kubernetes-cost-analysis>

第一步:分析。第二步:优化。只需两步就能到达 Kubernetes cost nirvana，但做起来比听起来难多了。查看这个博客，获得一些可行的技巧，现在就开始这样做，并看看 Harness 如何使它变得容易。

您上一次在 Kubernetes 中启动新的工作负载并将资源请求和限制设置得足够高以至于性能永远不会成为问题是什么时候？现在，你上一次根据实际使用情况回头看是否可以使资源配置文件更有效是什么时候？你是否曾被告知因为这个原因你在云资源上花费了太多的钱？

你很有可能相当有规律地做第一部分，而第二部分只是在需要的时候，当有人告诉你让它更有效率，因为它花费太多。对于工程团队来说，这是一个常见的故事，他们是云资源的主要消费者，他们的任务是发现和解决成本问题，这些工作堆积在已经存在的开发队列之上！这可能是一个真正的麻烦，需要几天甚至几周才能解决。

好消息是，即使云成本问题是一个永远不会完全消失的现实，也有办法减少这种阻力。

## Kubernetes 成本管理中的问题

Kubernetes 成本问题的核心在于 DevOps 范式的兴起。DevOps 绝不是一件坏事。事实上，这也是您能够比以往任何时候都更快地行动并向客户提供创新的原因。作为这种软件交付效率的一部分，Kubernetes 在开发和部署中的使用将一直存在，因为它简化了应用程序的部署、管理和扩展。

然而，硬币的另一面是与快速行动相关的成本。虽然基础架构正在为高质量的最终用户体验而优化，但它可能会带来高昂的代价。无论你是在本地，还是在 AWS、GCP、Azure 或任何其他 Kubernetes 支持的平台上，这都将是一个问题。控制这些成本是很重要的，所以让我们先来探讨一下 Kubernetes 今天的成本管理问题。

### 成本不是首要问题

交付速度和性能水平通常是工程团队的重中之重。在许多情况下，直到组织或预算负责人遇到[账单冲击](https://harness.io/blog/continuous-efficiency-capabilities/)时，成本才成为问题。到那时，要理解为什么成本会膨胀以及我们能做些什么将会变得非常困难。

这种方法的问题是，它通常会变成了解成本的一次性练习，并有可能使成本达到可接受的水平。归根结底，对于工程师来说，成本管理仍然不像应用程序性能管理那样是优先考虑的事情。在这个问题解决之前，工程师仍然会优先考虑高性能的应用程序和代码，而不是成本。

### 高估资源需求

到目前为止，这是 Kubernetes 成本最常见的原因。就成本管理而言，这也是最容易实现的目标。因为工程师优先考虑性能，所以他们选择将资源请求和资源限制设置在他们认为需要的之上。这是为了确保高性能的应用程序和良好的最终用户体验。想象一下，如果工程团队反其道而行之，最终导致资源供应不足。这对最终用户和组织来说都不是一个好结果。

同时，猜测应用程序或服务将需要什么资源是一项艰巨的任务，有时甚至是不可能的。在服务上线之前，工程师没有获得准确的利用率指标，而是做最有意义的事情，并提出大量资源请求。好消息是，一旦投入生产，就更容易看到如何缩小规模。

### 轻松实现“一劳永逸”的扩展

自动缩放器是强大的工具，Kubernetes 以四种方式提供它们:[水平 Pod 自动缩放器](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/)、[垂直 Pod 自动缩放器](https://cloud.google.com/kubernetes-engine/docs/how-to/vertical-pod-autoscaling)、 [Kubernetes 事件驱动自动缩放器](https://keda.sh/)和[集群自动缩放器](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler)。前三个帮助您自动扩展工作负载或单元，第四个处理集群和节点的自动扩展。

部分是因为 Kubernetes 抽象出的基础设施管理复杂性，很容易设置自动扩展策略并让其运行。如果没有更精细的优化，比如在工作负载级别或合理调整计算实例的规模，Kubernetes 很乐意在资源需求没有得到满足时增加更多 AWS EC2 实例。这通常会导致未使用或闲置的容量。

糟糕的自动缩放策略是任何 Kubernetes 优化努力的祸根。如果限制设置不正确或通过奇怪的边缘情况满足条件，可能会导致失控的自动缩放，从而导致成本大幅增加。与此同时，自动缩放是一个很好的试金石，可以检验出你的假设中有什么地方出错了。例如，您可能会看到猖獗的非异常扩展，这表明用户增长或成本失控，自动化可能是第一个需要关注的地方。

### 缺乏可见性

如果你甚至不知道存在什么成本，以及它们来自哪里，你怎么能管理成本呢？这似乎是显而易见的事情，但在实践中很难做好，尤其是当基础设施资源一直在变化时。

您希望能够合理地将成本归因于其来源，也就是所谓的成本分配。根据业务环境的不同，这可能会降低到开发人员、项目、应用程序、服务、业务单元或对您的组织的需求有意义的任何东西的级别。在 Kubernetes 中，这可以通过查看集群、节点、名称空间、工作负载和 pod 来实现。

### 缺乏背景和问责制

说你需要能见度是一回事。让正确的人获得正确的可见性是一个复杂的问题。虽然成本分配很重要，但向利益相关者提供正在使用哪些资源以及如何使用的准确视图是至关重要的。

更有价值的做法是，让他们了解自己如何使用资源，为什么应该缩减规模，以及应该做些什么来提高效率，而不是告诉他们需要缩减特定集群的规模。此外，这还允许组织在提供适当的环境时创建责任和向下转移。

### 工具不足

没有合适的工具，你如何进行 Kubernetes 成本管理？当然，你可以自己吸收所有的数据并创建自己的解决方案。但是，这种定制的解决方案在需要改变时容易修改吗？

工具的目的是围绕给定问题的基本需求创建一种标准，而今天没有太多好的工具为 Kubernetes 成本管理做这些。事实上的方法是使用 Kubernetes APIs 连接到 Prometheus，并与 Grafana 之类的东西一起使用，以便更好地可视化和理解成本。这是可行的，但也可能是一个麻烦，而且事情肯定会被错过。还要考虑如何从 Prometheus 获得这些成本指标，并将它们转化为合理的成本节约机会。这似乎是一个简单的两步过程，但每一步都有其自身的复杂性，这使得有效管理 Kubernetes 成本变得很困难。如果你不能有效地管理成本，你怎么能有效地利用你的资源呢？

## 改善 Kubernetes 成本分析的技巧

分析是正确管理 Kubernetes 成本的第一步。如果你能理解成本是怎么回事，你就能描绘出如果你进行优化的话会是什么样子。我们来看看几种分析成本的方法；你甚至可以考虑这些连续的。

### 标签资源

标签就像你在云资源中找到的标签一样。在 Kubernetes 他们只是被称为标签。标记您正在使用的资源可以使以后更容易找到它们，并将它们与任何有意义的资源逻辑分组相关联。

通过实施一个可靠的标记策略，在您的 Kubernetes 资源车队中保持良好的覆盖率，您将能够通过任何相关的上下文来分割您的所有资源。这可以是从高层次的角度，下至最细粒度的成本分配用例。然而，这说起来容易做起来难，因为不仅仅是你，你的整个团队，甚至整个组织都需要参与进来，以充分利用标签。也就是说，即使有一个最小的标签实践，你也能比什么都没有更好地理解成本并采取行动。

### 可视化可见度

标签很棒，开源的普罗米修斯也很棒。但是如果你只有这些，你就看不到你的成本。Prometheus 非常适合设置对 Kubernetes 服务的监控，但不太适合创建可视化和仪表板。

当涉及到弄清楚正在发生什么的时候，视觉化创造了奇迹。一些您可能无法通过命令行输出或表格视图看到的东西，当您在图形中呈现时，往往会变得非常明显。通过良好的可视化，分析和理解成本都变得更加容易。

也要记住，这种观点不仅仅是针对你的，也是针对那些与你的日常生活没有太多关联、可能有疑问的人的。这不仅仅是为自己创造良好的视图，而是在整个组织中创造良好的可见性，以进行一些出色的分析和优化。

### 查找空闲和未分配的资源

这就是低垂的果实！无论您是使用 Kubernetes APIs 和 Prometheus 来提取这些数据，还是使用 Grafana 或其他工具创建一个很好的可视化效果，找出哪里存在直接浪费都是管理成本的最佳机会，并且比其他节约方法需要更少的分析和验证。

闲置和未利用的资源通常是过度调配基础架构的结果，这些基础架构旨在优化性能，没有停机风险或终端用户体验问题。因为工程师优先考虑性能，他们会为应用程序或服务过度分配资源，然后再也不会回来。然而，这转化成了资源的闲置、未充分利用或未分配——而且这些仍然要花钱。在下面的例子中，几乎 75%的 Kubernetes 资源都没有被使用。把这些都砍掉是极其危险的。但是，利用率一定会提高，从而降低成本。

### 工作负载合理调整和集群缩减机会

寻找机会缩小整个集群或节点的规模，或者调整单个工作负载的大小，需要做更多的工作。首先，您必须找到存在浪费的工作负载和集群。然后，你必须验证这些是否是削减成本的真正机会，或者是否是一个健康的过剩量。最后，您可以确定在保持最佳成本配置的同时，为了保持应用程序或服务的性能，实际可以削减多少。

虽然这可能需要时间，但您可能会认识到这是组织间的一种常见做法，以找到创建更有效的成本概况的方法。一个工作负载真的需要请求 7000m CPU 和 20Gi 内存吗？是否有更小的 AWS EC2 实例更适合该节点？如果实例是 GPU 优化的而不是 CPU 优化的，它的性能会更好吗？或者我们需要进行内存优化吗？跨节点共享 AWS S3 存储桶怎么样？

### 使用免费试用的 Kubernetes 成本工具

在 Kubernetes 的成本分析和管理工具中(利用云成本管理， [Kubecost](https://harness.io/learn/developer/devops-tools/kubecost-vs-harness/) )，许多都提供免费试用，你可以很容易地注册，以便立即可视化、分析和优化成本。显然，由于免费试用的性质，这很可能是一次性的解决方案，但是这些工具会让你知道你在做什么。如果不是整个 Kubernetes 环境，它还会让您体验一下优化的 Kubernetes 集群可能是什么样子。

例如，利用免费试用的[云成本管理](https://app.harness.io/auth/#/signup/?module=ce)，您可以获得集群、命名空间、工作负载、节点、应用程序、服务和环境的现成可见性，而无需标记或标签。您还可以深入了解已利用、闲置和未分配的资源，以及基于历史使用数据优化工作负载的内置建议。像 Harness Cloud Cost Management 这样的工具消除了分析和优化 Kubernetes 环境的辛劳和单调。

## 我们的 Kubernetes 成本分析方法

在 Harness，我们认为 Kubernetes 的成本分析和管理应该是一等公民。正如存在大量工具来简化云成本管理一样，Kubernetes 也应该得到同样的工具，因为它已经变得无处不在。Harness Cloud Cost Management 提供了一个差异化的成本视图，侧重于为工程团队分析、管理和优化 Kubernetes 环境。事实上，这是我们建造的第一个东西！

我们相信，这种分析和管理是通过解决三种不同的使用情形来实现的，并且我们已经构建来支持这一点:

1.  **成本可见性**，或了解成本的来源
2.  **节约成本**，或者想办法少花钱
3.  **成本预测**，或者预测未来的成本

如果没有解决所有这三个用例，剩下的就是 Kubernetes 成本的不完整画面，以及如何创建更具成本效益的基础架构。

在您探索 Kubernetes 成本分析的过程中，您也看到了 Harness Cloud 成本管理及其仪表盘可视化的截图，展示了它是如何融入画面的。

*Cost Forecasting in Harness Cloud Cost Management*

管理 Kubernetes 的成本应该不难。工程团队不应该为了理解和优化他们在 Kubernetes 上的基础设施而付出额外的努力。组织不应该对其成本视而不见，也不应该努力规划、预测和优化成本。这就是 Harness Cloud Cost Management 要解决的问题。

## 利用 Harness 改进 Kubernetes 的成本分析、管理和可见性

无论你是第一次使用 bill shock，还是经验丰富的专业人士，管理 Kubernetes 的成本都很重要。做这件事有更简单的方法。借助 Harness Cloud Cost Management，您可以让您自己和您的组织能够在任何级别上分析成本，并简化寻找和实施优化所需的工作。

Harness 是一个[软件交付平台](https://harness.io/products/platform/)，它是根据工程团队的需求而构建的，使他们能够轻松了解其使用情况，并控制其优化。无论是回答为什么事情会以这种方式设置的问题，还是验证优化机会，Harness 都会支持您。

当您准备好简化 [Kubernetes 成本管理](https://harness.io/learn/ebooks/ebook-cost-management-kubernetes/)时，请阅读我们的电子书，离云账单更近一步，让您高枕无忧。