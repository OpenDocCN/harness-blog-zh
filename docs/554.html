<html>
<head>
<title>Deploying to AKS, EKS, and GKE all at Once | Harness</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>同时部署到阿拉斯加、EKS和GKE |线束</h1>
<blockquote>原文：<a href="https://www.harness.io/blog/deploying-to-aks-eks-gke#0001-01-01">https://www.harness.io/blog/deploying-to-aks-eks-gke#0001-01-01</a></blockquote><div><p>随着基础架构复杂性的增加，您的部署复杂性也会增加。在这个例子中，学习如何轻松地跨多个Kubernetes提供者进行部署。</p><div fs-richtext-element="rich-text" class="blog-rtf w-richtext"><p>Kubernetes被看作是你构建下一代平台的平台。Kubernetes并非没有运营复杂性，这就是为什么许多组织希望公共云供应商在其上运行他们的Kubernetes工作负载。Azure Kubernetes服务(<a href="https://azure.microsoft.com/en-us/overview/kubernetes-on-azure/" target="_blank"> AKS) </a>、Amazon Elastic Kubernetes服务(<a href="https://azure.microsoft.com/en-us/overview/kubernetes-on-azure/" target="_blank">【EKS】</a>)和Google Kubernetes引擎(<a href="https://cloud.google.com/kubernetes-engine" target="_blank">【GKE】</a>在过去几年中得到了大幅增长和采用。</p><p>当组织设计分布式系统时，不要把所有的鸡蛋放在一个篮子里是一个设计考虑。利用多个公共云供应商是一种流行的方法。与非常具体的云服务不同，Kubernetes确实超越了公共云供应商；您在一个集群上的工作负载应该能够在另一个集群上工作。随着基础架构复杂性的增加，您的部署复杂性也会增加。在这个例子中，学习如何轻松地跨多个Kubernetes提供者进行部署。</p><p>像往常一样，关注博客和/或观看视频。</p><h2>设置您的实例</h2><p>为了利用这个例子，我们需要在三个公共云供应商中创建Kubernetes集群。对我自己来说，我对AWS最熟悉，在我以前的角色中使用AWS最多。在Azure和GCP旋转资源对我来说是第一次。如果你还没有的话，第一步就是在AWS 、<a href="https://portal.azure.com/#home" target="_blank"> Azure </a>和<a href="https://cloud.google.com/cloud-console" target="_blank"> GCP </a>中设置账户。</p><figure class="w-richtext-figure-type- "/><h2>亚马逊EKS供应</h2><p>我最喜欢的供应EKS集群的工具是<a href="https://eksctl.io/" target="_blank"> EKSCTL </a>。如果你使用的是Mac，安装EKSCTL最简单的方法就是利用<a href="https://formulae.brew.sh/formula/eksctl" target="_blank">自制软件</a>。运行以下命令将启动EKS集群。</p><p>#Create EKS集群eksctl Create cluster \-name captain-canary-eks \-version 1.18 \-region us-east-2 \-node group-name standard-workers \-node-type T3 . xlarge \-nodes 2 \-nodes-min 1 \-nodes-max 3 \-node-ami auto</p><p>配置完成后，运行kubectl get nodes来验证连接性和集群状态。</p><p>没有了EKS，让我们转向AKS。</p><h2>Azure AKS供应</h2><p>前往Azure门户网站并登录。可以导航到+创建资源，然后Kubernetes服务。<a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough-portal" target="_blank">微软文档</a>有一个很棒的入门指南，可以让你的第一个AKS集群启动并运行。</p><figure class="w-richtext-figure-type- "/><p>通过配置向导运行后，您的AKS集群就启动并运行了。</p><figure class="w-richtext-figure-type- "/><p>为了完善这三家公共云供应商，最后可以构建一个GKE集群。</p><h2>谷歌GKE供应</h2><p>在你的浏览器上多一个标签，进入<a href="https://console.cloud.google.com/" target="_blank">谷歌云控制台</a>，然后登录。导航到Kubernetes引擎，然后+创建集群。如果这是你的第一个GKE集群，<a href="https://cloud.google.com/kubernetes-engine/docs/quickstart" target="_blank">谷歌文档</a>有一个很棒的入门指南。</p><figure class="w-richtext-figure-type- "/><p>配置完成后，您的GKE集群就可以正常运行了。</p><figure class="w-richtext-figure-type- "/><p>随着集群的出现，下一步是开始利用强大的功能。</p><h2>线束准备</h2><p>让我们给海因斯打个电报，让他代表我们行事。我们将利用<a href="https://docs.harness.io/article/igftn7rrtg-delegate-installation-overview" target="_blank">管理代表</a>，例如管理部署在每个集群内部的工作节点。一个好的分布式系统设计考虑是利用不同的云提供商的代表来实现可用性。根据每个云提供商的要求，通过管理资源交互的IAM/服务主体/云IAM角色，可以将一个Harness委托部署到其他Kubernetes集群。</p><figure class="w-richtext-figure-type- "/><p>首先，导航至<a href="https://app.harness.io/" target="_blank">线束网络用户界面</a>并登录。如果你没有马具账号，你可以<a href="https://harness.io/try-continuous-delivery-as-a-service-for-free/" target="_blank">免费注册一个</a>。</p><h2>线束委托安装</h2><p>我们将依次在EKS、阿克苏和GKE安装线束代理，因为我的机器是通过CLI连接到EKS的，而不是阿克苏或GKE。不过，如果您已经为其他云提供商之一连接了CLI，那么您可以按照任何顺序安装Harness委托。以下说明显示了如何从每个云提供商重新注入<a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank"> kubeconfig </a>，这样您就可以在本地机器上使用终端。</p><h2>EKS代表装置</h2><p>安装线束代理非常简单，导航到设置，然后安装代理。选择Kubernetes YAML，并可以为该代表命名，如“eks-delegate”。</p><figure class="w-richtext-figure-type- "/><p>下载完成后，展开tar.gz。</p><figure class="w-richtext-figure-type- "/><p>在展开的文件夹中，有一个readme文件，其中包含安装Harness Delegate的命令，该文件是ku bectl apply-f Harness-Delegate . YAML。</p><p>如果您首先安装了另一个云提供商CLI，您可以随时重新注入EKS集群kube config by AWS eks-region your-region update-kube config-name cluster-name，例如AWS eks-region us-east-2 update-kube config-name captain-canary-eks。</p><figure class="w-richtext-figure-type- "/><p>过了一会儿，Harness委托将被连接到Harness中，并可以在UI中进行验证。</p><figure class="w-richtext-figure-type- "/><p>随着第一个利用委托的方式，我们可以重复一个类似的过程为AK和GKE。</p><h2>AKS委托安装</h2><p>我们需要kubectl访问AKS集群。最简单的方法是让Azure CLI注入kubeconfig上下文。如果您尚未安装，请安装Azure CLI。</p><p>注入kubeconfig的命令是:</p><p>az aks get-credentials-resource-group my resource group-name myaks cluster # Azure命令brew update &amp; &amp; brew install Azure-cliaz loginaz aks get-credentials-resource-group ravi group-name captain-canary-Azure kubectl get节点</p><figure class="w-richtext-figure-type- "/><p>一旦kubectl连接好，就可以从Setup -&gt; Install Delegate返回并重新下载一个线束代理。选择Kubernetes YAML，并可以给出一个名称“aks-delegate”。</p><figure class="w-richtext-figure-type- "/><p>使用ku bectl apply-f harness-delegate . YAML .<em/>展开tar.gz并安装到您的AKS集群中</p><figure class="w-richtext-figure-type- "/><p>稍后验证现在有两个线束代理存在。</p><figure class="w-richtext-figure-type- "/><p>下一步是对GKE集群执行类似的流程。</p><h2>GKE代表装置</h2><p>按照EKS和AKS的类似流程，让Google Cloud CLI注入kubeconfig将是启动和运行kubectl访问的最简单方法。如果你还没有安装Google Cloud CLI，最简单的方法就是<a href="https://formulae.brew.sh/cask/google-cloud-sdk" target="_blank">使用自制</a>。如果在我写这篇博客的时候你有一个IPV6 ISP，你可能需要在谷歌云SDK安装期间<a href="https://stackoverflow.com/questions/44087310/google-cloud-sdk-install-on-os-x-gcloud-components-list-failed-to-fetch-compo" target="_blank">禁用IPV6 </a>。</p><p>Google Cloud给你gcloud CLI <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl#using-gcloud-init" target="_blank">命令来执行</a>来更新UI中的kubeconfig。可以导航到谷歌云控制台，点击GKE集群上的“连接”来执行命令。</p><figure class="w-richtext-figure-type- "/><p>谷歌云命令注入kubeconfig:</p><p>g cloud container clusters get-credentials cluster-name-zone your-zone-project your-project # GCP命令networksetup -setv6off Wi-Fibrew木桶安装Google-cloud-SDK _ PYTHON = " $(brew-prefix)/opt/PYTHON @ 3.8/lib exec/bin/PYTHON " source " $(brew-prefix)/cas kroom/Google-cloud-SDK/latest/Google-cloud-SDK/path . bash . Inc " source " $(brew-prefix)/cas kroom/Google-cloud-SDK/PYTHON</p><figure class="w-richtext-figure-type- "/><p>一旦kubectl连接好，返回并从Setup -&gt; Install Delegate重新下载一个线束代理。选择Kubernetes YAML，并可以给出一个名称“gke-delegate”。</p><figure class="w-richtext-figure-type- "/><p>使用<em>ku bectl apply-f harness-delegate . YAML .</em>扩展tar.gz并安装到您的GKE集群中</p><figure class="w-richtext-figure-type- "/><p>安装最后一个线束委托后，您可以验证所有三个委托都在线束UI中。</p><figure class="w-richtext-figure-type- "/><p>困难的事情解决了之后，是时候添加要部署的Kubernetes集群，并创建一个要部署到所有三个集群的集群工作流了。</p><h2>线束Kubernetes布线</h2><p>Harness有一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts" target="_blank"> CD抽象模型</a>的概念，其中资源和步骤被抽象掉。Kubernetes集群属于<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#cloud_providers" target="_blank">云提供商</a>抽象范畴，需要建立三个云提供商，每个集群一个。由于Harness Kubernetes代理可以从它们被部署到的地方继承细节，因此将Kubernetes集群连接到Harness很容易。</p><p>导航至设置-&gt;云提供商+添加云提供商。选择Kubernetes作为类型。对于EKS群集，可以显示名称为“eks-cluster ”,并且可以从“eks-delegate”继承详细信息。</p><figure class="w-richtext-figure-type- "/><p>单击测试进行验证，然后单击下一步提交。</p><p>添加后，EKS集群将显示在列表中。</p><figure class="w-richtext-figure-type- "/><p>AKS和GKE集群也有类似的流程。</p><p>添加AKS集群:</p><figure class="w-richtext-figure-type- "/><p>添加GKE集群:</p><figure class="w-richtext-figure-type- "/><p>添加两者后，AKS和GKE集群都将作为云提供商提供服务。</p><figure class="w-richtext-figure-type- "/><p>Kubernetes连接完成后，最后，我们需要创建一个工作流来部署所有的优点。</p><h2>驾驭工作流程</h2><p>如果您熟悉Harness，那么任何部署的命脉都是一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#applications" target="_blank"> Harness应用程序</a>，它包含了您的部署所需的所有抽象。创建应用程序，可以导航到设置+添加应用程序。可以给出“大库伯内特”这个名字。</p><figure class="w-richtext-figure-type- "/><p>接下来，我们将所有三个Kubernetes环境与一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#environments" target="_blank">线束环境</a>连接在一起。</p><p>设置-&gt;大Kubernetes -&gt;环境+添加环境。给它起名叫“杂交库伯内特”。</p><figure class="w-richtext-figure-type- "/><p>接下来，我们可以添加<a href="https://docs.harness.io/article/v3l3wqovbe-infrastructure-definitions" target="_blank">基础设施定义</a>，每个集群一个。要设置EKS，可以将云提供商的名称“EKS”命名为“Kubernetes集群”，部署类型为“Kubernetes”。确保将云提供商与在上述步骤中连接的“eks-cluster”相匹配。</p><figure class="w-richtext-figure-type- "/><p>冲洗并重复AKS和GKE集群。</p><figure class="w-richtext-figure-type- "/><p>下一步是定义<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#services" target="_blank">线束服务</a>，例如您将要部署什么。您可以通过进入设置- &gt; Grand Kubernetes - &gt;服务+添加服务来创建服务。让我们用部署类型“Kubernetes”来部署Nginx。</p><figure class="w-richtext-figure-type- "/><p>创建好服务后，在Nginx图像的位置进行连接。公共码头枢纽工程良好。</p><figure class="w-richtext-figure-type- "/><p>点击+Add Artifact Source，利用默认的源服务器[Harness Docker Hub]和“library/nginx”作为镜像。</p><figure class="w-richtext-figure-type- "/><p>单击submit后，Nginx就可以部署了。</p><figure class="w-richtext-figure-type- "/><p>接下来，我们将创建三个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#workflows" target="_blank">利用工作流</a>或步骤，每个步骤对应一个Kubernetes环境。</p><p>设置-&gt;大Kubernetes -&gt;工作流+添加工作流。将工作流命名为“部署EKS”，工作流类型为“滚动”，环境为“混合Kubernetes”，服务为“Nginx”，基础架构定义为“EKS”。</p><figure class="w-richtext-figure-type- "/><p>点击提交后，工作流将被保存。让我们冲洗一下，并为AKS和GKE集群重复一遍。</p><figure class="w-richtext-figure-type- "/><p>导航回设置-&gt;大Kubernetes -&gt;工作流程，并添加另外两个工作流程。</p><p>AKS工作流程:</p><figure class="w-richtext-figure-type- "/><p>GKE工作流程:</p><figure class="w-richtext-figure-type- "/><p>点击提交后，您应该会看到所有三个工作流。</p><figure class="w-richtext-figure-type- "/><p>为了将这些工作流缝合在一起，我们可以创建一个<a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts#pipelines" target="_blank">线束管道</a>来顺序执行这些工作流；线束管道有几个执行模型，但为了简单起见，我们将利用顺序模型。</p><p>设置-&gt; Grande Kubernetes -&gt;管道+添加管道</p><figure class="w-richtext-figure-type- "/><p>我们可以为每个Kubernetes环境/提供商添加一个管道阶段，以展示管道的威力。点击“添加管道阶段”。</p><figure class="w-richtext-figure-type- "/><p>定义一个步骤名为“EKS”的执行步骤[取消选中自动生成名称]，并将执行工作流设置为“部署EKS”。</p><figure class="w-richtext-figure-type- "/><p>点击提交后，对AK和GKE重复这个过程。</p><figure class="w-richtext-figure-type- "/><p>AK:</p><figure class="w-richtext-figure-type- "/><p>GKE:</p><figure class="w-richtext-figure-type- "/><p>有了Kubernetes提供者，您应该有一个三级管道。</p><figure class="w-richtext-figure-type- "/><p>现在您已经准备好跨三个Kubernetes提供商进行部署了！</p><h2>观看魔术</h2><p>有几个地方可以开始部署，例如直接从您创建的管道开始。虽然可以在左侧导航到持续部署-&gt;部署-&gt;开始新部署。选择管道，然后选择刚刚创建的应用程序和管道。选择一个Nginx标签[版本]。</p><figure class="w-richtext-figure-type- "/><p>点击提交并观看魔术！</p><figure class="w-richtext-figure-type- "/><p>就这样，您成功地部署了三个主要公共供应商的Kubernetes平台。</p><h2>带着马具继续旅程</h2><p>在EKS、阿拉斯加和GKE部署可能是一个老生常谈的例子。Harness平台功能强大且易于使用，可帮助您和您的组织实现云现代化目标。欢迎<a href="https://app.harness.io/auth/#/signup" target="_blank">今天就报名参加线束平台</a>。</p><p>干杯！</p><p>拉维</p></div></div>    
</body>
</html>