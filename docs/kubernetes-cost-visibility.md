# Kubernetes 成本管理策略:成本可见性|利用

> 原文：<https://www.harness.io/blog/kubernetes-cost-visibility>

让我们深入探讨一下如何在任何规模下实现任何粒度级别的成本可见性。这些策略并不相互排斥，事实上，每种策略都提供了一个越来越完整的成本图。

有了成本可见性，您希望能够合理地将成本归因于其来源。根据业务环境的不同，这可能会降低到开发人员、项目、应用程序、服务、业务单元或对您的组织的需求有意义的任何东西的级别。在 Kubernetes 中，我们通过查看集群、节点、名称空间、工作负载和 pod 来实现这一点。

获得可见性的最基本的方法是使用 Kubernetes API 来查看我们如何分配资源，然后将它们连接到 Prometheus 这样的工具，以查看哪些资源被积极利用，哪些资源未被分配或闲置。这可以作为一个开始，但很难扩展，这就是为什么你想使用一个更全面的方法。

让我们深入探讨一下如何在任何规模下实现任何粒度级别的成本可见性。这些策略并不相互排斥，事实上，每种策略都提供了一个越来越完整的成本图。

*这篇文章摘自我们的电子书《Kubernetes 的成本管理策略》。如果你喜欢你看到的内容，坚持到最后，我们会为你链接完整的电子书。它是免费的——最棒的是，没有栅门。*

## 您将看到的示例

有了成本可见性，您将能够确定成本的贡献者。就造成 Kubernetes 浪费性消费的因素而言，您可以发现:

*   即使启用了集群自动缩放，集群大小也比需要的大
*   群集内造成资源利用不足的未分配资源
*   机架密度低，表示资源已分配给群集或节点，但未被任何机架或工作负载使用
*   请求与 CPU 和内存资源的实际使用不匹配，导致过度调配单元或单元限制
*   跨资源的共享存储可能未得到充分利用，或者存储未分配给任何 pod，最终成为您仍在付费的未分配存储卷

## 策略一:标记和标签管理

标签是内置于任何云资源中的一项固有功能，在 Kubernetes 中被称为标签。它们允许您使用键-值样式为任何资源分配标识符或标签，以便您以后可以基于键-值对的组合找到它。它的伟大之处在于，它为您创建任何类型的标识方案提供了充分的灵活性，并且您可以手动或在代码中标记资源，这使得围绕资源标识创建良好的治理变得简单。

有了一组强大的标签和良好的标签管理策略，就有可能将成本可见性和所有权分割到任何需要的人的相关上下文中。在一个理想的世界里，你应该有每个人需要的每个资源的所有标签，以任何对他们最有意义的方式来查看成本。

然而，由于将管理标签作为一项核心功能的手动性质，扩大规模会变得相当困难。标签管理是很难做到的，所以在这里有帮助的工具是有价值的。您可能希望在强大的标签管理工具中找到以下内容:

*   能够实施基于 OPA 的治理规则
*   可以发现不合规资源的报告(例如，显示没有“团队”标签的资源的百分比)
*   通过自动标记帮助实现标记合规性(例如，将标记添加为 CI/CD 管道的一部分，使您能够回答诸如“频繁部署会影响成本效益吗？”)

有一些工具可以使自动标记变得更容易，如果你使用这些工具，你会希望在任何标记工作中确保你的架构得到全面的覆盖。如果您没有可视化工具、控制面板或其他方法来整理标签信息以进行按存储容量使用计费、按存储容量使用显示或财务报告，您还需要考虑如何进行报告。

### 风险

使用标记管理作为基础设施的主要可见性机制在很大程度上依赖于团队使用资源来适当地标记它们。您必须确保有适当的指导方针或治理来保证所有资源都被适当地标记；如果资源没有被标记，你的整个可见性游戏计划可能会土崩瓦解。

除了确保没有未标记的资源，您还需要考虑还有未标记的资源。共享资源就是这样的例子。如果您尝试对共享资源进行按存储容量使用计费或按存储容量使用显示，您如何在资源的多个使用者之间分配成本？

### 最有用的时候

标签管理对两种组织非常有用:

1.  没有复杂报告需求、不担心优化成本或没有大型基础架构的小型组织
2.  能够创建和实施强大的标签治理策略，并能够利用标签数据来满足报告需求的组织

通常，能够有效利用标记管理策略的组织是早期的 SMB 和企业，在组织的其他部分已经有了复杂的财务控制和治理。

## 策略二:组织映射

*Organizational mapping can be a mess.*

如果按存储容量使用计费和按存储容量使用显示是最重要的事情，那么您需要将每项资源映射回您组织中使用它的部门，无论是按业务部门、产品、应用程序、微服务、集群还是工作负载。

我们在 Harness 反复看到，这是大规模组织的目标。这种信息可以洞察关键的业务问题，例如:

*   “一个客户要花我们多少钱？”
*   "我对我的 SaaS 产品收费正确吗？"
*   "我可以跨产品或团队标准化我的成本吗？"

在实践中，做到这一点是出了名的困难。随着规模的扩大，您可能希望实施这一策略，因此提前考虑如何实施是值得的。例如，如果您正在使用标签管理，您将需要确保您的标签卫生非常好，并且构建为支持这种分配。

### 风险

这种策略的最大风险在于实施。成功的组织映射需要组织所有级别的业务环境，以及理解和获得 Kubernetes 任何粒度成本透明度的强大能力。此外，您需要能够将每个 Kubernetes 集群、节点、名称空间和工作负载映射到您正在查看的业务上下文。这可能需要大量投资来维护这种映射，即使是在公司重组或基础设施变更事件等情况下。

### 最有用的时候

组织映射对于以下组织最为有用:

*   需要跨各种不同的使用情形或业务环境进行准确的按存储容量使用计费和显示
*   想要使用成本分配数据作为核心指标来通知和加速业务决策
*   拥有他们需要有条不紊地执行以确保法规遵从性的治理需求

通常，我们 Harness 发现，能够最有效地利用这一战略的组织类型是中端市场公司和企业，它们都希望了解与业务目标更密切相关的云成本。

## 策略三:部署相关性

部署关联是将成本映射到生产、开发、测试、试运行或 qa 的单个工程部署的实践。了解了哪些云资源与部署相关联后，组织可以开始回答一些问题，例如:

*   "我能得到成本意外变化的根本成本分析吗？"
*   "我能把利润/损失归因于一个单独的特征变化吗？"
*   “在我们的部署战略中，我能提高效率吗？”
*   “部署频率和我们的云成本之间有什么关联？”

我们在 Harness 发现，这种策略正在成为云成本可见性的一种新方法，包括对 Kubernetes 的可见性。组织现在希望了解功能变化对其成本的影响，甚至更精确地了解云支出中涉及的不同变量。例如，组织希望了解他们的云成本何时发生意外变化，何时开始，以及哪个代码部署引入了该问题。这使他们能够快速筛选潜在的成本雪球，并补救具体的部署。

当然，将 Kubernetes 的成本归因于部署需要对持续交付渠道以及 Kubernetes 资源如何在每个部署中分配有深入的了解。如果管理 CI/CD 渠道还不够，现在您必须将其与您的成本可见性战略相结合！然而，在流程的末尾，您可以全面了解成本的各个方面，这确实非常有用。

Harness 认识到了这种方法的价值。作为一个软件交付平台，Harness 可以绑定到您的 CI/CD 管道中，并提取这些信息，让您了解部署如何影响 Kubernetes 工作负载所产生的成本，包括显示为影响成本变化而进行的确切更改。

### 风险

这种策略的主要风险是实施所需的时间和精力。参与的程度不仅仅限于您的成本管理战略，还延伸到您的持续交付渠道，这可不是一个小壮举。虽然回报可能很大，但构建和维护这样一个解决方案的成本可能是一个阻碍。虽然许多工具都难以解决这一问题，但有一些工具可以帮助您将 CI/CD 与云成本关联起来。

### 最有用的时候

发现部署相关性更有用的组织是那些:

*   希望将工程和基础设施的变化与成本的变化联系起来，包括异常的成本峰值
*   使用成本作为基准指标来推动业务的边际改进
*   目标是提高工程团队的成本效率

在 Harness，我们发现不一定有一组精选的组织能够最好地利用部署关联策略。更确切地说，驱动因素要么是进一步改进成本管理的愿望，要么是进一步细化软件交付过程的愿望。虽然这通常是组织在扩展时要处理的事情，但即使是较小的组织也发现在早期创建可扩展的过程是有价值的。

## 结论

这三种成本可见性策略都提供了一层信息，有助于最终了解您的成本。无论你是单独使用其中的一个，还是同时使用多个，任何成本优化练习的第一步都是看看钱花到哪里去了。即使对于你的个人预算来说，如果你不知道你要把钱花在哪里，你能决定把钱花在哪里(或者不花)吗？获得成本可见性的有效方法有多种[。无论你选择什么，最重要的是在实施任何事情之前了解你需要什么。](https://harness.io/blog/continuous-efficiency/cloud-cost-management-methods/)

接下来的几篇博文将讨论另外两个策略:成本节约和成本预测。然而，如果你不想等帖子，你可以现在就下载完整的电子书。这是免费的，不需要电子邮件地址！立即下载 Kubernetes 电子书的[成本管理策略。](https://harness.io/learn/ebooks/ebook-cost-management-kubernetes/)